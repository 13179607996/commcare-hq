{% load i18n %}
{% load xform_tags %}
{% load i18n %}
{% load timezone_tags %}
{% load case_tags %}

<style type="text/css">
    .hq-generic-report {
        padding: 10px;
    
    }

    .case-properties-table {
        position: relative;
        width: auto;
        margin: 0;
        table-layout: fixed;
    }

    .case-properties-table th, td {
        word-wrap: break-word;
        word-break: break-all;
    }

    .case-properties-table th:not(:first-child), .case-properties-table td {
        border-left: 0;
    }

    .case-properties-table th:nth-child(odd) {
        text-align: right;
        width: 80px;
    }

    .case-properties-table td:nth-child(even) {
        width: 160px;
    
    }

    .table-container {
        float: left;
        margin-bottom: 18px;
        margin-right: 18px;
    
    }

    /* partially lifted from bootstrap docs */
    .table-tab {
        top: -26px;
        left: 0px;
        display: inline-block;
        width: auto;
        padding: 3px 7px;
        font-size: 12px;
        font-weight: bold;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px 4px 0 0;
    }


</style>

<h2>{% trans "Case Details" %}</h2>

<div id="report-content">
<div id="tabbed-content-container" class="row-fluid">
    <ul class="nav nav-tabs">
        <li class="active"><a href="#case-details" data-toggle="tab">{% trans "Case Details" %}</a></li>
        <li><a href="#case-referrals" data-toggle="tab">{% trans "Referrals" %}</a></li>
        <li><a href="#case-related" data-toggle="tab">{% trans "Related Cases" %}</a></li>
        <li><a href="#case-attachments" data-toggle="tab">{% trans "Attachments" %}</a></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane active" id="case-details">
            <div class="row-fluid">
                {% for section_name, rows in default_properties %}
                {% render_table section_name rows %}
                {% endfor %}
                <div class="clearfix"></div>
                {% render_table "Other Properties" dynamic_properties %}
            </div>
            
            <table class="table table-striped case_details table-hover">
                <thead>
                <tr>
                    <th>Property</th>
                    <th>Value</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>forms</td>
                    <td>
                        {#    {% for form_id in case.xform_ids %}#}
                        {#        <p class="xform_ref" data-formid="{{ form_id }}">{% form_inline_display form_id %}</p>#}
                        {#        {% if not forloop.first %}<br>{% endif %}#}
                        {#    {% endfor %}#}
                    </td>

                </tr>
                <tr>
                    <td>Attachments</td>
                    <td>
                        {% for form_id, filename in case.attachments %}
                            {% if not forloop.first %}<br>{% endif %}
                            <a href="{% url xform_attachment form_id filename %}">{{ filename }}</a>
                        {% empty %}
                            <h6>No Attachments</h6>
                        {% endfor %}
                    </td>
                </tr>

                </tbody>
            </table>
        </div>

        <div class="tab-pane" id="case-referrals">

            <h2>Referrals</h2>
            <table class="table table-striped case_history">
                <thead>
                <tr>
                    <th>Date Opened</th>
                    <th>Type</th>
                    <th>Date Modified</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {% for referral in case.referrals %}
                    <tr>
                        <td>{% utc_to_timezone referral.opened_on timezone %}</td>
                        <td>{{ referral.type }}</td>
                        <td>{% utc_to_timezone referral.modified_on timezone %}</td>
                        <td>{{ referral.closed|yesno:"closed,open" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="no_data">No referrals</td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>

        <div class="tab-pane" id="case-related">

            <h2>Related Cases</h2>
            <table class="table table-striped case_history">
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Relation</th>
                    <th>Type</th>
                    <th>Date Opened</th>
                    <th>Date Modified</th>
                    <th>Status</th>
                </tr>
                </thead>
                <tbody>
                {% for case_index in case.all_indices %}
                    <tr>
                        <td class="case_ref"
                            data-caseid="{{ case_index.referenced_id }}">{{ case_index.referenced_case.name }}</td>
                        <td>{{ case.name }}'s {{ case_index.is_reverse|yesno:"Child, Parent" }}</td>
                        <td><code>{{ case_index.referenced_case.type }}</code></td>
                        <td>{{ case_index.referenced_case.opened_on }}</td>
                        <td>{{ case_index.referenced_case.modified_on }}</td>
                        <td>{{ case_index.referenced_case.closed|yesno:"closed,open" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="no_data">No related cases</td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>


        </div>
        <div class="tab-pane" id="case-attachments">
            <h2>todo</h2>
        </div>
    </div>
</div> {# end tabbed-content-container div #}
<div id="xform-list-block" class="row-fluid">
<h2>Sexy histogram of all xform submits over time</h2>
<hr>
<h2>Sexy dot chart of all case updates over time</h2>
<hr>
    <div class="span4">
    <h2>Interaction History</h2>
        <ul data-bind="foreach: $root.form_type_facets">
            <li>
                <strong><span data-bind="text: form_name"></span></strong>:
                <span data-bind="text: form_count"></span>
            </li>
        </ul>

        <span data-bind="text: 'Total records: ' + $root.total_rows()"></span>
        <span data-bind="text: '<<', click: $root.prevPage, visible: $root.page_index() > 0"></span>
        <span data-bind="text: 'Page ' + ($root.page_index() + 1) + ' of ' + $root.page_count()"></span>
        <span data-bind="text: '>>', click: $root.nextPage, visible: $root.page_index() < $root.page_count()"></span>
        <table class="table table-bordered table-striped">
            <thead>
            <tr>
                <th class="span1">Date</th>
                <th class="span1">Form</th>
                <th class="span1">Username</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: xforms">
                <tr data-bind='click: $root.clickRow, css: { info: $root.row_highlight }'>
                    <td>
                        <span data-bind="text: received_on"></span>
                    <td>
                        <span data-bind="text: form_type"></span><br>
                    </td>

                    <td>
                        <span data-bind="text: username"></span><br>
                    </td>
                </tr>
            </tbody>
        </table>


    </div>
    <div class="span6">
        <h2>Xform goes here</h2>
        <div data-bind="visible: $root.xform_view, template: { name: 'xform-template', foreach: $root.selected_xforms }">
{#            #<div data-bind="template: { name: 'person-template', foreach: people }"></div>#}


        </div>
    </div>
    <script type="text/html" id="xform-template">
        <h2>Hello XForm</h2>
        <h3 data-bind="text: name"></h3>
        <span data-bind="text: 'XForm ID:' + id()"></span><br>
        <span data-bind="text: 'User:' + username()"></span><br>
        <span data-bind="text: 'user_id:' + userID()"></span><br>
        <span data-bind="text: 'form type:' + form_type()"></span><br>
        <span data-bind="text: 'xmlns:' + xmlns()"></span><br>
        <span data-bind="text: 'received_on:' + received_on()"></span><br>
        <span data-bind="text: 'timestart:' + timeStart()"></span><br>
        <span data-bind="text: 'timeend:' + timeEnd()"></span><br>
        <span data-bind="text: 'case_id:' + case_id()"></span><br>
        <span data-bind="text: 'device_id:' + deviceID()"></span><br>
        <div class="form-data-block" data-bind="html: 'form_data:' + get_form_data()"></div>
    </script>


    <script type="text/javascript">

    function format_date(isodatestring) {
        if (isodatestring == "" || isodatestring == null) {
            return 'present';
        }
        //parse nad format the date timestamps - seconds since epoch into date object
        var date = new Date(isodatestring.split('+')[0]);
        // hours part from the timestamp
        var hours = date.getHours();
        // minutes part from the timestamp
        var minutes = date.getMinutes();
        // seconds part from the timestamp
        var seconds = date.getSeconds();
        if (seconds < 10) {
            var second_str = "0" + seconds;
        } else {
            var second_str = seconds;
        }

        var year = date.getFullYear();
        var month = date.getMonth() + 1;
        var day = date.getDate();

        //return  year + '/' + month + '/' + day + ' ' + hours + ':' + minutes + ':' + second_str;
        //return  year + '/' + month + '/' + day;
        return  year + '-' + month + '-' + day + ' ' + hours + ":" + minutes;

    }

    function format_user(username) {
        if (username === undefined || username == null) {
            return "---"
        }
        else {
            return username.split('@')[0];
        }
    }
    function recursiveRender(obj) {
        var ret = "";
        for (var k in obj) {
            if (typeof obj[k] == "object") {
                ret = ret + "<dl class='dl-horizontal'>" + recursiveRender(obj[k]) + "</dl>";
            }
            else {
                ret = ret + "<dt>" + k.toString() + "</dt><dd>" + obj[k].toString() + "</dd>";
            }
        }
        ret = ret + "</dl>";
        return ret;
    }


    function XFormDataModel(data) {
            var self = this;
            self.id = ko.observable(data['_id']);
            self.case_id = ko.observable(data.case_id); //helper populated
            self.xmlns = ko.observable(data.xmlns);
            self.domain = ko.observable(data.domain);
            self.app_id = ko.observable(data.app_id);
            self.received_on = ko.observable(format_date(data.received_on));

            self.timeStart = ko.observable(format_date(data.form.meta.timeStart));
            self.timeEnd = ko.observable(format_date(data.form.meta.timeEnd));
            self.userID = ko.observable(data.form.meta.userID);
            self.username = ko.observable(format_user(data.form.meta.username));
            self.deviceID = ko.observable(data.form.meta.deviceID);
            self.form_type = ko.observable(data.form['#type']);
            self.form_data = ko.observable(data.form);

            self.get_form_data = function() {
                return "<dl class='dl-horizontal'>" + JSON.stringify(self.form_data(), function(key,value) {
                    console.log(typeof(value));
                    if (typeof(value) == "object") {
                        return "<dt>" + key.toString() + "</dt><dd>" + recursiveRender(value) + "</dd>";
                    } else {
                        return "<dt>" + key.toString() + "</dt><dd>" + value.toString() + "</dd>";
                    }
                }) + "</dl>";
            };
    };

        function FormTypeFacetModel(data) {
            var self = this;
            //{"form_type_facets": {"_type": "terms", "total": 854, "terms": [{"count": 605, "term": "dots_form"}, {"count": 168, "term": "data"}, {"count": 75, "term": "progress_note"}, {"count": 6, "term": "bloodwork"}], "other": 0, "missing": 0},
            self.form_name = ko.observable(data.term);
            self.form_count = ko.observable(data.count);
        };

        function FormDateHistogram(data) {
            var self = this;
            self.es_time = ko.observable(data.time);
            self.form_count = ko.observable(data.count);
        };

        function XFormListViewModel() {
            var self = this;
            self.xforms = ko.observableArray([]);
            self.page_size = ko.observable(25);
            self.page_index = ko.observable(0);
            self.total_rows = ko.observable(0);
            self.page_count = ko.observable(0);
            self.selected_xform_idx = ko.observable(-1);
            self.selected_xform_doc_id = ko.observable("");
            self.selected_xforms = ko.observableArray([]);

            self.form_type_facets = ko.observableArray([]);
            self.form_recv_facets = ko.observableArray([]);

            var api_url = "/a/pact/api/v0.1/xform_es/";

            //based upon criteria, get totals + facets?
            //then populate observableArray and set pagination limits

            self.xform_query = function () {
                return {
                    "query": {
                        "filtered": {
                            "filter": {
                                "and": [
                                    {"term": {"domain.exact": "{{ domain }}"}},
                                    {"term": {"doc_type": "xforminstance"}},
                                ]
                            },
                            "query": {
                                "query_string": {
                                    "query": "(form.case.case_id:{{ case.get_id }} OR form.case.@case_id:{{ case.get_id }})"
                                }
                            }
                        }
                    },
                    "size": self.page_size(),
                    "from": self.page_index() * self.page_size()
                };
            };

            self.stats_query = function () {
                var q = self.xform_query();
                q["facets"] = {
                    "received_facets": {
                        "date_histogram": {
                            "field": "received_on",
                            "interval": "day"
                        }
                    }, "form_type_facets": {
                        "terms": {
                            "field": "form.#type"
                        }
                    }
                }
                q['size'] = 0;
                q['from'] = 0;
                return q;
            };


            self.get_data = function(query, success_cb) {
                console.log(query);
                $.ajax({
                    "type": "POST",
                    "url":  api_url,
                    "data": ko.toJSON(query),
                    "success": function(data) {
                        success_cb(data);
                    }, //end success
                    "error": function(data) {
                        console.log("Error:");
                        console.log(data);
                    },
                    "complete": function(data){
                        {#                        self.is_loading(false);#}
                    }
                });
            };


            self.xform_data_cb = function(data) {
                self.total_rows(data['hits']['total']);
                self.page_count(Math.floor(data['hits']['total']/self.page_size()));
                var mapped_xforms = $.map(data['hits']['hits'], function (item) {
                    return new XFormDataModel(item['_source']);
                });
                self.xforms(mapped_xforms);
                self.selected_xform_idx(-1);
            };

            self.stats_data_cb = function(data) {
                //eww, doing this on every pagination, make this separate operations
                var term_facets_mapped = $.map(data['facets']['form_type_facets']['terms'], function (item) {
                    return new FormTypeFacetModel(item);
                });
                self.form_type_facets(term_facets_mapped);
                var recv_facets_mapped = $.map(data['facets']['received_facets']['terms'], function (item) {
                    return new FormDateHistogram(item);
                });
                self.form_recv_facets(recv_facets_mapped);
            };


            self.get_data(self.stats_query(), self.stats_data_cb);
            self.get_data(self.xform_query(), self.xform_data_cb);

            self.nextPage = function() {
                self.page_index(self.page_index() + 1);
                self.get_data(self.xform_query(), self.xform_data_cb);
            };

            self.prevPage = function() {
                self.page_index(self.page_index() - 1);
                self.get_data(self.xform_query(), self.xform_data_cb);
            };

            self.clickRow = function(item) {
                var idx = self.xforms().indexOf(item);
                console.log("clickrow");
                console.log(idx);
                console.log(self.xforms()[idx].id());
                self.selected_xform_idx(idx);
                self.selected_xform_doc_id(self.xforms()[idx].id());
                if (idx > -1) {
                    self.selected_xforms([]);
                    self.selected_xforms.push(self.xforms()[self.selected_xform_idx()]);
                }
            };

            self.xform_view = ko.computed(function () {
                return self.selected_xform_doc_id() !== undefined;
            });

            self.row_highlight = ko.computed(function() {
                //hitting next page will not disappear the xform display just remove the highlight
                if (self.selected_xform_idx() == -1) {
                    console.log("row_highlight false");
                    return false;
                } else  {
                    if (self.selected_xforms[0] !== undefined) {
                        console.log("row_highlight something");
                        console.log(self.selected_xform_doc_id() === self.selected_xforms()[0].id());
                        return self.selected_xform_doc_id() === self.selected_xforms()[0].id();
                    } else {
                        console.log("row_highlight true");
                        return false;
                    }
                }
            });

            self.sortByName = function() {
                self.xforms.sort(function(a, b) {
                    return a.name < b.name ? -1 : 1;
                });
            };
        };

        ko.applyBindings(new XFormListViewModel(), $("#xform-list-block")[0]);
    </script>

</div>
