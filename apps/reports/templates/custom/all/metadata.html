{% load hq_shared_tags %}
{% load i18n %}
<script type="text/javascript"> 
    function show_message_box(reporter_id) { 
        $('#reporter_id')[0].value = reporter_id;
        $.blockUI({ message: $('#message_popup') });
    }
    
    function clear_message_input() {
        $('#message')[0].value='';
    }
    
    $(document).ready(function() { 
        $('#test').click(function() { 
            show_message_box();
        });
        
        $('#send').click(function() {
            
            var done = function(status) {
                alert('message ' + status);
                $.unblockUI();
                clear_message_input();
            };
            reporter_id = $('#reporter_id')[0].value;
            msg_area = $('#message');
            message = msg_area[0].value;
            
            send_xhr = $.ajax({
                        "type": "POST",
                        "url":  "/ajax/messaging/send_message",
                        "data": {
                            "uid":  reporter_id,
                            "text": message,
                        },
                        "success": function()    { done("sent"); },
                        "error":   function() { done("error"); }
                    });
            
            
        });
        
        $('#cancel').click(function() { 
            $.unblockUI();
            clear_message_input();
            
        });  
      
    });
    
 </script> 

<h2>{{ domain }}</h2>
<h2>All Form Submissions</h2>
{% with all_metadata as data %}
{% include "hq/partials/pagination.html" %}
{% endwith %}
<table class="sofT">
    <thead class="commcare-heading">
        {% for column, display in columns %}
          {% ifequal column sort_column %}
             <th class="sorted" id="{% if sort_descending %}descending{% else %}ascending{% endif %}">
               <a href="?sort_column={{column}}&sort_descending={% if sort_descending %}false{% else %}true{% endif %}{% if filters %}&{% dict_as_query_string filters "filter_" %}{% endif %}">
                 {{ display }}
               </a>
             </th>
          {% else %}
             <th><a href="?sort_column={{column}}{% if filters %}&{% dict_as_query_string filters "filter_" %}{% endif %}">{{display}}</a></th>
          {% endifequal %}              
       {% endfor%}
       <th>Actions</th>
    </thead>
    <tbody>
        {% for metadata in all_metadata.object_list %}
        <tr>
            {% for column, display in columns %}
                {% ifequal column sort_column %}<td class="sorted">{% else %}<td>{% endifequal %}
                {% with metadata|attribute_lookup:column as col_value %}
            {% comment %}
            ######### begin commented out code ###########
            This commented out block displays a grid with clickable data that adds filters on that
            value, just like the data view.  However I'm going to get rid of this behavior for now, 
            I don't think this is the most intuitive way for this table to behave, so I'm just going 
            to hard code the data and links below. 
                {% if col_value %}
                    <a href="?filter_{{ column }}={{ col_value }}&{{sort_params}}">{{ col_value }}</a>
                {% else %}
                    {{ col_value }}
                {% endif %}
                {{ col_value }}
                </td>
            ######### end commented out code ###########
            {% endcomment %}
                {% ifequal column "formdefmodel" %}
                <a href="{% url xformmanager.views.data col_value.id %}">
                    {{ col_value.form_display_name }}</a>
                {% else %}
                    {{ col_value }}
                {% endifequal %}
                {% endwith %}
                </td>
            {% endfor %}
            <td>
            <a href="{% url receiver.views.single_attachment metadata.attachment.id %}">view xml submission</a>&nbsp;&nbsp;
            <a href="{% url xformmanager.views.single_instance metadata.formdefmodel.id metadata.raw_data %}">view form data</a>
            {% if metadata.submitting_reporter %}
            <div class="js_link" onclick="show_message_box({{metadata.submitting_reporter.id}});">message chw</div></p>
            {% endif %} 
            </td>
        </tr>
        {% endfor %}
        
    </tbody>
</table>

<input id="reporter_id" type="hidden">
<div id="message_popup" style="display:none">Enter Your Message Here
<textarea id="message" rows="4" cols="40"></textarea>
<input id="send" type="button" value="Send" />
<input id="cancel" type="button" value="Cancel" />
</div>