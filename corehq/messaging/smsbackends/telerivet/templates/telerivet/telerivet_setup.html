{% extends 'style/bootstrap3/base_section.html' %}
{% load i18n %}
{% load hq_shared_tags %}
{% load djangular_tags %}
{% load crispy_forms_tags %}


{% block js %}{{ block.super }}
    <script src="{% new_static 'hqwebapp/js/main.js' %}"></script>
{% endblock %}


{% block js-inline %}{{ block.super }}
<script type="text/javascript">
(function (angular) {
    'use strict';
    var telerivetSetupApp = angular.module('telerivetSetupApp', ['ngRoute', 'ng.django.rmi']);

    var globalApiKey = '';
    var globalProjectId = '';
    var globalPhoneId = '';
    var globalTestPhoneNumber = '';
    var globalTestSMSSent = false;

    telerivetSetupApp.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
        $httpProvider.defaults.xsrfCookieName = 'csrftoken';
        $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
    }]);

    telerivetSetupApp.config(function(djangoRMIProvider) {
        djangoRMIProvider.configure({% djng_current_rmi %});
    });

    telerivetSetupApp.config(function($routeProvider) {
        $routeProvider
            .when('/step1', {templateUrl: 'step1.tpl'})
            .when('/step2', {templateUrl: 'step2.tpl'})
            .when('/step3', {templateUrl: 'step3.tpl'})
            .when('/finish', {templateUrl: 'finish.tpl'})
            .otherwise({redirectTo: '/step1'});
    });

    telerivetSetupApp.controller('TelerivetSetupController', function($scope, djangoRMI) {
        // model attributes
        $scope.apiKey = globalApiKey;
        $scope.projectId = globalProjectId;
        $scope.phoneId = globalPhoneId;
        $scope.testPhoneNumber = globalTestPhoneNumber;
        $scope.name = '';
        $scope.setAsDefault = '';

        // error messages
        $scope.apiKeyError = null;
        $scope.projectIdError = null;
        $scope.phoneIdError = null;
        $scope.testPhoneNumberError = null;
        $scope.nameError = null;
        $scope.setAsDefaultError = null;

        // screenshot toggles
        $scope.showApiKeyGeneration = false;
        $scope.showApiInfoLocation = false;
        $scope.showAddWebookNavigation = false;
        $scope.showWebhookDetails = false;

        // control flow variables
        $scope.testSMSSent = globalTestSMSSent;
        $scope.pollForInboundSMS = false;
        $scope.pollingErrorOccurred = false;
        $scope.inboundSMSReceived = false;
        $scope.inboundWaitTimedOut = false;
        $scope.setupComplete = false;

        $scope.toggleApiInfoLocation = function() {
            $scope.showApiInfoLocation = !$scope.showApiInfoLocation;
        };

        $scope.toggleApiKeyGeneration = function() {
            $scope.showApiKeyGeneration = !$scope.showApiKeyGeneration;
        };

        $scope.toggleAddWebookNavigation = function() {
            $scope.showAddWebookNavigation = !$scope.showAddWebookNavigation;
        };

        $scope.toggleWebhookDetails = function() {
            $scope.showWebhookDetails = !$scope.showWebhookDetails;
        };

        $scope.sendTestSMS = function() {
            djangoRMI.send_sample_sms({
                api_key: $scope.apiKey,
                project_id: $scope.projectId,
                phone_id: $scope.phoneId,
                test_phone_number: $scope.testPhoneNumber,
                request_token: '{{ request_token }}',
            })
            .success(function(data) {
                $('#id_send_sms_button')
                .text('{% trans "Send" %}');
                $scope.apiKeyError = data.api_key_error;
                $scope.projectIdError = data.project_id_error;
                $scope.phoneIdError = data.phone_id_error;
                $scope.testPhoneNumberError = data.unexpected_error || data.test_phone_number_error;
                $scope.testSMSSent = data.success;
            })
            .error(function() {
                $('#id_send_sms_button')
                .text('{% trans "Server error. Try again..." %}');
            });
        };

        $scope.createBackend = function() {
            $('#id_create_backend').prop('disabled', true);
            djangoRMI.create_backend({
                name: $scope.name,
                api_key: $scope.apiKey,
                project_id: $scope.projectId,
                phone_id: $scope.phoneId,
                request_token: '{{ request_token }}',
                set_as_default: $scope.setAsDefault
            })
            .success(function(data) {
                if(data.success) {
                    $scope.setupComplete = true;
                } else {
                    $scope.nameError = data.unexpected_error || data.name_error;
                    if(data.name_error) {
                        $('#id_create_backend')
                        .prop('disabled', false)
                        .text('{% trans "Finish" %}');
                    }
                }
            })
            .error(function() {
                $('#id_create_backend')
                .prop('disabled', false)
                .text('{% trans "Server error. Try again..." %}');
            });
        };

        $scope.getLastInboundSMS = function() {
            djangoRMI.get_last_inbound_sms({
                request_token: '{{ request_token }}',
            })
            .success(function(data) {
                if(data.success) {
                    if(data.found) {
                        $scope.inboundSMSReceived = true;
                    } else {
                        setTimeout($scope.getLastInboundSMS, 10000);
                    }
                } else {
                    $scope.pollingErrorOccurred = true;
                }
            })
            .error(function() {
                // This is just an http error, for example, rather than
                // something like a missing request token, so just retry it.
                setTimeout($scope.getLastInboundSMS, 10000);
            });
        };

        $scope.startInboundPolling = function() {
            $scope.pollForInboundSMS = true;
            $scope.inboundWaitTimedOut = false;
            setTimeout(function() {
                $scope.inboundWaitTimedOut = true;
            }, 60000);
            $scope.getLastInboundSMS();
        };

        // TODO: Figure out if there's a better way to deal with these scope issues
        $scope.$watch('apiKey', function(newValue, oldValue) {
            globalApiKey = newValue;
            $scope.testSMSSent = false;
        });
        $scope.$watch('projectId', function(newValue, oldValue) {
            globalProjectId = newValue;
            $scope.testSMSSent = false;
        });
        $scope.$watch('phoneId', function(newValue, oldValue) {
            globalPhoneId = newValue;
            $scope.testSMSSent = false;
        });
        $scope.$watch('testPhoneNumber', function(newValue, oldValue) {
            globalTestPhoneNumber = newValue;
        });
        $scope.$watch('testSMSSent', function(newValue, oldValue) {
            globalTestSMSSent = newValue;
        });
    });
}(window.angular));
</script>
{% endblock %}


{% block page_content %}
<div ng-app="telerivetSetupApp">
    <script type="text/ng-template" id="step1.tpl">
        <h2>{% trans "Step 1. Download Telerivet App" %}</h2>
        <div ng-controller="TelerivetSetupController" ng-cloak>
            <ol>
                <li>
                    <p>
                        {% blocktrans %}
                        If you have not already done so, create an account at <a target="_blank" href="https://www.telerivet.com">www.telerivet.com</a>.
                        Be sure to give your Telerivet project a name:
                        {% endblocktrans %}
                    </p>
                    <p>
                        <img src="{% new_static 'telerivet/img/update_project_name.png' %}" />
                    </p>
                </li>
                <li>
                    <p>
                        {% blocktrans %}
                        On your Android phone, go to <a target="_blank" href="https://telerivet.com/app">telerivet.com/app</a> and download the Telerivet App.</li>
                        {% endblocktrans %}
                    </p>
                </li>
                <li>
                    <p>
                        {% blocktrans %}
                        Open the Telerivet App on your Android phone. Log in and follow the instructions to connect the App to your Telerivet project.
                        {% endblocktrans %}
                    </p>
                </li>
            </ol>
        </div>
        <div class="row">
            <a class="btn btn-primary col-sm-2" href="#/step2">
                {% trans "Continue" %}
                <span class="glyphicon glyphicon-chevron-right" />
            </a>
        </div>
    </script>
    <script type="text/ng-template" id="step2.tpl">
        <h2>{% trans "Step 2. Connect Outgoing SMS" %}</h2>
        <div ng-controller="TelerivetSetupController" ng-cloak>
            <ol>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            Go to the Telerivet website and generate an API key if you have not already done so.
                            <a href="#/step2" ng-hide="showApiKeyGeneration" ng-click="toggleApiKeyGeneration();">Show</a>
                            <a href="#/step2" ng-show="showApiKeyGeneration" ng-click="toggleApiKeyGeneration();">Hide</a>
                            how to do this.
                            {% endblocktrans %}
                        </p>
                        <p ng-show="showApiKeyGeneration">
                            <img src="{% new_static 'telerivet/img/generate_api_key.png' %}" />
                        </p>
                    </div>
                </li>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            On that same page in the Telerivet website, make note of your API Key, Project ID, and Phone ID, and enter them below.
                            <a href="#/step2" ng-hide="showApiInfoLocation" ng-click="toggleApiInfoLocation();">Show</a>
                            <a href="#/step2" ng-show="showApiInfoLocation" ng-click="toggleApiInfoLocation();">Hide</a>
                            where to find this.
                            {% endblocktrans %}
                        </p>
                        <p class="help-block" ng-show="showApiInfoLocation">
                            {% blocktrans %}
                            <i class="fa fa-info-circle" /> You may need to click "Show" to view your API Key.
                            {% endblocktrans %}
                        </p>
                        <p ng-show="showApiInfoLocation">
                            <img src="{% new_static 'telerivet/img/api_settings.png' %}" />
                        </p>
                    </div>
                    <div class="row">
                        {% crispy outgoing_sms_form %}
                    </div>
                </li>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            Enter the phone number of a different phone below and click Send to send a test SMS from CommCareHQ.
                            {% endblocktrans %}
                        </p>
                        <p class="help-block">
                            {% blocktrans %}
                            <i class="fa fa-info-circle" />
                            This phone number should be different from the Telerivet Android phone number.
                            Please enter in international format, starting with the country code, digits only.
                            {% endblocktrans %}
                        </p>
                        <div class="row">
                            {% crispy test_sms_form %}
                        </div>
                    </div>
                </li>
                <li ng-show="testSMSSent">
                    <div>
                        <p>
                            {% blocktrans %}
                            Did you receive the test SMS?
                            {% endblocktrans %}
                        </p>
                        <div class="row">
                            <button class="btn btn-default col-sm-2">
                                {% trans "No, Troubleshoot" %}
                            </button>
                            <a class="btn btn-primary col-sm-2" href="#/step3">
                                {% trans "Yes, Continue" %}
                                <span class="glyphicon glyphicon-chevron-right" />
                            </a>
                        </div>
                    </div>
                </li>
            </ol>
        </div>
    </script>
    <script type="text/ng-template" id="step3.tpl">
        <h2>{% trans "Step 3. Connect Incoming SMS" %}</h2>
        <div ng-controller="TelerivetSetupController" ng-cloak>
            <ol>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            Navigate to the Add Webhook Service page in the Telerivet website.
                            <a href="#/step3" ng-hide="showAddWebookNavigation" ng-click="toggleAddWebookNavigation();">Show</a>
                            <a href="#/step3" ng-show="showAddWebookNavigation" ng-click="toggleAddWebookNavigation();">Hide</a>
                            how to do this.
                            {% endblocktrans %}
                        </p>
                        <p class="help-block" ng-show="showAddWebookNavigation">
                            {% blocktrans %}
                            <i class="fa fa-info-circle" /> You may need to click "Add New Service" in the top-right corner of the page.
                            {% endblocktrans %}
                        </p>
                        <p ng-show="showAddWebookNavigation">
                            <img src="{% new_static 'telerivet/img/add_webhook_service.png' %}" />
                        </p>
                    </div>
                </li>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            Enter the information below and click Done.
                            <a href="#/step3" ng-hide="showWebhookDetails" ng-click="toggleWebhookDetails();">Show</a>
                            <a href="#/step3" ng-show="showWebhookDetails" ng-click="toggleWebhookDetails();">Hide</a>
                            where to add these fields.
                            {% endblocktrans %}
                        </p>
                        <table style="width: auto;" class="table table-bordered">
                            <tr>
                                <th><strong>Service Name</strong></th>
                                <td>CommCareHQ</td>
                            </tr>
                            <tr>
                                <td><strong>Webhook URL</strong></th>
                                <td>{{ webhook_url }}</td>
                            </tr>
                            <tr>
                                <th><strong>Webhook Secret</strong></th>
                                <td>{{ webhook_secret}}</td>
                            </tr>
                        </table>
                        <p ng-show="showWebhookDetails">
                            <img src="{% new_static 'telerivet/img/webhook_detail_screen.png' %}" />
                        </p>
                    </div>
                </li>
                <li>
                    <div>
                        <p>
                            {% blocktrans %}
                            After creating the Webhook Service in the Telerivet website, send an SMS to the Telerivet Android phone from
                            another phone. <button class="btn btn-success" ng-click="startInboundPolling();">Click Here</button> after you have sent the SMS.
                            {% endblocktrans %}
                        </p>
                    </div>
                </li>
                <li ng-show="pollForInboundSMS">
                    <div>
                        <p ng-show="!inboundSMSReceived && !inboundWaitTimedOut && !pollingErrorOccurred">{% trans "Waiting for inbound SMS..." %}</p>
                        <p ng-show="inboundSMSReceived && !pollingErrorOccurred">
                            {% trans "Message received!" %}
                            <a class="btn btn-primary" href="#/finish">
                                {% trans "Continue" %}
                                <span class="glyphicon glyphicon-chevron-right" />
                            </a>
                        </p>
                        <p ng-show="inboundWaitTimedOut && !inboundSMSReceived && !pollingErrorOccurred">
                            {% blocktrans %}
                            Message not received. <button class="btn btn-default">Troubleshoot</button>
                            {% endblocktrans %}
                        </p>
                        <p ng-show="pollingErrorOccurred">
                            {% blocktrans %}
                            An error occurred. This can happen if it has been longer than one week since you started the Telerivet setup process in CommCareHQ.
                            Please restart the setup process and if the problem persists, please report an issue.
                            {% endblocktrans %}
                        </p>
                    </div>
                </li>
            </ol>
        </div>
    </script>
    <script type="text/ng-template" id="finish.tpl">
        <h2>{% trans "Finish Setup" %}</h2>
        <div ng-controller="TelerivetSetupController" ng-cloak>
            <div ng-hide="setupComplete">
                <p class="help-block">
                    <i class="fa fa-info-circle" />
                    {% blocktrans %}
                    Choose a name for this gateway below and click Finish.
                    {% endblocktrans %}
                </p>
            </div>
            <div ng-hide="setupComplete">
                {% crispy finalize_gateway_form %}
            </div>
            <div ng-show="setupComplete">
                <a href="{% url 'list_domain_backends' domain %}" class="btn btn-success">
                    {% trans "Success! Return to gateway list" %}
                    <span class="glyphicon glyphicon-chevron-right" />
                </a>
            </div>
        </div>
    </script>
    <div>
        <div ng-view></div>
    </div>
</div>
{% endblock %}
