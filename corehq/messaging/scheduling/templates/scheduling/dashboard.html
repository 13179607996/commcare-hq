{% extends "hqwebapp/base_section.html" %}
{% load hq_shared_tags %}
{% load i18n %}


{% block stylesheets %}{{ block.super }}
<style>
    .messaging-dashboard-indicator{
        font-size: 20px;
    };
</style>
{% endblock %}


{% block js %}{{ block.super }}
    <script src="{% static 'scheduling/js/dashboard.js' %}"></script>
{% endblock %}


{% block page_content %}
    {% registerurl 'messaging_dashboard' domain %}
    {# Prevent flicker by hiding and using bindingApplied to make visible #}
    <div id="messaging_dashboard" class="container-fluid" style="display: none;" data-bind="visible: bindingApplied">
        <div>
            <p>
                <span>{% trans "Last updated:" %}</span>
                <span data-bind="text: last_refresh_time"></span>
                <span>
                    (<span data-bind="text: project_timezone"></span>)
                </span>
            </p>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <strong>{% trans "SMS Status:" %}</strong>
                    <strong class="text-success" data-bind="visible: is_sms_currently_allowed() && queued_sms_count() === 0">{% trans "All Caught Up" %}</strong>
                    <strong class="text-warning" data-bind="visible: is_sms_currently_allowed() && queued_sms_count() > 0">{% trans "Working" %}</strong>
                    <strong class="text-danger" data-bind="visible: !is_sms_currently_allowed()">{% trans "Paused" %}</strong>
                    <span data-bind="visible: queued_sms_count() > 0 || !is_sms_currently_allowed()">
                        (<span data-bind="text: queued_sms_count"></span>
                        {% trans "SMS in the queue" %})
                    </span>
                </h3>
            </div>
            <div class="panel-body">
                <div class="row" data-bind="visible: !is_sms_currently_allowed()">
                    <p class="help-block">
                        <span><i class="fa fa-info-circle"></i> {% trans "Messages will remain queued until the below conditions are cleared." %}</span>
                    </p>
                </div>
                <div class="row">
                    <div class="col-xs-2 col-lg-1">
                        <span>{% trans "Daily Usage" %}</span>
                    </div>
                    <div class="col-xs-1 text-center">
                       <span class="messaging-dashboard-indicator glyphicon glyphicon-ok text-success" aria-hidden="true" data-bind="visible: is_daily_usage_ok"></span>
                       <span class="messaging-dashboard-indicator glyphicon glyphicon-remove text-danger" aria-hidden="true" data-bind="visible: !is_daily_usage_ok()"></span>
                    </div>
                    <div class="col-xs-4">
                        <div class="progress">
                            <div class="progress-bar"
                                 role="progressbar"
                                 aria-valuemin="0"
                                 aria-valuemax="100"
                                 data-bind="
                                    style: {width: percentage_daily_outbound_sms_used() + '%'},
                                    css: {'progress-bar-success': outbound_sms_sent_today() < daily_outbound_sms_limit(),
                                          'progress-bar-danger': outbound_sms_sent_today() >= daily_outbound_sms_limit()}
                                 ">
                            </div>
                        </div>
                    </div>
                    <div class="col-xs-4">
                        <span>{% trans "Daily Limit:" %}</span>
                        <span data-bind="text: daily_outbound_sms_limit"></span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-xs-2 col-lg-1">
                        <span>{% trans "Restricted Times" %}</span>
                    </div>
                    <div class="col-xs-1 text-center">
                       <span class="messaging-dashboard-indicator glyphicon glyphicon-ok text-success" aria-hidden="true" data-bind="visible: within_allowed_sms_times"></span>
                       <span class="messaging-dashboard-indicator glyphicon glyphicon-remove text-danger" aria-hidden="true" data-bind="visible: !within_allowed_sms_times()"></span>
                    </div>
                    <div class="col-xs-9">
                        <span data-bind="visible: !uses_restricted_time_windows()">
                            {% blocktrans %}
                            Your project currently does not restrict the times of day at which SMS can be sent.
                            {% endblocktrans %}
                        </span>
                        <span data-bind="visible: uses_restricted_time_windows() && !within_allowed_sms_times()">
                            {% blocktrans %}
                            Your project restricts the times of day at which SMS can be sent. SMS will resume sending at
                            <span data-bind="text: sms_resume_time"></span> (<span data-bind="text: project_timezone"></span>).
                            {% endblocktrans %}
                        </span>
                        <span data-bind="visible: uses_restricted_time_windows() && within_allowed_sms_times()">
                            {% blocktrans %}
                            Your project restricts the times of day at which SMS can be sent, but no restrictions are currently active.
                            {% endblocktrans %}
                        </span>
                        {% if request.couch_user.is_domain_admin %}
                            <a target="_blank" href="{% url 'sms_settings' domain %}">{% trans "Update" %}</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
