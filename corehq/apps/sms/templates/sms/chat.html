{% load hq_shared_tags %}{% load i18n %}<!DOCTYPE html>
<html>
    <head>
        <title>Chat</title>
        <link rel="stylesheet" media="screen" href="{% static 'hqstyle/css/core/hqstyle-core.css' %}"/>
        <script src="{% static 'hqstyle/js/jquery/jquery-1.7.1.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'hqwebapp/js/lib/knockout-2.1.0.debug.js' %}"></script>
        <script type="text/javascript" src="{% static 'hqwebapp/ko/global.handlers.js' %}"></script>
        <style>
            html, body {
                height: 100%;
                overflow: hidden;
            }
            #chat_header {
                height: 50px;
            }
            #chat_messages {
                height: 200px;
                overflow-y: auto;
                border-top: 1px solid #CCC;
                border-bottom: 1px solid #CCC;
            }
            #chat_footer {
                height: 50px;
            }
            .timestamp_content {
                text-align: right;
                white-space: nowrap;
                overflow: hidden;
            }
            #message_table td {
                padding-left: 5px;
                padding-right: 5px;
            }
            #header_table {
                width: 100%;
            }
            #message_table {
                width: 100%;
            }
            #footer_table {
                width: 100%;
            }
            #text_box {
                resize: none;
                width: 100%;
            }
            #send_col {
                text-align: right;
            }
            #message_length_label {
                border: 1px solid black;
                margin-right: 10px;
                padding: 5px;
            }
        </style>
    </head>
    <body>
        <div id="chat_header">
            <table id="header_table">
                <tbody>
                    <tr>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="chat_messages">
            <table id="message_table">
                <tbody data-bind="foreach: messages">
                    <tr>
                        <td class="message_content"><strong><span data-bind="text: sender"></span></strong>: <span data-bind="text: text"></span></td>
                        <td><div class="timestamp_content" data-bind="text: timestamp"></div></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="chat_footer">
            <table id="footer_table">
                <tbody>
                    <tr>
                        <td><textarea id="text_box"></textarea></td>
                        <td id="send_col"><strong><span id="message_length_label" data-bind="text: message_length"></span></strong><span class="btn btn-primary" data-bind="click: send_message">Send</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <script>
            $(function() {
                function resize_messages() {
                    body_height = $("body").height();
                    $("#chat_messages").height(body_height - 110);
                }
                resize_messages();
                
                function ChatMessage(sender, text, timestamp) {
                    var self = this;
                    self.sender = sender;
                    self.text = text;
                    self.timestamp = timestamp;
                }
                function ChatWindowViewModel() {
                    var self = this;
                    self.message_length = ko.observable("0 / 160");
                    self.messages = ko.observableArray([]);
                    self.latest_message_utc_timestamp = null;
                    self.latest_timeout_handle = null;
                    self.update_messages = function() {
                        payload = {
                            contact_id : "{{ contact_id }}"
                        };
                        if(self.latest_message_utc_timestamp != null) {
                            payload.start_date = self.latest_message_utc_timestamp;
                        }
                        request = $.ajax({
                            url : "{% url api_history domain %}",
                            data : payload
                        });
                        request.done(function(response, textStatus, jqXHR) {
                            data = $.parseJSON(response);
                            for(i = 0; i < data.length; i++) {
                                chat_window_view_model.messages.push(new ChatMessage(data[i].sender, data[i].text, data[i].timestamp));
                                self.latest_message_utc_timestamp = data[i].utc_timestamp;
                            }
                        });
                        //scrollHeight = $("#chat_messages").prop("scrollHeight");
                        //$("#chat_messages").scrollTop(scrollHeight);
                    };
                    self.send_message = function() {
                        clearTimeout(self.latest_timeout_handle);
                        request = $.ajax({
                            url : "{% url api_send_sms domain %}",
                            type : "POST",
                            data : {
                                contact_id : "{{ contact_id }}",
                                text : $("#text_box").val()
                            }
                        });
                        request.done(function(response, textStatus, jqXHR) {
                            if(response == "OK") {
                                $("#text_box").val("");
                                self.update_message_length(null);
                            } else {
                            }
                        });
                        request.always(function() {
                            self.update_messages_timeout();
                        });
                    };
                    self.update_messages_timeout = function() {
                        self.update_messages();
                        self.latest_timeout_handle = setTimeout(self.update_messages_timeout, 15000);
                    };
                    self.update_message_length = function(event) {
                        setTimeout(function() {
                            len = $("#text_box").val().length;
                            max_len = 160;
                            self.message_length(len + " / " + max_len);
                            if(len > max_len) {
                                $("#message_length_label").css("background-color", "#F00");
                            } else {
                                $("#message_length_label").css("background-color", "#FFF");
                            }
                        }, 250);
                    };
                }
                chat_window_view_model = new ChatWindowViewModel();
                ko.applyBindings(chat_window_view_model);
                $(window).resize(resize_messages);
                chat_window_view_model.update_messages_timeout();
                $("#text_box").bind("paste", chat_window_view_model.update_message_length);
                $("#text_box").keyup(chat_window_view_model.update_message_length);
            });
        </script>
    </body>
</html>
