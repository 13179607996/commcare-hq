from datetime import datetime
from django.core.management.base import NoArgsCommand
import sys
import os
from casexml.apps.case.models import CommCareCase
from corehq.apps.hqcase.management.commands.ptop_generate_mapping import MappingOutputCommand
from corehq.pillows import dynamic, CasePillow
from corehq.pillows.dynamic import DEFAULT_MAPPING_WRAPPER, case_special_types
from django.conf import settings

class Command(MappingOutputCommand):
    help="Generate mapping JSON of our ES indexed types. For casexml"
    option_list = NoArgsCommand.option_list + (
    )
    doc_class_str = "casexml.apps.case.models.CommCareCase"
    doc_class = CommCareCase


    def finish_handle(self):

        filepath = os.path.join(settings.FILEPATH, 'submodules','core-hq-src','corehq','pillows','mappings','case_mapping.py')
        casepillow = CasePillow(create_index=False)

        #current index
        #check current index
        aliased_indices = casepillow.check_alias()

        current_index = '%s_%s' % (casepillow.es_index_prefix, casepillow.calc_meta())

        print 'CASE_INDEX=%s' % current_index

        if current_index not in aliased_indices:
            sys.stderr.write("Warning, current index %s is not aliased at the moment\n" % current_index)
            sys.stderr.write("Current index: %s\n"  % (','.join(aliased_indices)))

        #regenerate the mapping dict
        m = DEFAULT_MAPPING_WRAPPER
        m['properties'] = dynamic.set_properties(self.doc_class, custom_types=case_special_types)
        m['_meta']['comment'] = "Autogenerated [%s] mapping from ptop_generate_mapping %s" % (self.doc_class_str, datetime.utcnow().strftime('%m/%d/%Y'))
        casepillow.default_mapping = m
        del(casepillow._calc_meta)
        output = []
        output.append('CASE_INDEX="%s_%s"' % (casepillow.es_index_prefix, casepillow.calc_meta()))
        output.append('CASE_MAPPING=%s' % m)

        with open(filepath, 'w') as outfile:
            outfile.write('\n'.join(output))
        sys.stderr.write("File written to %s" % filepath)



