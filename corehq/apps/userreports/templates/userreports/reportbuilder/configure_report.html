{% extends "userreports/base_report_builder.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
    <script src="{% static 'style/js/main.js' %}"></script>
    <script src="{% static 'app_manager/js/case-knockout-bindings.js' %}"></script>
    <script src="{% static 'userreports/js/constants.js' %}"></script>
    <script src="{% static 'userreports/js/report_config.js' %}"></script>
{% endblock %}

{% block page_title %}
    {% if not editing_existing_report %}
    {% trans "Step 2 of 2" %} -
    {% endif %}
    {% trans "Configure Report" %}
{% endblock page_title %}

{% block page_content %}
  <div id="reportConfig">
    <!-- TODO: <div>Report Name ... | Save and View | Save |</div> -->
    <!-- TODO: <div>Enter a description here</div> -->
    <div class="col-md-4">
      <legend>Configure Report</legend>
      <div>
        <h3>{% trans 'Type of Report' %}</h3>
        <select data-bind="options: reportTypeOptions,
                           value: reportType,
                           optionsText: 'label',
                           optionsValue: 'name'">
        </select>
      </div>

      <div id="columns">
        <h3 data-bind="text: reportType() === 'agg' ?  '{% trans 'Indicators' %}' : '{% trans 'Columns' %}'">
            {% trans 'Columns' %}
        </h3>
        <table class="table">
          <thead data-bind="fadeVisible: isAggregationEnabled">
            <tr>
              <th>{% trans 'Indicator' %}</th>
              <th class="center">{% trans 'Display Each' %}</th>
              <th>{% trans 'Summarize' %}</th>
              <th>&nbsp;</th>
            </tr>
          </thead>
          <tbody>
            <!-- ko foreach: selectedColumns -->
            <tr>
              <td data-bind="text: label"></td>
              <td>
                <input data-bind="fadeVisible: $parent.isAggregationEnabled,
                                  checked: isGroupByColumn"
                       type="checkbox" />
              </td>
              <td>
                <select data-bind="fadeVisible: $parent.isAggregationEnabled,
                                   disable: isGroupByColumn,
                                   value: aggregation">
                  <option value="simple">---</option>
                  <!-- ko if: isNumeric -->
                  <option value="sum">{% trans 'Sum' %}</option>
                  <option value="avg">{% trans 'Average' %}</option>
                  <!-- /ko -->
                  <option value="expand">{% trans 'Count per Choice' %}</option>
                </select>
              </td>
              <td>
                <button class="btn btn-danger"
                        data-bind="click: $parent.removeColumn"><i class="fa fa-remove"></i></button>
              </td>
            </tr>
            <!-- /ko -->
            <tr>
              <td>
                <select data-bind="options: columns,
                                   optionsText: 'label',
                                   optionsValue: 'name',
                                   value: newColumnName">
                </select>
              </td>
              <td></td>
              <td><button class="btn btn-primary" data-bind="click: addColumn"><i class="fa fa-plus"></i></button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-md-8">
        <legend>{% trans 'Preview Report' %}</legend>

        <!-- ko if: selectedChart() === 'none' -->
        <div data-bind="fadeVisible: isAggregationEnabled">
            <div class="btn btn-primary" data-bind="click: function(){selectedChart('bar');}">{% trans 'Add Chart' %}</div>
            <div> <!-- I'm so lazy... -->
                <br>
            </div>
        </div>
        <!-- /ko -->

      <div class="well" data-bind="fadeVisible: previewChart">

        <h3 style="display: inline-block">{% trans 'Chart Preview' %}</h3>
        <div class="pull-right">
          <div class="btn btn-danger" data-bind="click: function(){selectedChart('none');}"><i class="fa fa-remove"></i></div>
        </div>
        <div data-bind="if: selectedChart() !== 'none'">
            Type:
            <select data-bind="value: selectedChart">
                <option value="bar">{% trans 'Bar' %}</option>
                <option value="pie">{% trans 'Pie' %}</option>
            </select>
        </div>

        <div id="chart"></div>
      </div>
      <div class="well">
        <h3>{% trans 'Data Table' %}</h3>
        <table id="preview" class="table"></table>
      </div>
    </div>
  </div>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script>

    $(document).ready(function() {
        var reportConfig = new reportBuilder.ReportConfig({
            "columns": {{ columns|JSON }},
            "sourceType": "{{ source_type }}",
            "dataSourceUrl": "{{ data_source_url }}",
        });
        ko.applyBindings(reportConfig, $("#reportConfig").get(0));
    });

</script>
{% endblock %}
