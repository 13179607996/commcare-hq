{% extends "userreports/base_report_builder.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
    <script src="{% static 'style/js/main.js' %}"></script>
    <script src="{% static 'app_manager/js/case-knockout-bindings.js' %}"></script>
    <script src="{% static 'userreports/js/constants.js' %}"></script>
    <script src="{% static 'userreports/js/report_config.js' %}"></script>
{% endblock %}

{% block pre_page_content %}{% endblock %}{# Avoid the spacer #}

{% block page_content %}
  <div id="reportConfig">

    <div class="pull-right page-actions-toolbar">
      <button class="btn btn-info">Save &amp; View</button>
      <button class="btn btn-success">Save</button>
    </div>
    {# See `style/two_column.html` #}
    <div class="page-header" style="margin-top: 0;">
      <h1 style="font-size: 1.8em;" data-bind="text: reportTitle"></h1>
    </div>

    <!-- TODO: <div>Enter a description here</div> -->

    <div>
      <h3>{% trans 'Type of Report' %}</h3>
      <div class="btn-group">
        <label class="btn btn-default" data-bind="css: {'active': reportType() === 'list'}">
          <!-- TODO: Don't style here -->
          <input type="radio" name="reportTypes" id="reportTypeList" style="display: none;"
                 data-bind="checked: reportType, checkedValue: 'list'">
          <i class="fa fa-bars"></i> <span data-bind="text: reportTypeListLabel"></span>
        </label>
        <label class="btn btn-default" data-bind="css: {'active': reportType() === 'agg'}">
          <input type="radio" name="reportTypes" id="reportTypeAgg" style="display: none;"
                 data-bind="checked: reportType, checkedValue: 'agg'">
          <i class="fa fa-filter"></i> <span data-bind="text: reportTypeAggLabel"></span>
        </label>
        <label class="btn btn-default" data-bind="css: {'active': reportType() === 'map'}">
          <input type="radio" name="reportTypes" id="reportTypeMap" style="display: none;"
                 data-bind="checked: reportType, checkedValue: 'map'">
          <i class="fa fa-map-marker"></i> Map
        </label>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="col-md-5">
      <legend>Configure Report</legend>

      <div id="columns">
        <h3 data-bind="text: reportType() === 'agg' ?  '{% trans 'Indicators' %}' : '{% trans 'Columns' %}'">
            {% trans 'Columns' %}
        </h3>
        <table class="table">
          <thead data-bind="fadeVisible: isAggregationEnabled">
            <tr>
              <th>{% trans 'Indicator' %}</th>
              <th>{% trans 'Format' %}</th>
              <th>&nbsp;</th>
            </tr>
          </thead>
          <tbody>
            <!-- ko foreach: selectedColumns -->
            <tr>
              <td data-bind="text: label"></td>
              <td>
                <select data-bind="fadeVisible: $parent.isAggregationEnabled,
                                   value: groupByOrAggregation">
                  <option value="groupBy">{% trans 'Display Each' %}</option>
                  <option value="simple">---</option>
                  <!-- ko if: isNumeric -->
                  <option value="sum">{% trans 'Sum' %}</option>
                  <option value="avg">{% trans 'Average' %}</option>
                  <!-- /ko -->
                  <option value="expand">{% trans 'Count per Choice' %}</option>
                </select>
              </td>
              <td>
                <button class="btn btn-danger"
                        data-bind="click: $parent.removeColumn"><i class="fa fa-remove"></i></button>
              </td>
            </tr>
            <!-- /ko -->
            <tr>
              <td>
                <select data-bind="options: columns,
                                   optionsText: 'label',
                                   optionsValue: 'name',
                                   value: newColumnName">
                </select>
              </td>
              <td></td>
              <td><button class="btn btn-primary" data-bind="click: addColumn"><i class="fa fa-plus"></i></button></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="col-md-7">
        <legend>{% trans 'Preview Report' %}</legend>

        <!-- ko if: selectedChart() === 'none' -->
        <div data-bind="fadeVisible: isAggregationEnabled">
            <div class="btn btn-primary" data-bind="click: function(){selectedChart('bar');}">{% trans 'Add Chart' %}</div>
            <div> <!-- I'm so lazy... -->
                <br>
            </div>
        </div>
        <!-- /ko -->

      <div class="well" data-bind="fadeVisible: previewChart">

        <h3 style="display: inline-block">{% trans 'Chart Preview' %}</h3>
        <div class="pull-right">
          <div class="btn btn-danger" data-bind="click: function(){selectedChart('none');}"><i class="fa fa-remove"></i></div>
        </div>
        <div data-bind="if: selectedChart() !== 'none'">
            Type:
            <select data-bind="value: selectedChart">
                <option value="bar">{% trans 'Bar' %}</option>
                <option value="pie">{% trans 'Pie' %}</option>
            </select>
        </div>

        <div id="chart"></div>
      </div>
      <div class="well">
        <h3>{% trans 'Data Table' %}</h3>
        <table id="preview" class="table"></table>
      </div>
    </div>
  </div>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script>

    $(document).ready(function() {
        var reportConfig = new reportBuilder.ReportConfig({
            "reportTitle": "{{ report.title|escapejs }}",
            "columns": {{ columns|JSON }},
            "sourceType": "{{ source_type }}",
            "dataSourceUrl": "{{ data_source_url }}",
        });
        ko.applyBindings(reportConfig, $("#reportConfig").get(0));
    });

</script>
{% endblock %}
