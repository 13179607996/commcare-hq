{% extends "appstore/appstore_base.html" %}
{% load hq_shared_tags %}
{% load hq_bootstrap_tags %}
{% load i18n %}

{% block js-inline %}{{ block.super }}
<style type="text/css">
.rating > span {
display: inline-block;
position: relative;
width: 1.1em;
}
.rating:hover > span:before{
content: "\2605";
position: absolute;
}
.rating > span:hover ~ span:before {
content: "";
}​
</style>

<script>
    ko.bindingHandlers.starRating = {
        init: function(element, valueAccessor) {
            $(element).addClass("starRating");
            for (var i = 0; i < 5; i++)
                $("<span>").appendTo(element);

            // Handle mouse events on the stars
            $("span", element).each(function(index) {
                $(this).hover(
                        function() { $(this).prevAll().add(this).addClass("hoverChosen") },
                        function() { $(this).prevAll().add(this).removeClass("hoverChosen") }
                ).click(function() {
                            var observable = valueAccessor();  // Get the associated observable
                            observable(index+1);               // Write the new rating to it
                        });
            });
        },

        update: function(element, valueAccessor) {
            // Give the first x stars the "chosen" class, where x <= rating
            var observable = valueAccessor();
            $("span", element).each(function(index) {
                $(this).toggleClass("chosen", index < observable());
            });
        }
    };
    function Review(title, rating, user, date_published, info) {
        var self = this;
        self.title = title;
        self.rating = rating;
        self.user = user;
        self.date_published = date_published;
        self.info = info;
    }

    function ReviewViewModel() {
        var self = this;

        self.reviews = ko.observableArray([]);
        self.newReview = ko.observable();

        self.addReview = function(title, rating, user, date_published, info) {
            self.reviews.push(new Review(title, rating, user, "N/A", info));

        self.submit = function(){
            $.ajax('{% url app_info domain %}', {
                type: 'post',
                data: { data: ko.toJSON(self.review)
            }
        }
        }
        $.ajax({
            type: owner._destroy ? 'delete' : 'post',
            url:
        }


    }
</script>
{% endblock %}

{% block breadcrumb %}
<li>{{ domain.copied_from.display_name }}</li>
{% endblock %}

{% block main_column %}

<div class="page-header">
        <h1>
            {{ domain.copied_from.display_name }}
            <small>by <a href="{% url orgs_landing domain.organization %}">{{ domain.organization_doc.title }}</a></small>
        </h1>
        <h3>
            Ratings: <span class="badge badge-info">{{ num_ratings }}</span>
        </h3>
            {% if average_rating %}
            <h3 class="rating">
                Average rating:
                <span>☆</span><span>☆</span><span>☆</span><span>☆</span><span>☆</span>
                {{ average_rating }}
            </h3>
            {% endif %}
        <h3>
            <a class="btn" href="{% url corehq.apps.app_manager.views.default domain.name %}">Preview</a>
        </h3>
</div>
<dl>
    <dt>{% trans 'Description' %}</dt>
    <dd>
        {% if domain.description %}
            {{ domain.description }}
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>Category</dt>
    <dd>
        {% if domain.project_type %}
            {{ domain.project_type }}
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>License</dt>
    <dd>{{ domain.get_license_display }}</dd>
    <dt>{% trans 'Applications' %}</dt>
    <dd>
        {% if domain.applications|length > 0 %}
            <ul class="nav nav-pills">
                {% for app in domain.applications %}
                <li><a href="{% url corehq.apps.app_manager.views.view_app domain app.id %}">{{ app.name }}</a></li>
                {% endfor %}
            </ul>
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>{% trans 'Languages' %}</dt>
    <dd>
        {% if domain.languages %}
            {{ domain.readable_languages }}
        {% else %}
            None
        {% endif %}
    </dd>
    {% for field in fields %}
    <dt>{{ field.label }}</dt>
    <dd>
        {{ field.value }}
    </dd>
    {% endfor %}
    <dt>
        Copy this snapshot into a new project
    </dt>
    <dd>
        <form class="form-inline" method="post" action="{% url domain_copy_snapshot domain %}">
            <fieldset>
                <div class="control-group{% if error_message %} error{% endif %}">
                    <input type="text" class="span3" id="new_domain_name"
                           name="new_domain_name" value="{{ new_domain_name }}" placeholder="{% trans 'New project name' %}">
                    {% if error_message %}
                    <span class="help-inline">{{ error_message }}</span>
                    {% endif %}
                    <button type="submit" class="btn btn-primary">Create New Project</button>
                </div>
            </fieldset>
        </form>
    </dd>
</dl>

<hr/>
        <div>
            <div>
                <form action="{% url app_info domain=domain.name %}" method="post">
                    {% if versioned %}
                    <input type="hidden" name="versioned" value="">
                    {% else %}
                    <input type="hidden" name="versioned" value="1">
                    {% endif %}
                    <button type="submit" class="btn btn-primary">{% if versioned %} View all reviews {% else %} Only view reviews from current version{% endif %}</button>
                </form>
            </div>
            <br/><br/>
            <div><h3>Reviews for {% if versioned %} the current version of {% endif %} {{ domain.copied_from.display_name }}</h3></div>
            <br/>
            <div><a href="#add_review_modal" data-toggle="modal" class="btn btn-danger">Write a Review</a></div>
        </div>
        {% for review in reviews %}
        <hr/>
        <h4>{{ review.title }}</h4>
        <div class="rating">
        <span>☆</span><span>☆</span><span>☆</span><span>☆</span><span>☆</span>
        </div>​
        <div><p>{{ review.rating }} <small> by {{ review.nickname }} on {{ review.date_published }}</small></p></div>
        <div>{{ review.info }}</div>

        {% endfor %}

{% endblock %}





{% block modals %}{{ block.super }}
<div id="add_review_modal" class="modal hide fade">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">&times;</a>
        <h3>Write a review for {{ domain.name }}</h3>
    </div>
    <form class="form-horizontal" method="post" action="{% url app_info domain %}">
        <div class="modal-body">
            <fieldset>
                {% bootstrap_form_errors form %}
                {% bootstrap_fieldset form "Review this App" %}
            </fieldset>
            <input type="hidden" name="versioned" value="{{ versioned }}">
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Cancel</a>
            <button type="submit" class="btn btn-primary">Post</button>
        </div>
    </form>
</div>
{% endblock %}