{% extends "appstore/appstore_base.html" %}
{% load hq_shared_tags %}
{% load hq_bootstrap_tags %}
{% load i18n %}

{% block js-inline %}{{ block.super }}
<style type="text/css">
.rating_static > span {
display: inline-block;
position: relative;
width: 1.1em;
}

    /* :not(:checked) is a filter, so that browsers that don’t support :checked don’t
follow these rules. Every browser that supports :checked also supports :not(), so
it doesn’t make the test unnecessarily selective */
.rating_static:not(:checked) > input {
    position:absolute;
    top:-9999px;
    clip:rect(0,0,0,0);
}

.rating_static:not(:checked) > label {
    float:right;
    width:1em;
    padding:0 .1em;
    overflow:hidden;
    white-space:nowrap;
    cursor:pointer;
    font-size:200%;
    line-height:1.2;
    color:#ddd;
    text-shadow:1px 1px #bbb, 2px 2px #666, .1em .1em .2em rgba(0,0,0,.5);
}

.rating_static:not(:checked) > label:before {
    content: '★ ';
}

.rating_static > input:checked ~ label {
    color: #f70;
    text-shadow:1px 1px #c60, 2px 2px #940, .1em .1em .2em rgba(0,0,0,.5);
}

.rating_static > label:active {
    position:relative;
    top:2px;
    left:2px;
}


.rating > span {
    display: inline-block;
    position: relative;
    width: 1.1em;
}
.rating {
    float:left;
}

    /* :not(:checked) is a filter, so that browsers that don’t support :checked don’t
follow these rules. Every browser that supports :checked also supports :not(), so
it doesn’t make the test unnecessarily selective */
.rating:not(:checked) > input {
    position:absolute;
    top:-9999px;
    clip:rect(0,0,0,0);
}

.rating:not(:checked) > label {
    float:right;
    width:1em;
    padding:0 .1em;
    overflow:hidden;
    white-space:nowrap;
    cursor:pointer;
    font-size:200%;
    line-height:1.2;
    color:#ddd;
    text-shadow:1px 1px #bbb, 2px 2px #666, .1em .1em .2em rgba(0,0,0,.5);
}

.rating:not(:checked) > label:before {
    content: '★ ';
}

.rating > input:checked ~ label {
    color: #f70;
    text-shadow:1px 1px #c60, 2px 2px #940, .1em .1em .2em rgba(0,0,0,.5);
}

.rating:not(:checked) > label:hover,
.rating:not(:checked) > label:hover ~ label {
    color: gold;
    text-shadow:1px 1px goldenrod, 2px 2px #B57340, .1em .1em .2em rgba(0,0,0,.5);
}

.rating > input:checked + label:hover,
.rating > input:checked + label:hover ~ label,
.rating > input:checked ~ label:hover,
.rating > input:checked ~ label:hover ~ label,
.rating > label:hover ~ input:checked ~ label {
    color: #ea0;
    text-shadow:1px 1px goldenrod, 2px 2px #B57340, .1em .1em .2em rgba(0,0,0,.5);
}

.rating > label:active {
    position:relative;
    top:2px;
    left:2px;
}

.scrollable {
    overflow-x: scroll;
    overflow-y:hidden;
    white-space:nowrap;
    /*max-height: 300px;*/
}
</style>

<!--<script>
    ko.bindingHandlers.starRating = {
        init: function(element, valueAccessor) {
            $(element).addClass("starRating");
            for (var i = 0; i < 5; i++)
                $("<span>").appendTo(element);

            // Handle mouse events on the stars
            $("span", element).each(function(index) {
                $(this).hover(
                        function() { $(this).prevAll().add(this).addClass("hoverChosen") },
                        function() { $(this).prevAll().add(this).removeClass("hoverChosen") }
                ).click(function() {
                            var observable = valueAccessor();  // Get the associated observable
                            observable(index+1);               // Write the new rating to it
                        });
            });
        },

        update: function(element, valueAccessor) {
            // Give the first x stars the "chosen" class, where x <= rating
            var observable = valueAccessor();
            $("span", element).each(function(index) {
                $(this).toggleClass("chosen", index < observable());
            });
        }
    };
    function Review(title, rating, user, date_published, info) {
        var self = this;
        self.title = title;
        self.rating = rating;
        self.user = user;
        self.date_published = date_published;
        self.info = info;
    }

    function ReviewViewModel() {
        var self = this;

        self.reviews = ko.observableArray([]);
        self.newReview = ko.observable();

        self.addReview = function(title, rating, user, date_published, info) {
            self.reviews.push(new Review(title, rating, user, date_published, info));

        self.submit = function(){
            $.ajax('{% url project_info project %}', {
                type: 'post',
                data: { data: ko.toJSON(self.review) }
            });
        }
        $.ajax({
            type: owner._destroy ? 'delete' : 'post',
            url:
        });


    }
</script>-->
{% endblock %}

{% block breadcrumb %}
<li>{{ project.copied_from.display_name }}</li>
{% endblock %}

{% block main_column %}

<div class="page-header">
        <h1>
            {{ project.copied_from.display_name }}
            <small>by <a href="{% url orgs_landing project.organization %}">{{ project.organization_doc.title }}</a></small>
        </h1>
    <h3>
        <a class="btn" href="{% url corehq.apps.app_manager.views.default project.name %}">Preview this project</a>
    </h3>
        <h3>
            Ratings: <span class="badge badge-info">{{ num_ratings }}</span>
        </h3>
            {% if average_rating %}
            <div class="span3">
                <fieldset class="rating_static" id="stars{{ average_rating }} ">
                    <input type="radio" id="star5{{ average_rating }}"  value="5" disabled=True {% if average_rating == 5 %} checked=True {% endif %} /><label for="star5{{ average_rating }}" title="Rocks!">5 stars</label>
                    <input type="radio" id="star4{{ average_rating }}"  value="4" disabled=True {% if average_rating == 4 %} checked=True {% endif %} /><label for="star4{{ average_rating }}" title="Pretty good">4 stars</label>
                    <input type="radio" id="star3{{ average_rating }}"  value="3" disabled=True {% if average_rating == 3 %} checked=True {% endif %} /><label for="star3{{ average_rating }}" title="Meh">3 stars</label>
                    <input type="radio" id="star2{{ average_rating }}"  value="2" disabled=True {% if average_rating == 2 %} checked=True {% endif %} /><label for="star2{{ average_rating }}" title="Kinda bad">2 stars</label>
                    <input type="radio" id="star1{{ average_rating }}"  value="1" disabled=True {% if average_rating == 1 %} checked=True {% endif %} /><label for="star1{{ average_rating }}" title="Sucks big time">1 star</label>
                </fieldset>
            </div>
            {% endif %}
            <div class="span1">
                <h3>
                    <a class="btn" href="{% url corehq.apps.app_manager.views.default project.name %}">Preview</a>
                </h3>
            </div>
    <br/>
</div>
<dl>
    <dt>{% trans 'Description' %}</dt>
    <dd>
        {% if project.description %}
            {{ project.description }}
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>Category</dt>
    <dd>
        {% if project.project_type %}
            {{ project.project_type }}
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>License</dt>
    <dd>{{ project.get_license_display }}</dd>
    <dt>{% trans 'Applications' %}</dt>
    <dd>
        {% if project.applications|length > 0 %}
            <ul class="nav nav-pills">
                {% for app in project.applications %}
                <li>
                    <a href="{% url app_summary project app.id %}">{{ app.name }}</a>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>{% trans 'Languages' %}</dt>
    <dd>
        {% if project.languages %}
            {{ project.readable_languages }}
        {% else %}
            None
        {% endif %}
    </dd>
    <dt>{% trans 'Download count' %}</dt>
    <dd>
        This version: {{ project.copies|length }};
        All versions: {{ project.copies_of_parent|length }}
    </dd>
 </dl>
 <div>
     <h3>Media</h3>
     <ul class="scrollable">
         {% for image in images %}
            <a href="{{ image }}" class="thumbnail" target="_blank"><img src="{{ image }}" style="max-width: 220px;" /></a>
         {% endfor %}
     </ul>
     <ul class="thumbnails">
         {% for a in audio %}
         <li class="span1">
             <a href="{{ a }}" class="btn btn-primary" target="_blank">Listen in a new window</a>
         </li>
         {% endfor %}
     </ul>

 </div>
        <div>
            <form action="{% url copy_snapshot_app project.name %}" method="post">
                <fieldset>
                    <legend>Download individual application into existing project</legend>
                    <label for="app_to_copy_select">
                        Application to download
                    </label>
                    <select name="app_id" id="app_to_copy_select">
                        {% for app in project.applications %}
                        <option value="{{ app.id }}">{{ app.name }}</option>
                        {% endfor %}
                    </select>
                    <label for="project_select">
                        Destination project
                    </label>
                    <select name="project" id="project_select">
                        {% for p in request.couch_user.projects %}
                        <option value="{{ p.name }}">{{ p.display_name }}</option>
                        {% endfor %}
                    </select>
                </fieldset>
                <button class="btn btn-primary" type="submit">Download application</button>
            </form>
            <form method="post" action="{% url domain_copy_snapshot project %}">
                <fieldset>
                    <legend>Download entire project into new project</legend>
                    <div{% if error_message %} class="error"{% endif %}>
                        <input type="text" class="span3" id="new_project_name"
                               name="new_project_name" value="{{ new_project_name }}" placeholder="{% trans 'New project name' %}">
                        {% if error_message %}
                        <span class="help-inline">{{ error_message }}</span>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary">Create New Project</button>
                </fieldset>
            </form>
        </div>

<hr/>
        <div>
            <div>
                <form action="{% url project_info project %}" method="post">
                    {% if versioned %}
                    <input type="hidden" name="versioned" value="">
                    {% else %}
                    <input type="hidden" name="versioned" value="1">
                    {% endif %}
                </form>
            </div>
            <div><h3>Reviews for {% if versioned %} the current version of {% endif %} {{ project.copied_from.display_name }}</h3></div>
            <br/>
            <div>
                <a href="#add_review_modal" data-toggle="modal" class="btn btn-danger">Write a Review</a>
                <a href="?all={{ all_link }}" class="btn btn-primary">{% if versioned %} View all reviews {% else %} Only show reviews from current version{% endif %}</a>
            </div>
        </div>
        {% for review in reviews %}
        <hr/>
        <div class="row">
            <div class="span1">
                <h4 style="padding-left:25px">{{ forloop.counter }})</h4>
            </div>
            <div class="span6">
        <h4>{{ review.title }}</h4>
        <div>
            <p><small> on {{ review.date_published }}</small></p>
            <fieldset class="rating_static" id="stars{{ review.get_id }}">
                <input type="radio" id="star5{{ review.get_id }}" value="5" disabled=True {% if review.rating == 5 %} checked=True {% endif %}/><label for="star5{{ review.get_id }}" title="Rocks!">5 stars</label>
                <input type="radio" id="star4{{ review.get_id }}" value="4" disabled=True {% if review.rating == 4 %} checked=True {% endif %}/><label for="star4{{ review.get_id }}" title="Pretty Good">4 stars</label>
                <input type="radio" id="star3{{ review.get_id }}" value="3" disabled=True {% if review.rating == 3 %} checked=True {% endif %}/><label for="star3{{ review.get_id }}" title="Meh">3 stars</label>
                <input type="radio" id="star2{{ review.get_id }}" value="2" disabled=True {% if review.rating == 2 %} checked=True {% endif %}/><label for="star2{{ review.get_id }}" title="Kinda Bad">2 stars</label>
                <input type="radio" id="star1{{ review.get_id }}" value="1" disabled=True {% if review.rating == 1 %} checked=True {% endif %}/><label for="star1{{ review.get_id }}" title="Sucks Big Time">1 stars</label>
            </fieldset>

        </div>
        <div>{{ review.info }}</div>
            </div>
        </div>
        {% endfor %}

{% endblock %}





{% block modals %}{{ block.super }}
<div id="add_review_modal" class="modal hide fade">
    <div class="modal-header">
        <a class="close" data-dismiss="modal">&times;</a>
        <h3>Write a review for {{ project.copied_from.display_name }}</h3>
    </div>
    <form class="form-horizontal" method="post" action="{% url project_info project %}">
        <div class="modal-body">
            <fieldset>
                <legend>Review This App</legend>
                {% for global_error in form.non_field_errors %}
                <div class="alert alert-error">
                    {{ global_error }}
                </div>
                {% endfor %}
                <div class="control-group">
                    <label class="control-label">Rating</label>
                    <div class="controls">
                        <fieldset class="rating" title="Rating">
                            <input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="Rocks!">5 stars</label>
                            <input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="Pretty good">4 stars</label>
                            <input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="Meh">3 stars</label>
                            <input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="Kinda bad">2 stars</label>
                            <input type="radio" id="star1" name="rating" value="1" checked=True /><label for="star1" title="Sucks big time">1 star</label>
                        </fieldset>
                    </div>
                </div>
                {% for field in form.visible_fields %}
                <div class="control-group{% if field.errors %} error{% endif %}">
                    <label class="control-label" for="{{ field.id }}">{{ field.label }}</label>
                    <div class="controls">
                        {{ field }}
                        <span class="help-inline"></span>
                        {% for error in field.errors %}
                        <span class="help-inline">{{ error }}</span>
                        {% endfor %}
                        {% if field.help_text %}
                        <p class="help-block">
                            {{ field.help_text }}
                        </p>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </fieldset>
            <input type="hidden" name="versioned" value="{{ versioned }}">
        </div>
        <div class="modal-footer">
            <a href="#" data-dismiss="modal" class="btn">Cancel</a>
            <button type="submit" class="btn btn-primary">Post</button>
        </div>
    </form>
</div>
{% endblock %}