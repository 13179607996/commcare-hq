{% extends "users/users_base.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
    <script src="{% static 'users/js/key_filters.js' %}"></script>
    <script src="{% static 'locations/ko/location_tree.async.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
    <script type="text/javascript">

var LOAD_LOCS_URL = '{{ api_root }}';

$(function() {

  var model = new LocationTreeViewModel();
  ko.applyBindings(model, $('#location_tree')[0]);
  model.load();

});

    </script>
{% endblock %}

{% block subsection-title %}
    <li class="active">
        <a href="#">Locations</a>
    </li>
{% endblock %}

{% block user-view %}
<header>
    <div class="row-fluid">
        <div class="span8">
            <h2>Manage Locations</h2>
        </div>
    </div>
</header>
<div>

    <div class="row-fluid">
        <div class="span12">
            <div class="btn-toolbar">
                <a class="btn" href="{% url upload_commcare_users domain %}">Bulk Import</a>
                <a class="btn" href="{% url upload_commcare_users domain %}">Bulk Export</a>
            </div>
        </div>
    </div>

    <style>

#location_tree {
  margin-left: -2em;
  width: 500px;
}

.loc_children {
  margin-left: 2em;
  margin-bottom: 1.5em;
}

.loc_child {
  margin-top: .5em;
}

.loc_name {
  font-size: 110%;
  font-weight: bold;
}

.loc_type {
  color: #777;
  font-variant: small-caps;
  font-weight: bold;
}

.no_children {
  font-style: italic;
}

.loc_edit {
  float: right;
}

.loc_header {
  padding: 2px;
}

.loc_header:hover {
  background-color: #eef;
}

.loc_header_text {
  cursor: pointer;
}

    </style>

    <script type="text/html" id="location-template">

      <!-- header bar -->
      <div class="loc_header" data-bind="if: name() != '_root'">
        <a class="loc_edit btn btn-primary" href="http://google.com">Edit</a>
        <span class="loc_header_text" data-bind="click: toggle"> <!-- want to make entire row clickable, but overrides click on 'edit' button -->
          <span data-bind="if: can_have_children"><a class="label" data-bind="css: { 'icon-plus': !expanded(), 'icon-minus': expanded() }"></a></span>
          <span class="loc_name" data-bind="text: name"></span> <span class="loc_type">(<span data-bind="text: type"></span>)</span>
        </span>
        <div style="clear: both;"></div>
      </div>

      <!-- child content -->
      <div class="loc_children" data-bind="visible: expanded">

        <!-- loader bar -->
        <div class="loc_child" data-bind="visible: children_status() == 'loading'">
          <img src="{% static 'hqwebapp/img/ajax-loader.gif' %}" alt="loading indicator" /> Loading&hellip;
        </div>

        <div data-bind="fadeVisible: children_status() == 'loaded'">

          <!-- child entries -->
          <div data-bind="foreach: children">
            <div class="loc_child" data-bind="template: { name: 'location-template' }"></div>
          </div>

          <!-- no children message -->
          <div class="loc_child no_children" data-bind="visible: children_status() == 'loaded' && children().length == 0, text: (name() == '_root' ? 'No locations created in this project yet' : 'No sub-locations inside ' + name())"></div>

        </div>

        <!-- create child button -->
        <a class="btn btn-success loc_child" href="#"><i class="icon icon-white icon-plus"></i> New location <span data-bind="text: (name() == '_root' ? 'at top level' : 'in ' + name())"></span></a>

      </div>

    </script>

    <div id="location_tree">
      <div data-bind="template: { name: 'location-template', if: root, data: root }"></div>
    </div>

</div>
{% endblock %}

{% block modals %}{{ block.super }}
    
{% endblock %}
