{% extends "reminders/reminders_base.html" %}

{% block head %}{{ block.super }}
<style type="text/css">
    input.day_input {
        width: 50px;
    }
    input.time_input {
        width: 50px;
    }
    input.timeouts_input {
        width: 100px;
    }
    input.language_input {
        width: 50px;
    }
    input.message_input {
        width: 300px;
    }
    h2 {
        border-bottom: 1px solid #555;
    }
    #id_max_iteration_count_input {
        width: 50px;
    }
    #id_schedule_length {
        width: 50px;
    }
    .errorlist ul {
        margin: 0;
        padding: 0;
    }
    .errorlist li {
        background-color: #F88;
        border: 1px solid #A44;
        padding: 2px;
    }
    div.clickable {
        cursor: pointer;
        font-family: "Courier New";
    }
    span.clickable {
        cursor: pointer;
        font-family: "Courier New";
    }
</style>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
    function create_text_input(class_name) {
        var node = document.createElement("INPUT");
        node.setAttribute("type", "text");
        node.setAttribute("class", class_name);
        return node;
    }    
    
    function create_new_row() {
        var tr = document.createElement("TR");
        
        var td1 = document.createElement("TD");
        td1.appendChild(create_text_input("day_input"));
        
        var td2 = document.createElement("TD");
        td2.appendChild(create_text_input("time_input"));
        
        var td3 = document.createElement("TD");
        td3.appendChild(create_message());
        
        var td4 = document.createElement("TD");
        td4.appendChild(create_text_input("timeouts_input"));
        
        var td5 = document.createElement("TD");
        var div2 = document.createElement("DIV");
        div2.setAttribute("class","clickable");
        div2.innerHTML = "[-]";
        td5.appendChild(div2);
        td5.onclick = function() { delete_row(this); };
        
        var td6 = document.createElement("TD");
        var div3 = document.createElement("DIV");
        div3.setAttribute("class","clickable");
        div3.innerHTML = "[+]";
        td6.appendChild(div3);
        td6.onclick = function() { add_row(this); };
        
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        tr.appendChild(td5);
        tr.appendChild(td6);
        return tr;
    }    
    
    function add_row(cell_ref) {
        new_row = create_new_row();
        table_ref = cell_ref.parentNode.parentNode;
        try {
            // Try to add the new row before the next sibling
            next_row = cell_ref.parentNode.nextSibling;
            table_ref.insertBefore(new_row, next_row);
        } catch(e) {
            // If there's no nextSibling, add to the end of the table
            table_ref.appendChild(new_row);
        }
        order_rows(table_ref);
    }
    
    function delete_row(cell_ref) {
        row_ref = cell_ref.parentNode;
        table_ref = row_ref.parentNode;
        table_ref.removeChild(row_ref);
        order_rows(table_ref);
    }
    
    function order_rows(table_ref) {
        row_num = 0;
        for(i = 0; i < table_ref.childNodes.length; i++) {
            child = table_ref.childNodes[i];
            tag_name = child.tagName;
            if(typeof(tag_name) == "string" && tag_name.toUpperCase() == "TR") {
                if(row_num > 0) {
                    set_row_num(child, row_num);
                }
                row_num++;
            }
        }
    }
    
    function set_row_num(row_ref, row_num) {
        col_num = 0;
        for(j = 0; j < row_ref.childNodes.length; j++) {
            element = row_ref.childNodes[j];
            element_tag_name = element.tagName;
            if(typeof(element_tag_name) == "string" && element_tag_name.toUpperCase() == "TD") {
                col_num++;
                inputs = element.getElementsByTagName("INPUT");
                if(col_num == 1) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".day");
                } else if(col_num == 2) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".time");
                } else if(col_num == 3) {
                    divs = element.getElementsByTagName("DIV");
                    for(k = 0; k < divs.length; k++) {
                        inputs = divs[k].getElementsByTagName("INPUT");
                        for(l = 0; l < inputs.length; l++) {
                            if(inputs[l].getAttribute("class") == "language_input") {
                                inputs[l].setAttribute("name","reminder_events." + row_num + ".messages." + (k + 1) + ".language");
                            } else {
                                inputs[l].setAttribute("name","reminder_events." + row_num + ".messages." + (k + 1) + ".text");
                            }
                        }
                    }
                } else if(col_num == 4) {
                    inputs[0].setAttribute("name","reminder_events." + row_num + ".timeouts");
                }
            }
        }
    }
    
    function create_message() {
        div = document.createElement("DIV");
        input1 = create_text_input("language_input");
        input2 = create_text_input("message_input");
        span1 = document.createElement("SPAN");
        span1.setAttribute("class", "clickable");
        span1.onclick = function() { delete_message(this); }
        span1.innerHTML = "[-]";
        span2 = document.createElement("SPAN");
        span2.setAttribute("class", "clickable");
        span2.onclick = function() { add_message(this); }
        span2.innerHTML = "[+]";
        div.appendChild(input1);
        div.appendChild(input2);
        div.appendChild(span1);
        div.appendChild(span2);
        return div;
    }
    
    function add_message(span_ref) {
        div_ref = span_ref.parentNode;
        td_ref = div_ref.parentNode;
        td_ref.appendChild(create_message());
        order_rows(td_ref.parentNode.parentNode);
    }
    
    function delete_message(span_ref) {
        div_ref = span_ref.parentNode;
        td_ref = div_ref.parentNode;
        if(td_ref.getElementsByTagName("DIV").length == 1) {
            alert("You must specify a message in at least one language.");
        } else {
            td_ref.removeChild(div_ref);
            order_rows(td_ref.parentNode.parentNode);
        }
    }
</script>
{% endblock %}

{% block reminders_content %}
<form action="" method="post">
    <br />
    <h2>Rule</h2>
    <table>
        <tr><th></th><td>{{ form.nickname.errors }}</td></tr>
        <tr><th>{{ form.nickname.label_tag }}    </th><td>{{ form.nickname }}</td></tr>
        <tr><th></th><td>{{ form.case_type.errors }}</td></tr>
        <tr><th>{{ form.case_type.label_tag }}   </th><td>{{ form.case_type }}</td></tr>
        <tr><th></th><td>{{ form.method.errors }}</td></tr>
        <tr><th>{{ form.method.label_tag }}      </th><td>{{ form.method }}</td></tr>
        <tr><th></th><td>{{ form.start.errors }}</td></tr>
        <tr><th>{{ form.start.label_tag }}       </th><td>{{ form.start }}</td></tr>
        <tr><th></th><td>{{ form.start_offset.errors }}</td></tr>
        <tr><th>{{ form.start_offset.label_tag }}</th><td>{{ form.start_offset }}</td></tr>
        <tr><th></th><td>{{ form.until.errors }}</td></tr>
        <tr><th>{{ form.until.label_tag }}       </th><td>{{ form.until }}</td></tr>
        <tr><th></th><td>{{ form.default_lang.errors }}</td></tr>
        <tr><th>{{ form.default_lang.label_tag }}</th><td>{{ form.default_lang }}</td></tr>
    </table>
    <br />
    <h2>Schedule</h2>
    <br />
    <div>
        The following reminder schedule should be repeated: <br /><br />
        <input type="radio" name="iteration_type" value="INDEFINITE" {%if form.iteration_type.value != "FIXED" %}checked{% endif %} />Until the above "Until" condition is met.<br />
        {{ form.max_iteration_count.errors }}
        <input type="radio" name="iteration_type" value="FIXED" {%if form.iteration_type.value == "FIXED" %}checked{% endif %} />{{ form.max_iteration_count_input }} times, or until the above "Until" condition is met, whichever comes first.<br />
    </div>
    <br />
    <div>
        The day and time for each event in the reminder schedule below are: <br /><br />
        <input type="radio" name="event_interpretation" value="OFFSET" onClick="document.getElementById('schedule_length_description').innerHTML = 'The number of days between the end of a schedule cycle and the start of a new schedule cycle is:';" {%if form.event_interpretation.value != "SCHEDULE" %}checked{% endif %} />The number of days to wait and the time to wait before sending the given message.<br />
        <input type="radio" name="event_interpretation" value="SCHEDULE" onClick="document.getElementById('schedule_length_description').innerHTML = 'The total number of days for a single schedule cycle is:';" {%if form.event_interpretation.value == "SCHEDULE" %}checked{% endif %} />The day number in the schedule cycle and the exact time of day to send the given message.
    </div>
    <br />
    {{ form.events.errors }}
    <table>
        <tr>
            <th>Day</th>
            <th>Time</th>
            <th>Language : Message</th>
            <th>Callback Timeouts</th>
            <th></th>
            <th onClick="add_row(this);"><div class="clickable">[+]</div></th>
        </tr>
        {% for e in form.events.value %}
        <tr>
            <td><input type="text" class="day_input" name="reminder_events.{{ forloop.counter }}.day" value="{{ e.day }}" /></td>
            <td><input type="text" class="time_input" name="reminder_events.{{ forloop.counter }}.time" value="{{ e.time }}" /></td>
            <td>
                {% for message_num, message in e.messages.items %}
                <div>
                    <input type="text" class="language_input" name="reminder_events.{{ forloop.parentloop.counter }}.messages.{{ forloop.counter }}.language" value="{{ message.language }}" /><input type="text" class="message_input" name="reminder_events.{{ forloop.parentloop.counter }}.messages.{{ forloop.counter }}.text" value="{{ message.text }}" /><span class="clickable" onClick="delete_message(this);">[-]</span><span class="clickable" onClick="add_message(this);">[+]</span>
                </div>
                {% endfor %}
            </td>
            <td><input type="text" class="timeouts_input" name="reminder_events.{{ forloop.counter }}.timeouts" value="{{ e.timeouts }}" /></td>
            <td onClick="delete_row(this);"><div class="clickable">[-]</div></td>
            <td onClick="add_row(this);"><div class="clickable">[+]</div></td>
        </tr>
        {% empty %}
        <tr>
            <td><input type="text" class="day_input" name="reminder_events.1.day" /></td>
            <td><input type="text" class="time_input" name="reminder_events.1.time" /></td>
            <td>
                <div>
                    <input type="text" class="language_input" name="reminder_events.1.messages.1.language" /><input type="text" class="message_input" name="reminder_events.1.messages.1.text" /><span class="clickable" onClick="delete_message(this);">[-]</span><span class="clickable" onClick="add_message(this);">[+]</span>
                </div>
            </td>
            <td><input type="text" class="timeouts_input" name="reminder_events.1.timeouts" /></td>
            <td onClick="delete_row(this);"><div class="clickable">[-]</div></td>
            <td onClick="add_row(this);"><div class="clickable">[+]</div></td>
        </tr>
        {% endfor %}
    </table>
    <div>
        {{ form.schedule_length.errors }}
        <label id="schedule_length_description">
        {%if form.event_interpretation.value != "SCHEDULE" %}
        The number of days between the end of a schedule cycle and the start of a new schedule cycle is:
        {% else %}
        The total number of days for a single schedule cycle is:
        {% endif %}
        </label>
        {{ form.schedule_length }}
    </div>
    <br />
    <input type="Submit" value="Save" />
</form>
{% endblock %}
