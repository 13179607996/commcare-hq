{% extends "hqwebapp/centered.html" %}
{% load hq_shared_tags %}

{% block title %}Bulk Upload of Multimedia{% endblock title %}

{% block js %} {{ block.super }}
    <script type="text/javascript" src="http://yui.yahooapis.com/combo?3.4.1/build/yui-base/yui-base-min.js&3.4.1/build/oop/oop-min.js&3.4.1/build/event-custom-base/event-custom-base-min.js&3.4.1/build/event-custom-complex/event-custom-complex-min.js&3.4.1/build/features/features-min.js&3.4.1/build/dom-core/dom-core-min.js&3.4.1/build/dom-base/dom-base-min.js&3.4.1/build/selector-native/selector-native-min.js&3.4.1/build/selector/selector-min.js&3.4.1/build/node-core/node-core-min.js&3.4.1/build/node-base/node-base-min.js&3.4.1/build/event-base/event-base-min.js&3.4.1/build/event-delegate/event-delegate-min.js&3.4.1/build/node-event-delegate/node-event-delegate-min.js&3.4.1/build/pluginhost-base/pluginhost-base-min.js&3.4.1/build/pluginhost-config/pluginhost-config-min.js&3.4.1/build/node-pluginhost/node-pluginhost-min.js&3.4.1/build/dom-style/dom-style-min.js&3.4.1/build/dom-screen/dom-screen-min.js&3.4.1/build/node-screen/node-screen-min.js&3.4.1/build/node-style/node-style-min.js&3.4.1/build/attribute-base/attribute-base-min.js&3.4.1/build/base-base/base-base-min.js&3.4.1/build/base-pluginhost/base-pluginhost-min.js&3.4.1/build/base-build/base-build-min.js&3.4.1/build/swfdetect/swfdetect-min.js&3.4.1/build/escape/escape-min.js&3.4.1/build/swf/swf-min.js&3.4.1/build/uploader/uploader-min.js"></script>
    <script type="text/javascript" src="{% static 'hqmedia/js/hqmedia_uploader.js' %}"></script>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script type="text/javascript">
        $(function() {

            var uploader = new HQMediaUploader({
                fileFilters: new Array({description:"Zip", extensions:"*.zip"},
                        {description:"Images", extensions:"*.jpg;*.png;*.gif"},
                        {description:"Audio", extensions:"*.mp3"}),
                uploadURL: '{{ DNS_name }}{% url hqmedia_handle_uploaded domain app.get_id %}',
                onSuccess: showUploadStats
            });
            uploader.render();

            function showUploadStats (event, resp) {
                console.log(resp);
                var $currentMedia = $('#hqmedia_'+event.id);
                if (resp.zip) {
                    // Handle Zip File Response
                    if ($.isEmptyObject(resp.images) && $.isEmptyObject(resp.audio)) {
                        $currentMedia.find('.match_status').html($('<span class="label label-important" />').text("No Matches Found"));
                    } else {
                        $currentMedia.find('.match_status').html($('<span class="label label-success" />').text("Matches Found"));
                        var $imageList = createMatchList(resp.images),
                            $audioList = createMatchList(resp.audio),
                           $detailList = $currentMedia.find('.details');
                        if (!$.isEmptyObject(resp.images)) {
                            $detailList.append($('<h4 />').text("Matched Images"));
                            $detailList.append($imageList);
                        }
                        if (!$.isEmptyObject(resp.audio)) {
                            $detailList.append($('<h4 />').text("Matched Audio"));
                            $detailList.append($audioList);
                        }
                    }
                } else if (resp.file) {
                    if (!$.isEmptyObject(resp.image)) {
                        $currentMedia.find('.match_status').html($('<span class="label label-success" />').text("Image Match Found"));
                        $currentMedia.find('.details').append(createMatchList(new Array(resp.image)));
                    } else if (!$.isEmptyObject(resp.audio)) {
                        $currentMedia.find('.match_status').html($('<span class="label label-success" />').text("Audio Match Found"));
                        $currentMedia.find('.details').append(createMatchList(new Array(resp.audio), true));
                    } else {
                        $currentMedia.find('.match_status').html($('<span class="label label-important" />').text("No Match Found"));
                    }
                }
            }

            function createMatchList (matches, is_audio) {
                var $list = $('<dl style="margin: 5px 0 0;" />');
                for (var i in matches) {
                    var $name = $('<dt />'),
                         $val = $('<dd />'),
                        $view = $('<a style="margin-bottom:6px;" target="_blank" class="btn btn-info btn-mini" />');
                    $view.text('preview');
                    if (is_audio) {
                        $view.popover({title: 'Click to open in new tab',
                            content: 'Audio not currently available for on-the-fly preview.',
                            placement: 'bottom'});
                    } else {
                        $view.popover({title: 'Click to open in new tab',
                                       content: '<img src="'+matches[i].url+'" alt="'+matches[i].app_path+'" />',
                                       placement: 'bottom'});
                    }
                    $view.attr('href', matches[i].url);
                    $name.text(matches[i].upload_path);
                    $val.text(matches[i].app_path);
                    $val.append($('<br />'));
                    $val.append($view);
                    $list.append($name);
                    $list.append($val);
                }
                return $list;
            }

        });
    </script>
{% endblock %}

{% block centered-content %}
    <div class="page-header">
        <h1>Multimedia Bulk Upload</h1>
    </div>
    <div class="btn-toolbar">
        <div id="hqmedia-uploader-overlay" style="position:absolute; z-index:2"></div>
        <a id="hqmedia-select-button" class="btn btn-primary" href="#" style="z-index:1;">Select Files</a>
        <a id="hqmedia-upload-button" href="#" class="btn btn-success">Upload Files</a>
    </div>
    <table id="hqmedia-queue" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th class="span2">Filename</th>
                <th class="span2">File Size</th>
                <th class="span2">Upload Progress</th>
                <th class="span2">Match Status</th>
                <th class="span4">Details</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
{% endblock centered-content %}