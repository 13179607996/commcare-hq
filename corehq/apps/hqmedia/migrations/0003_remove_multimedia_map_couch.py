# -*- coding: utf-8 -*-
# Generated by Django 1.11.22 on 2019-11-16 17:38
from django.db import migrations, models

from corehq.apps.app_manager.dbaccessors import wrap_app
from corehq.apps.app_manager.models import Application, LinkedApplication
from corehq.apps.hqmedia.dbaccessors import migrate_multimedia_map
from corehq.apps.hqmedia.models import ApplicationMediaMapping
from corehq.dbaccessors.couchapps.all_docs import (
    get_deleted_doc_ids_by_class,
    get_doc_ids_by_class,
)
from corehq.util.couch import DocUpdate, iter_update
from corehq.util.django_migrations import skip_on_fresh_install
from corehq.util.log import with_progress_bar


@skip_on_fresh_install
def _remove_couch_multimedia_map(apps, schema_editor):
    app_ids = (get_doc_ids_by_class(Application)
               + get_doc_ids_by_class(LinkedApplication)
               + get_deleted_doc_ids_by_class(Application)
               + get_deleted_doc_ids_by_class(LinkedApplication))
    iter_update(Application.get_db(), _pop_multimedia_map, with_progress_bar(app_ids), chunksize=1)


def _pop_multimedia_map(app_doc):
    if app_doc.get('multimedia_map', {}):
        app_doc.pop('multimedia_map')
        return DocUpdate(app_doc)


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('hqmedia', '0002_assert_multimedia_map'),
    ]

    operations = [
        migrations.RunPython(_remove_couch_multimedia_map,
            reverse_code=migrations.RunPython.noop,
            elidable=True),
    ]
