{% extends base_template %}

{% block js-inline %}{{ block.super }}
    <script src="{{ STATIC_URL }}reports/javascripts/jquery.tablednd_0_5.js"></script>

    <script>
        $(function(){
            // style button
            $(".button").button();

            var update_order_input = function(){
                var orderStr = "";
                var rows = $("#field_select")[0].tBodies[0].rows;
                for (var i=0; i<rows.length; i++) {
                    var escid = rows[i].id.replace(/([ @#;&,.+*~\':"!^$[\]()=>|\/])/g,'\\$1');
                    if (escid && $("#"+escid+" .field_include")[0].checked) {
                        orderStr += rows[i].id+" ";
                    }
                }
                $("#order_input")[0].value = orderStr;

            };

            // select all/none
            $("#select_all").click(function() {
                $(".field_include").attr('checked', true);
                update_order_input();
            });
            $("#select_none").click(function() {
                $(".field_include").attr('checked', false);
                update_order_input();
            });

            $(".field_include").click(function(){
                update_order_input();
            });

            $('#field_select').tableDnD({
                onDragClass: "dragged",
                    onDrop: function(table, row) {
                        update_order_input();
                    }
            });

            update_order_input();
        });
    </script>
{% endblock %}
{% block js %}{{ block.super }}
    <script src="{{ STATIC_URL }}hqwebapp/js/dialogs.js"></script>
{% endblock %}

{% block head %}
    {{ block.super }}
    <style>
        p {
            padding: .5em 0 .5em 0;
        }
        th {
            text-align: left;
        }
        .delete_div {
            padding: 1em 0 .5em 0;
        }
        
        table.column_list {
            border: 1px solid #ccc;
            margin: auto;
            width: 100%;
        }
        input[type="text"] {
            width: 25em;
        }
        .dragged {
            background: lightgray;
        }
    </style>
{% endblock %}

{% block content %}
<div id="main_container">
    <div class="padded">
    <p><a href="{% url excel_export_data_report domain %}" class="backlink">Back to Export Home</a></p>
    <form method="post" {# action="{% url custom_export domain %}" #}>
        <input type="hidden" name="schema" value="{{ saved_export.schema_id }}" />
{#        <input type="hidden" name="table" value="{{ table_config.index }}" />#}
        <input type="hidden" name="order" id="order_input" value="" />
        <p><label for="name">Export Name: </label><input type="text" name="name" value="{{ saved_export.name }}" /></p>
        <p><label for="format">Default file type: </label>
           <select name="format" id="format" >
               <option value="csv"{% if saved_export.default_format == "csv"%} selected="selected"{% endif %}>CSV (Zip file)</option>
               <option value="xlsx"{% if saved_export.default_format == "xlsx"%} selected="selected"{% endif %}>Excel 2007</option>
               <option value="xls"{% if saved_export.default_format == "xls" %} selected="selected"{% endif %}>Excel (older versions)</option>
           </select>
        </p>
        <p><label for="include-errors">Include duplicates and other unprocessed forms?</label>
           <input type="checkbox" name="include-errors" value="include-errors" {% if saved_export.filter_function %}{% else %}checked="yes"{% endif %}/><br />
        </p>
    <p class="helptext">Choose the fields you want to export below. You can drag and drop fields to reorder them.  You can also rename fields, which will update the headers in the export file.</p>
    {% for table_config in table_configs %}
        <div class="padded">
        <table class="column_list" id="field_select">
            <tr class="nodrag nodrop">
                <th>Include this Field?<br>
                Select: <a href="#" id="select_all">all</a>, <a href="#" id="select_none">none</a></th>
                <th>Field</th>
                <th>Display</th>
            </tr>
    {% for columndef in table_config.column_configuration %}
            <tr id="{{ columndef.index }}">
                <td><input type="checkbox" class="field_include" name="{{ table_config.index }}_{{ columndef.index }}_val" {% if columndef.selected %}checked="yes"{% endif %}></input></td>
                <td>{{ columndef.index }}</td>
                <td><input name="{{ table_config.index }}_{{ columndef.index }}_display" type="text" value="{{ columndef.display }}" selected="selected" checked="true"></input></td>
            </tr>
    {% endfor %}
        </table>
        </div>
    {% endfor %}
    <input type="submit" value="{% if saved_export.get_id %}Save{% else %}Create{% endif %}" />
    <input type="button" onClick="location.href='{% url excel_export_data_report domain %}'" value='{% if saved_export.get_id %}Back{% else %}Cancel{% endif %}' class="button" />
    </form>
    {% if saved_export.get_id %}
    {% with saved_export as export %}
    <div class="delete_div">
    <a class="delete_link" href="#">Delete this 6export</a>
    {% include "reports/dialogs/delete_custom_export_dialog.html" %}
    </div>
    {% endwith %}
    {% endif %}
    </div>
</div>
{% endblock %}