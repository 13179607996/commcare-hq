{% extends base_template %}
{% block head %}
    {{ block.super }}
    {% include "imports/datatables.html" %}
    {% include "imports/flot.html" %}
    <script>
        jQuery.fn.dataTableExt.oSort['title-numeric-asc']  = function(a,b) {
            var x = a.match(/title="*(-?[0-9]+)/)[1];
            var y = b.match(/title="*(-?[0-9]+)/)[1];
            x = parseFloat( x );
            y = parseFloat( y );
            return ((x < y) ? -1 : ((x > y) ?  1 : 0));
        };
        jQuery.fn.dataTableExt.oSort['title-numeric-desc'] = function(a,b) {
            var x = a.match(/title="*(-?[0-9]+)/)[1];
            var y = b.match(/title="*(-?[0-9]+)/)[1];
            x = parseFloat( x );
            y = parseFloat( y );
            return ((x < y) ?  1 : ((x > y) ? -1 : 0));
        };
    </script>
    <script>
        $(function(){
            $("#report_select").val(location.pathname);
            $("#report_select").change(function(){
                location.href = $(this).val();
            });
        });
    </script>
    <script type="text/javascript">
        function shiftDates(days) {
            start = new Date($("#startdate").val());
            start.setDate(start.getDate() + days);
            end = new Date($("#enddate").val());
            end.setDate(end.getDate() + days);
            $("#startdate").datepicker('setDate', start);
            $("#enddate").datepicker('setDate', end);
            $("#paramSelectorForm").submit();
        }
		$(function() {
		    $('.date-picker').datepicker( {
		        changeMonth: true,
		        changeYear: true,
		        showButtonPanel: true,
		        dateFormat: 'yy-mm-dd',
                maxDate: '0',
                numberOfMonths: 2
		        /*onClose: function(dateText, inst) {
		            var month = $("#ui-datepicker-div .ui-datepicker-month :selected").val();
		            var year = $("#ui-datepicker-div .ui-datepicker-year :selected").val();
		            $(this).datepicker('setDate', new Date(year, month, 1));
		        }*/
		    });
            $('#startdate').change(function(){
                $("#enddate").datepicker('option', 'minDate', $('#startdate').val());
            }).trigger('change');
            $("#previous_date").click(function(e){
                e.preventDefault();
                shiftDates(-7);
            });
            $("#next_date").click(function(e){
                e.preventDefault();
                shiftDates(7);
            });
            $('.ajax_dialog').live('click', function(e){
//                e.preventDefault();
//                $.get($(this).attr('href'), function(data){
//                    var $data = $(data);
//                    $data.appendTo('body');
//                    $data.dialog();
//                });
            });
		});
    </script>
    <script type="text/javascript">
        // datatable configuration.
        function start_datatables(elem){
            if(!elem){
                elem = document;
            }
            $('.datatable', elem).each(function(){
                var params = {
                    "bJQueryUI": true
                },
                    sAjaxSource = $(this).data('source'),
                    aoColumns = [],
                    $columns = $(this).find('tr').first().find('th'),
                    i;

                if(sAjaxSource) {
                    params = {
                        "bJQueryUI": true,
                        "bServerSide": true,
                        "sAjaxSource": sAjaxSource,
                        "bSort": false,
                        "bFilter": false
                    };
                }
                for (i = 0; i < $columns.length; i += 1) {
                    var sortType = $($columns[i]).data('sort');
                    if (sortType) {
                        aoColumns.push({sType: sortType});
                    } else {
                        aoColumns.push(null);
                    }
                }
                params.aoColumns = aoColumns;
                $(this).dataTable(params);
            });
        }
        $(document).ready(function() {
            start_datatables();
        }); 
    </script>
    {% if show_users %}
        <script>
            $(function(){
                $("#individual_select").change(function(){
                    $(this).parent().submit();
                });

                $("#report-tabs").tabs({
                    cookie: {},
                    ajaxOptions: {
                        error: function( xhr, status, index, anchor ) {
                            $( anchor.hash ).html(
                                "Couldn't load this tab. We'll try to fix this as soon as possible. "
                            );
                        }
                    },
                    load: function(event, ui){
                        $.ui = ui;
                        start_datatables(ui.panel);

                    }
                }).removeClass('ui-corner-all ui-widget-content').addClass('ui-corner-bottom').css('padding', '0');
                $("#report-tabs ul").removeClass('ui-corner-all');
            });
        </script>
    {% endif %}
    {% if show_forms %}
    <script>
        $(function(){
            $("#form_select").change(function(){
                $(this).closest("form").submit();
            });
        });
    </script>
    {% endif %}    
    
    <style>
        .datatable {
            width: 100%;
        }
        #main_container {
            padding: 0;
        }
        #report_header {
            padding: 10px;
        }
        #paramSelectorForm p {
            padding: 5px 0 5px 0;
        }
    </style>
{% endblock %}
{% block content %}
    <div id="main_container">
        <div id="title-bar">
            <h1>Reports</h1>
            <select id="report_select">
                {% include "reports/partials/report_list.html" %}
            </select>
        </div>
        <div id="report_header">
            <div id="report-title">
                <h1>{{ report.name|default:"Unknown Report" }}</h1>
            </div>
            {% if show_dates or show_users or show_forms %}
            <form method="get" id="paramSelectorForm">
            {% if show_dates %}
                <p>Start Date: <input type="text" id="startdate" name="startdate" class="date-picker" value="{{ datespan.startdate_param }}">
                   End Date: <input type="text" id="enddate" name="enddate" class="date-picker" value="{{ datespan.enddate_param }}">
                   {# oddly enough, this is the only form that needs or has a submit button #}
                   <input type="submit" value="Go!" />
                </p>
                <p>
                    <a href="#" id="previous_date">Previous week</a> | <a href="#" id="next_date">Next Week</a>
                </p>
            {% endif %}
            {% if show_users %}
                <select id="individual_select" name="individual">
                    <option  value=''>All Individuals</option>
                    {% for user in users %}
                        <option {% if user.id == individual %}selected="true"{% endif %} value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
            {% endif %}
            {% if show_forms %}
                <p>
                <label for="form">Choose Form: </label>
                <select id="form_select" name="form">
                    {% if all_forms_selectable %}
                    <option  value=''>All Forms</option>
                    {% else %}
                    <option  value='' style="color:#777;">Select a Form</option>
                    {% endif %}
                    {% for form in forms %}
                        <option {% if form.xmlns == selected_form %}selected="true"{% endif %} value="{{ form.xmlns }}">{{ form.display }}</option>
                    {% endfor %}
                </select>
                </p>
            {% endif %}
                </form>
            {% endif %}
        </div>
        {% block reportcontent %}Your report goes here{% endblock %}
    </div>
{% endblock %}