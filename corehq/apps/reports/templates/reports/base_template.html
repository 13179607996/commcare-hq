{% extends "reports/standard/base_template.html" %}
{% load hq_shared_tags %}

{% block js %}{{ block.super }}
<script src="{% static 'reports/ko/saved_reports.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
    <script type="text/javascript">
        $(function() {
            var defaultConfig = {{ default_config|JSON }};
            {% if report.has_datespan %}
                defaultConfig.date_range = 'last7';
            {% endif %}
            
            $("#savedReports").reportConfigEditor({
                filterForm: $("#reportFilters"),
                items: {{ report_configs|JSON }},
                initialItemID: '{{ current_config_id }}',
                defaultItem: defaultConfig,
                saveUrl: '{% url add_report_config domain %}',
            });

            if ($("#reportFilters").hasClass('in')) {
                $("#reportFilters").css('overflow', 'visible');
            }

            $("#reportFilters").on('shown', function() {
                $(this).css('overflow', 'visible');
            });

            $("#reportFilters").on('hide', function() {
                $(this).css('overflow', 'hidden');
            });

            $('#email-enabled').tooltip({
                title: 'You can email a saved version of this report.'
            });
        });
    </script>
{% endblock %}

{% block subsection-navigation %}
<nav class="hq-subsection-navbar">
    <ul class="nav">
        <li {% ifequal report.section_name 'Project Reports' %}class="active"{% endifequal %}><a href="{% url reports_home domain %}">Project Reports</a> <div class="arrow"></div></li>
        <li {% ifequal report.section_name 'Active Data Management' %}class="active"{% endifequal %}><a href="{% url default_adm_report domain %}">Active Data Management</a> <div class="arrow"></div></li>
    </ul>
</nav>
{% endblock %}

{% block sidebar %}{% include "reports/partials/report_list.html" %}{% endblock %}
{% block report_filter_actions %}
<div id="savedReports">
    <div class="btn-toolbar">
        <div class="btn-group">
            <button id="apply-filters" type="submit" class="filters btn disabled"
                data-loading-text="Generating Report..."
                data-standard-text="Apply">
                Apply
            </button>
        </div>
        <div class="btn-group">
            <a class="btn dropdown-toggle" data-toggle="dropdown">
                Favorites<span class="caret"></span>
            </a>

            <ul class="dropdown-menu">
                <li data-bind="ifnot: reportConfigs().length">
                    <a href="#">You don't have any favorites</a>
                </li>
                <!-- ko foreach: reportConfigs -->
                <li>
                    <a href="#" tabindex="-1"
                        data-bind="text: name, attr: { title: description }, click: $root.setConfigBeingViewed">
                    </a>
                </li>
                <!-- /ko -->
            </ul>
        </div>

        <button class="btn" data-bind="click: setConfigBeingEdited">
            Save...
        </button>

        {% if report.is_emailable %}
            <div style="display: inline-block; margin-left:0.5em;" class="label label-info">
                <i class="icon-white icon-info-sign" id="email-enabled"></i> Email Supported
            </div>
        {% endif %}
    </div>
    <div id="report-config-modal" class="hide fade" data-bind="modal: configBeingEdited">
        <div data-bind="with: configBeingEdited">
            <div class="modal-header">
                <a class="close" data-bind="click: $root.unsetConfigBeingEdited">Ã—</a>
                <h3 data-bind="text: modalTitle"></h3>
            </div>
            <form class="form-horizontal">
                <div class="modal-body">
                    <div class="control-group">
                        <label class="control-label" for="name">Name</label>
                        <div class="controls">
                            <input type="text" id="name" data-bind="value: name"/>
                            <span class="help-inline">
                                <small class="label">Required</small>
                            </span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label class="control-label" for="description">Description</label>
                        <div class="controls">
                            <textarea rows="3" name="description" data-bind="value: description"></textarea>
                        </div>
                    </div>
                    
                    {% if report.has_datespan %}
                    <div class="control-group">
                        <label class="control-label" for="date_range">Default Date Range</label>
                        <div class="controls">
                            <select name="date_range" data-bind="value: date_range">
                                <option value="last7">Last 7 days</option>
                                <option value="last30">Last 30 days</option>
                                <option value="lastn">Days ago</option>
                                <option value="since">Since a date</option>
                                <option value="range">From a date to a date</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-group" data-bind="visible: date_range() == 'lastn'">
                        <label class="control-label" for="days">Number of Days</label>
                        <div class="controls">
                            <input type="number" name="days" min="1" step="1" data-bind="value: days"/>
                        </div>
                    </div>
                    <div class="control-group" data-bind="visible: date_range() == 'since' || date_range() == 'range'">
                        <label class="control-label" for="start_date">Begin Date</label>
                        <div class="controls">
                            <input type="text" class="date-picker" name="start_date" data-bind="value: start_date"/>
                            <span class="help-inline">
                                <small class="label">YYYY-MM-DD</small>
                            </span>
                        </div>
                    </div>
                    <div class="control-group" data-bind="visible: date_range() == 'range'">
                        <label class="control-label" for="end_date">End Date</label>
                        <div class="controls">
                            <input type="text" class="date-picker" name="end_date" data-bind="value: end_date"/>
                            <span class="help-inline">
                                <small class="label">YYYY-MM-DD</small>
                            </span>
                        </div>
                    </div>
                    {% endif %}

                </div>
                <div class="modal-footer">
                    <div class="btn-toolbar">
                        <div class="btn-group">
                            <a href="#" class="btn" data-bind="click: $root.unsetConfigBeingEdited">Cancel</a>
                        </div>
                        <div class="btn-group">
                            <span data-bind="saveButton2: $root.modalSaveButton.state, saveOptions: $root.modalSaveButton.saveOptions"></span>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
