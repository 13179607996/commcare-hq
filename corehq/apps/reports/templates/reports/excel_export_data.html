{% extends "reports/report_base.html" %}
{% load xforms_extras %}

{% block js %}{{ block.super }}
    <script src="{{ STATIC_URL }}hqwebapp/js/dialogs.js"></script>
{% endblock %}


{% block js-inline %}{{ block.super }}
    <script>
	    {# modified from: http://stackoverflow.com/questions/809035/ajax-jquery-ui-dialog-window-loaded-within-ajax-style-jquery-ui-tabs #}
	    $(function (){
	        var ajaxDialog = $('<div id="export-ajax-dialog" style="display:hidden"></div>').appendTo('body');
            ajaxDialog.dialog({autoOpen: false});
            $('a.export-ajax').live('click', function() {
			    // load remote content
			    ajaxDialog.load(this.href);
			    ajaxDialog.dialog("open");
			    //prevent the browser from following the link
			    return false;
			});
	    });
    </script>
{% endblock %}

{% block head %}{{ block.super }}
    <style>
        th {
            text-align: left;
        }
        table.export_data a {
            color: #0067B1;
        }
        table.export_data {
            border: 1px solid #ccc;
            margin: auto;
            padding-top: 2em;
            width: 100%;
        }
    </style>

{% endblock %}

{% block reportcontent %}
    <div class="padded">
    {% if saved_exports %}
        <h2>Saved Custom Exports</h2>
        <table class="export_data">
            <tr>
                <th>Name</th>
                <th>Form</th>
                <th></th><th></th><th></th>
            </tr>        
        {% for export in saved_exports %}
            <tr class="{% cycle "odd" "even" %}">
                <td>{{ export.name|default:"[blank]" }}</td>
                <td>{{ export.formname }}</td>
                <td><a href='{% url corehq.apps.reports.views.export_custom_data domain export.get_id %}?group={{ group.get_id }}'>
                        Download data
                    </a></td>
                <td><a href='{% url corehq.apps.reports.views.edit_custom_export domain export.get_id %}'>
                        Edit
                    </a></td>
                <td><a href='{% url corehq.apps.reports.views.export_custom_data domain export.get_id %}?format=html'>
                        HTML Preview
                    </a></td>
                <td><a class="delete_link" href="#">Delete</a>
                    {% include "reports/dialogs/delete_custom_export_dialog.html" %}
                 </td>
             </tr>
        {% endfor %}
        </table>
    {% else %}
    <h3>No Custom Exports yet! Click "Create Custom Export" on a form below to make one.</h3>
    {% endif %}
    </div>
    

    {% if forms %}
    <div class="padded">
        <h2>Export full forms</h2>
        <table class="export_data">
            <tr>
                <th>Application</th>
                <th>Module</th>
                <th>Form</th>
                <th></th>
            </tr>
            {% for form in forms %}
                <tr class="{% cycle "odd" "even" %}">
                    <td>
                        {% ifchanged %}
                            {% if form.app %}
                                {{ form.app.name }}
                            {% else %}
                                Unknown Forms <!---->
                            {% endif %}
                        {% endifchanged %}
                    </td>
                    <td>
                        {% ifchanged %}
                            {% if form.app %}
                                <!--Make sure to check if {{ form.app.name }} changed-->
                                {{ form.module.name|trans:form.app.langs }}
                            {% else %}
                                <!---->
                            {% endif %}
                        {% endifchanged %}
                    </td>
                    
                    <td>
                            {% if form.app %}
                                {{ form.form.name|trans:form.app.langs }}

                            {% else %}
                                {{ form.xmlns }} {% if form.duplicate %}(XMLNS Conflict){% endif %}
                            {% endif %}
                    </td>
                    <td>
{#                        <a href='{% url corehq.apps.reports.views.export_data domain %}?export_tag="{{ form.xmlns }}"&filename={% if form.app %}{{ form.form.name|trans:form.app.langs }}{% else %}{{ form.xmlns }}{% endif %}&startdate={{ datespan.startdate_param }}&enddate={{ datespan.enddate_param }}&group={{ group.get_id }}'>#}
{#                            Download#}
{#                        </a><br>#}
                        <a href='{% url corehq.apps.reports.views.export_data_async domain %}?export_tag={% if form.xmlns != None %}["{{ domain }}", "{{ form.xmlns }}"]{% endif %}&filename={% if form.app %}{{ form.form.name|trans:form.app.langs }}{% else %}{{ form.xmlns }}{% endif %}&startdate={{ datespan.startdate_param }}&enddate={{ datespan.enddate_param }}&group={{ group.get_id }}'
                            class="export-ajax">Download</a>
                        <br>
                        {% if form.xmlns != None %}
                            <a href='{% url corehq.apps.reports.views.custom_export domain %}?export_tag="{{ form.xmlns }}"'>Create Custom Export</a>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
{% endif %}
{% endblock %}