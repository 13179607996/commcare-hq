{% extends "reports/base_template.html" %}
{% load hq_shared_tags %}
{% load crispy_forms_tags %}

{% block reports-js %}
<script src="{% static 'hqwebapp/js/lib/jquery-ui/jquery-ui-1.9.2.multiselect-deps.custom.min.js' %}"></script>
<script src="{% static 'hqwebapp/js/lib/jquery-ui/multiselect/ui.multiselect.js' %}"></script>
{% endblock %}


{% block reports-js-inline %}
<script>
    $("#id_config_ids").width(600).height(200).multiselect();
</script>
{% endblock %}

{% block reports-css %}
<link rel="stylesheet" href="{% static 'hqwebapp/js/lib/jquery-ui-datepicker/datepicker-theme/jquery-ui-1.8.17.custom.css' %}" />
<link rel="stylesheet" href="{% static 'hqwebapp/js/lib/jquery-ui/multiselect/ui.multiselect.css' %}" />
{% endblock %}

{% block main_column %}
    <div class="row-fluid">
        <div class="span12">
            {% if form %}
            {% crispy form %}
            {% else %}
            <div class="alert">
                You need a saved report that supports email in order to set up a scheduled email report, but you don't have any.
            </div>
            <div class="alert alert-info">
                <strong>Note:</strong> Not all built-in reports currently support email delivery.
            </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block js-inline %} {{ block.super }}
    <script type="text/javascript">
    var weekly_options = {{ weekly_day_options|JSON }};
    var monthly_options = {{ monthly_day_options|JSON }};

    function add_options_to_select($select, opt_list, selected_val) {
        for (var i = 0; i < opt_list.length; i++) {
            var $opt = $('<option />').val(opt_list[i][0]).text(opt_list[i][1]);
            if (opt_list[i][0] === selected_val) {
                $opt.attr("selected", "true");
            }
            $select.append($opt);
        }
        return $select;
    }

    function update_day_input(day_value) {
        var $interval = $interval || $('[name="interval"]');
        $('#div_id_day').remove();
        if ($interval.val() !== 'daily') {
            var opts = $interval.val() === 'weekly' ? weekly_options : monthly_options
            var $day_select = $('<select id="id_day" class="select" name="day" />');
            $day_select = add_options_to_select($day_select, opts, day_value);
            var $day_control_group = $('<div id="div_id_day" class="control-group" />')
                    .append($('<label for="id_day" class="control-label requiredField">Day<span class="asteriskField">*</span></label>'))
                    .append($('<div class="controls" />').append($day_select));
            $interval.parents('.control-group').after($day_control_group);
        }
    }

    $(function() {
        update_day_input({{ day_value }});
        $('[name="interval"]').change(function() {
            update_day_input();
        })
    });
    </script>
{% endblock %}
