<label class="control-label">{{ control_name }}</label>
<div class="controls" data-bind="foreach: selected_path">
  <select data-bind="options: children, optionsText: 'display_name', value: selected_child"></select>
</div>
<input name="location_id" type="hidden" data-bind="value: selected_locid" />

  <!-- pre-populate existing value -->
  <!-- populate locs -->
  <!-- update filter button initially greyed out -->

<script type="text/javascript">

$(function() {

  var locs = {{ locations|safe }};
  var model = new LocationSelectViewModel();
  ko.applyBindings(model, $('#group_{{ control_slug }}')[0]);
  model.load(locs);

});

function LocationSelectViewModel() {
  this.root = ko.observable();
  this.selected_path = ko.observableArray();

  this.selected_location = ko.computed(function() {
      for (var i = this.selected_path().length - 1; i >= 0; i--) {
        var loc = this.selected_path()[i];
        if (loc.selected_is_valid()) {
          return loc.selected_child();
        }
      }
      return null;
    }, this);
  this.selected_locid = ko.computed(function() {
      return this.selected_location() ? this.selected_location().uuid() : null;
    }, this);

  this.path_push = function(loc) {
    this.selected_path.push(loc);
    if (loc.num_children() == 1) {
      loc.selected_child(loc.get_child(0));
    }
  }

  this.load = function(locs) {
    this.root(new LocationModel({name: '_root', id: -1, children: locs}, this));
    this.path_push(this.root());
  }
}

function LocationModel(data, root, depth) {
  var loc = this;

  this.name = ko.observable();
  this.type = ko.observable();
  this.uuid = ko.observable();
  this.children = ko.observableArray();
  this.depth = depth || 0;

  this.display_name = ko.computed(function() {
      return this.name() == '_all' ? 'All' : this.name();
    }, this);

  this.selected_child = ko.observable();
  this.selected_child.subscribe(function(val) {
      if (val == null) {
        return;
      }

      var removed = root.selected_path.splice(val.depth, 99);
      $.each(removed, function(i, e) {
          // reset so dropdown for loc will default to 'all' if shown again
          e.selected_child(null);
        });
      if (val.num_children()) {
        root.path_push(val);
      }
    }, this);
  this.selected_is_valid = ko.computed(function() {
      return this.selected_child() && this.selected_child().name() != '_all';
    }, this);

  // helpers to account for the 'all' meta-entry
  this.num_children = ko.computed(function() {
      return (this.children().length == 0 ? 0 : this.children().length - 1);
    }, this);
  this.get_child = function(i) {
    return this.children()[i + 1];
  }

  this.load = function(data) {
    this.name(data.name);
    this.type(data.type);
    this.uuid(data.uuid);

    if (data.children) {
      //'all choices' meta-entry; annoying that we have to stuff this in
      //the children list, but all my attempts to make computed observables
      //based of children() caused infinite loops.
      data.children.splice(0, 0, {name: '_all', id: -1});
    }
    this.children($.map(data.children || [], function(e) {
        return new LocationModel(e, root, loc.depth + 1);
      }));
  }
  this.load(data);
}
</script>
