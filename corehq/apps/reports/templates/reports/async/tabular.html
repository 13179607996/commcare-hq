{% extends report_base|default:"reports/async/default.html" %}
{% load hq_shared_tags %}
{% load report_tags %}
{% load i18n %}

{% block js %}{{ block.super }}
    {% if charts %}
    <script src="{% static 'nvd3/lib/d3.v2.js' %}"></script>
    <script src="{% static 'nvd3/nv.d3.min.js' %}"></script>
    {% endif %}
{% endblock %}

{% block reportcontent %}

{% block pretable %}
    {% if charts %}
    <div class="row">
        {% for chart in charts %}
        <div id='chart_{{ report.slug }}_{{ forloop.counter }}' class="col-md-{{ chart_span }} collapse">
            {% if chart.title %}<h4 style="text-align: center;">{{ chart.title }}</h4>{% endif %}
            <svg style='height: {{ chart.height }}px'> </svg>
        </div>
        {% endfor %}
    </div>
    {% endif %}
{% endblock pretable %}
<div class="panel panel-default">
    <div class="panel-heading">
        <h2 class="panel-title">
        {% if not report.needs_filters %}
            {{ report.report_title }}
            {% for subtitle in report.report_subtitles %}
            <small>{{ subtitle }}</small>
            {% endfor %}
        {% else %}
            {% trans "Please apply filters to view:" %} {{ report.report_title }}
        {% endif %}
        </h2>
    </div>
    <div class="panel-body-datatable">
    {% block reporttable %}
    {% if report.needs_filters %}
        {% include 'reports/partials/description.html' %}
    {% else %}
        <table id="report_table_{{ report.slug }}" class="table table-striped datatable" {% if pagination.filter %} data-filter="true"{% endif %}>
            <thead>
            {%  if report_table.headers.complex %}
                {{ report_table.headers.render_html|safe }}
            {% else %}
                {# This method is depricated and will likely be removed once Legacy Custom Reports are moved over. #}
                <tr>
                    {% for header in report_table.headers %}
                        <th {% if not report_table.pagination.is_on %}data-sort="{{ header.sort_type }}" data-sortdir="{{ header.sort_direction }}"{% endif %} {% if header.css_class %}class="{{ header.css_class }}"{% endif %}>
                            <i class="icon-white fa dt-sort-icon"></i>
                            {% if header.html %}{{ header.html }}{% else %}{{ header|linebreaksbr }}{% endif %}
                            {% if header.help_text %}
                                <i class="fa fa-question-circle header-tooltip" title="{{ header.help_text }}"></i>
                            {% endif %}
                        </th>
                    {% endfor %}
                </tr>
            {% endif %}
            </thead>
            <tbody>
            {% block tabular-body %}
            {% if report_table.pagination.is_on %}
                <tr>
                    <td colspan="{{ report_table.headers.header|length }}" class="dataTables_empty">
                        {% trans "Fetching additional data, please wait..." %}
                    </td>
                </tr>
            {% endif %}
            {% for row in report_table.rows %}
                <tr>
                    {% for col in row %}
                        {% include 'reports/async/partials/tabular_cell.html' %}
                    {% endfor %}
                </tr>
            {% endfor %}
            {% endblock %}
            </tbody>
            {% if report_table.total_row and report_table.rows %}
                <tfoot>
                <tr>
                    {% for col in report_table.total_row %}
                        <td>{% if col.html != None %}{{ col.html|safe }}{% else %}{{ col|safe }}{% endif %}</td>
                    {% endfor %}
                </tr>
                </tfoot>
            {% endif %}
            {% if report_table.statistics_rows and report_table.rows %}
                <tfoot>
                    {% for stats in report_table.statistics_rows %}
                        <tr>
                        {% for col in stats %}
                            {% ifequal forloop.counter0 0 %}<th>{% else %}<td{% if col.css_class %} class="{{ col.css_class }}"{% endif %}>{% endifequal %}
                                {% if col.html != None %}{{ col.html|safe }}{% else %}{{ col|safe }}{% endif %}
                            {% ifequal forloop.counter0 0 %}</th>{% else %}</td>{% endifequal %}
                        {% endfor %}
                        </tr>
                    {% endfor %}
                </tfoot>

            {% endif %}
        </table>
    {% endif %}
    {% endblock reporttable %}
    </div>
</div>
{% block posttable %}{% endblock posttable %}
{% endblock reportcontent %}

{% block js-inline %} {{ block.super }}
    <script type="text/template" id="js-template-loading-report">
        <div class="report-loading-container">
            <div class="report-loading">
                <h4>{% trans "Loading Report" %}</h4>
                <i class="fa fa-spin fa-spinner"></i>
            </div>
        </div>
    </script>
    <script>
        function renderPage(data) {
        if (data.report_table && data.report_table.datatables) {
            var options = {
                dataTableElem: '#report_table_' + data.slug,
                defaultRows: data.report_table.default_rows,
                startAtRowNum: data.report_table.start_at_row,
                showAllRowsOption: data.report_table.show_all_rows,
                loadingTemplateSelector: '#js-template-loading-report',
                autoWidth: data.report_table.headers.auto_width,
            };
            if (!data.report_table.sortable) {
                options.defaultSort = false;
            }
            if (data.report_table.headers.render_aoColumns) {
                options.aoColumns = data.report_table.headers.render_aoColumns;
            }
            if (data.report_table.headers.custom_sort) {
                options.customSort = data.report_table.headers.custom_sort;
            }
            if (data.report_table.pagination.hide) {
                options.show_pagination = false;
            }
            if (data.report_table.pagination.is_on) {
                _.extend(options, {
                    ajaxSource: data.report_table.pagination.source,
                    ajaxParams: data.report_table.pagination.params,
                });
            }
            if (data.report_table.bad_request_error_text) {
                options.badRequestErrorText = "<span class='label label-important'>" + gettext("Sorry!") + "</span>" + data.report_table.bad_request_error_text;
            }
            if (data.report_table.left_col.is_fixed) {
                _.extend(options, {
                    fixColumns: true,
                    fixColsNumLeft: data.report_table.left_col.fixed.num,
                    fixColsWidth: data.report_table.left_col.fixed.width,
                });
            }
            var reportTables = hqImport("reports/js/config.dataTables.bootstrap").HQReportDataTables(options);
            var standardHQReport = hqImport("reports/js/standard_hq_report").getStandardHQReport();
            if (typeof standardHQReport !== 'undefined') {
                standardHQReport.handleTabularReportCookies(reportTables);
            }
            reportTables.render();
        }
        }

        $(function() {
            $('.header-popover').popover({
                trigger: 'hover',
                placement: 'bottom',
                container: 'body'
            });
        });
    </script>
    {% for chart in charts %}
        {% with id=forloop.counter|stringformat:"s" slug=report.slug %}
            {% include chart.template_partial with chart=chart chart_id='chart_'|add:slug|add:'_'|add:id %}
        {% endwith %}
    {% endfor %}
{% endblock js-inline %}
