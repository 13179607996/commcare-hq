{% load i18n %}

<tr>
    <th>
        <script>
            $(function(){
                $(".reset_password").each(function(){
                    var that = this,
                        url = $(this).attr('data-src'),
                        loadingMessage = "<p>Loading...</p>";
                    $(this).find('.no-match-error-text').hide();
                    function setContent(html) {
                        var $content = $(html);
                        $(that).find('> div').html($content);
                        COMMCAREHQ.initBlock($content);
                    }
                    $(this).bind('dialogopen', function(){
//                        setContent(loadingMessage);
//                        $.ajax({
//                            url: url,
//                            dataType: "json",
//                            type: "GET",
//                            success: function(data){
//                                setContent(data.formHTML);
//                            }
//                        });
                        $(that).dialog('widget').css({width: "400px"});
                    }).delegate('form', 'submit', function(){
                        if ($(this).find('[name="new_password1"]').val() !==
                                $(this).find('[name="new_password2"]').val()) {
                            $(this).find('.no-match-error-text').show();
                            return false;
                        } else {
                            $(this).find('.no-match-error-text').hide();
                        }
                        setContent(loadingMessage);
                        $.ajax({
                            url: url,
                            data: $(this).serialize(),
                            dataType: "json",
                            type: "POST",
                            success: function(data){
                                if(data.status === "ok") {
                                    window.location.reload();
                                } else {
                                    setContent(data.formHTML);
                                }
                            }
                        });
                        return false;
                    });
                });
            });
        </script>
    </th>
    <th>{% trans "CommCare Account" %}</th>
    <th>{% trans "Reset Password" %}</th>
    <th>{% trans "Date Registered" %}</th>
    <th>{% trans "Phone Numbers" %}</th>
</tr>
{% for user in commcare_users %}
    {% ifchanged user.user_id %}
        <tr class="{% cycle "odd" "even" %}">
    {% else %}
        <tr class="same_as_last">
    {% endifchanged %}
        <td></td>
        <td><a href="{% url user_account domain user.user_id %}">{{ user.html_username|safe }}</a></td>
        <td>
            <a href="#" class="dialog_opener">reset</a>
            <div class="dialog reset_password" title="Reset Password" data-src="{% url change_password domain user.user_id %}">
                <p>Reset Password for {{ user.html_username|safe }}</p>
                <div>
                    <form action="">
                        <table>
                            <tbody>
                                <tr>
                                    <th>
                                        <label for="id_new_password1">New password:</label>
                                    </th>
                                    <td>
                                        <input type="password" name="new_password1" id="id_new_password1"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        <label for="id_new_password2">New password confirmation:</label>
                                    </th>
                                    <td>
                                        <ul class="errorList">
                                            <li class="no-match-error-text">The two password fields didn't match.</li>
                                        </ul>
                                        <input type="password" name="new_password2" id="id_new_password2"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <input type="submit" value="Reset" class="ui-button ui-widget ui-state-default ui-corner-all" role="button">
                    </form>
                </div>
            </div>
        </td>
        <td>{{ user.date_joined.date }}</td>
        <td>
        {% ifchanged %}
                {% if user.phone_numbers %}
                    +{{ user.phone_numbers.0 }}
                    {% if user.phone_numbers.1 %}
                        (and more)
                    {% endif %}
                {% endif %}
        {% endifchanged %}
        </td>
    </tr>
{% endfor %}