{% extends "users/users_base.html" %}
{% load i18n %}

{% block js-inline %}{{ block.super }}
    <script type="text/javascript">
        $(function(){
            $('.reset-password-form').submit(function(){
                $(this).ajaxSubmit({
                    url: $(this).attr('action'),
                    success: function (response, status, xhr, form) {
                        console.log("SUBMITTED");
                        console.log(response);
                        console.log(status);
                    }
                });
                return false;
//                var that = this,
//                    url = $(this).attr('data-src'),
//                    loadingMessage = "<p>Loading...</p>";
//
//                $(this).find('.no-match-error-text').hide();
//                function setContent(html) {
//                    var $content = $(html);
//                    $(that).find('> div').html($content);
//                    COMMCAREHQ.initBlock($content);
//                }
//                $(this).bind('dialogopen', function(){
//                    $(that).dialog('widget').css({width: "400px"});
//                }).delegate('form', 'submit', function(){
//                    if ($(this).find('[name="new_password1"]').val() !==
//                            $(this).find('[name="new_password2"]').val()) {
//                        $(this).find('.no-match-error-text').show();
//                        return false;
//                    } else {
//                        $(this).find('.no-match-error-text').hide();
//                    }
//                    setContent(loadingMessage);
//                    $.ajaxForm({
//                        url: url,
//                        data: $(this).serialize(),
//                        dataType: "json",
//                        type: "POST",
//                        success: function(data){
//                            if(data.status === "ok") {
//                                window.location.reload();
//                            } else {
//                                setContent(data.formHTML);
//                            }
//                        }
//                    });
//                    return false;
//                });
            });
        });
    </script>
{% endblock %}

{% block page-title %}
    <ul class="breadcrumb">
        <li>
            <a href="{% url users_default domain %}"><strong>Project Settings</strong></a> <span class="divider">&gt;</span>
        </li>
        <li class="active">
            <a href="#">Case Workers</a>
        </li>
    </ul>
{% endblock %}

{% block user-view %}
<div class="tab-content">
    <table class="table table-striped table-bordered">
        {% if commcare_users %}
            <thead>
                <tr>
                    <th>{% trans "Username" %}</th>
                    <th>{% trans "Password" %}</th>
                    <th>{% trans "Date Registered" %}</th>
                    <th>{% trans "Forms" %}</th>
                    <th>{% trans "Cases" %}</th>
                    <th>{% trans "Phone" %}</th>
                    {% if couch_user.can_edit_commcare_users %}
                    <th>{% trans "Archive" %} <span class="help-link" data-help-key="users/archive"></span></th>
                    <th>{% trans "Delete" %} <span class="help-link" data-help-key="users/delete"></span></th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
            {% for user in commcare_users %}
                {% ifchanged user.is_active %}
                    {% if not user.is_active %}
                    <tr>
                        <td colspan="8">Archived Users</td>
                    </tr>
                    {% endif %}
                {% endifchanged %}
                <tr class="{% cycle "odd" "even" %}">
                    <td><a href="{% url user_account domain user.user_id %}">{{ user.raw_username }}</a></td>
                    <td>
                        <a href="#reset_password_{{ user.user_id }}" class="btn btn-info" data-toggle="modal">Reset Password</a>

                        <div id="reset_password_{{ user.user_id }}" class="modal hide fade">
                            <div class="modal-header">
                                <a class="close" data-dismiss="modal">&times;</a>
                                <h3>Reset Password for <small>{{ user.html_username|safe }}</small></h3>
                            </div>
                            <form class="form form-horizontal hq-form reset-password-form" action="{% url change_password domain user.user_id %}" method="post">
                                <div class="modal-body">
                                    <div class="control-group">
                                        <label class="control-label" for="id_new_password1">
                                            New password:
                                        </label>
                                        <div class="controls">
                                            <input type="password" name="new_password1" id="id_new_password1"/>
                                        </div>
                                    </div>
                                    <div class="control-group">
                                        <label class="control-label" for="id_new_password2">
                                            New password confirmation:
                                        </label>
                                        <div class="controls">
                                            <input type="password" name="new_password2" id="id_new_password2"/>
                                        </div>
                                    </div>
{#                                    <ul class="errorList">#}
{#                                        <li class="no-match-error-text">The two password fields didn't match.</li>#}
{#                                    </ul>#}
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">Reset</button>
                                    <a href="#" data-dismiss="modal" class="btn">Cancel</a>
                                </div>
                            </form>
                        </div>
                    </td>
                    <td>{{ user.date_joined.date }}</td>
                    <td>{{ user.form_count }}</td>
                    <td>{{ user.case_count }}</td>
                    <td>
                        {% if user.phone_numbers %}
                            +{{ user.phone_numbers.0 }}
                            {% if user.phone_numbers.1 %}
                                (and more)
                            {% endif %}
                        {% endif %}
                    </td>
                    {% if couch_user.can_edit_commcare_users %}
                    <td>
                        {% if user.is_active %}
                        <form action="{% url archive_commcare_user domain user.user_id %}">
                            <input type="submit" value="archive"/>
                        </form>
                        {% else %}
                            <form action="{% url unarchive_commcare_user domain user.user_id %}" method="post">
                                <input type="submit" value="unarchive"/>
                            </form>
                        {% endif %}
                    </td>
                    <td>
                            <form action="{% url delete_commcare_user domain user.user_id %}"
                                  method="post"
                                  data-title="Delete User?"
                                  data-message="Are you sure you want to permanently delete {{ user.raw_username }} and all of their form submissions?">
                                <input type="submit" class="confirm-submit" value="delete"/>
                            </form>
                    </td>
                    {% endif %}
                </tr>
            {% endfor %}
        {% else %}
            <tr><td colspan="8">There are no CommCare users in this domain.</td></tr>
        {% endif %}
        {% if not show_inactive %}
            <tr>
                <td colspan="8">
                    <a href="./?show_inactive=true">Show Archived Users</a>
                </td>
            </tr>
        {% endif %}
        </tbody>
    </table>
    <div>
        <a class="new_link" href="{% url add_commcare_account domain %}">CommCare User</a>
        or
        <a href="{% url upload_commcare_users domain %}">Bulk Upload</a>
    </div>
</div>
{% endblock %}