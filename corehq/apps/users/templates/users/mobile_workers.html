{% extends "style/bootstrap3/base_section.html" %}
{% load i18n %}
{% load hq_shared_tags %}
{% load crispy_forms_tags %}
{% load djangular_tags %}

{% block js %}
<script type="text/javascript"
        src="{% new_static 'style/js/pagination.ng.js' %}"></script>
<script type="text/javascript"
        src="{% new_static 'users/js/mobile_workers.ng.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
<script type="text/javascript">
$(function () {
   'use strict';
    $('#newMobileWorkerModal').on('shown.bs.modal', function () {
        $('#id_username').focus();
    });
});
(function (angular, undefined) {
    'use strict';
    var mobileWorkerApp = angular.module('mobileWorkerApp', ['hq.pagination', 'hq.mobile_workers']);
    mobileWorkerApp.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
    }]);
    mobileWorkerApp.config(["djangoRMIProvider", function(djangoRMIProvider) {
        djangoRMIProvider.configure({% djng_current_rmi %});
    }]);
    mobileWorkerApp.constant('formStrings', {
        checkingUsername: "{% trans "Checking username" %}"
    });
    mobileWorkerApp.constant('customFields', {{ custom_fields|JSON }});
    mobileWorkerApp.constant('customFieldNames', {{ custom_field_names|JSON }});
    mobileWorkerApp.constant('paginationCustomData', {
        customFormFieldNames: {{ custom_field_names|JSON }},
        showDeactivatedUsers: false,
        activateUser: function (user, djangoRMI) {
            $('#activate_' + user.user_id).modal('hide');
            djangoRMI.activate_user(user.user_id)
                .success(function (data) {
                    if (data.success) {
                        user.mark_activated = true;
                        user.action_error = '';
                    } else {
                        user.action_error = '{% trans "Error activating user." %}';
                    }
                })
                .error(function () {
                    user.action_error = '{% trans "Issue communicating with server. Try again." %}';
                });
        },
        deactivateUser: function (user, djangoRMI) {
            $('#deactivate_' + user.user_id).modal('hide');
            djangoRMI.deactivate_user(user.user_id)
                .success(function (data) {
                    if (data.success) {
                        user.mark_deactivated = true;
                        user.action_error = '';
                    } else {
                        user.action_error = '{% trans "Error deactivating user." %}';
                    }
                })
                .error(function () {
                    user.action_error = '{% trans "Issue communicating with server. Try again." %}';
                });
        }
    });
    {% angularjs %}
    mobileWorkerApp.directive('workertableHeader', function () {
        return {
            restrict: 'A',
            template: '<tr><th class="col-xs-3">' +
                    '{% trans "Username" %}</th><th ng-repeat="field_name in ' +
                    'customFormFieldNames">{{ field_name }}</th><th ' +
                    'class="col-xs-2">{% trans 'Action' %}</th></tr>'
        }
    });
    mobileWorkerApp.directive('customFieldColumn', function () {
        return {
            restrict: 'A',
            template: '<span ng-show="_.isArray(field_val)">' +
                      '<ul class="list-table"><li ng-repeat="d in field_val">{{ d }}</li></ul>' +
                      '</span>' +
                      '<span ng-show="!_.isArray(field_val)">{{ field_val }}</span>'
        }
    });
    mobileWorkerApp.constant('paginationLimits', [
        [10, '{% trans "Show 10 Mobile Workers" %}'],
        [25, '{% trans "Show 25 Mobile Workers" %}'],
        [50, '{% trans "Show 50 Mobile Workers" %}'],
        [100, '{% trans "Show 100 Mobile Workers" %}']
    ]);
    {% endangularjs %}
}(window.angular));
</script>
{% endblock %}

{% block page_content %}
    <div ng-app="mobileWorkerApp">
        <div ng-controller="MobileWorkerCreationController">
            <div class="row">
                <div class="col-sm-8">
                    <p class="lead">
                        {% blocktrans %}
                            Mobile Workers can log into applications in this project space
                            and submit data.
                        {% endblocktrans %}
                    </p>
                    <p>
                        {% blocktrans %}
                            Their activity and form submissions can be
                            monitored in the Reports section of this CommCareHQ project space.
                            <br />
                            Read more about managing mobile workers on our
                            <a href="http://help.commcarehq.org/" target="_blank">Help Site</a>.
                        {% endblocktrans %}
                    </p>
                    <div class="btn-toolbar" style="margin-bottom: 20px;">
                        {% if can_add_extra_users %}
                            <button type="button"
                                    class="btn btn-success"
                                    data-toggle="modal"
                                    data-target="#newMobileWorkerModal"
                                    ng-click="initializeMobileWorker()">
                                <i class="fa fa-plus"></i> {% trans "Create Mobile Worker" %}
                            </button>
                        {% endif %}
                        {% if can_bulk_edit_users %}
                            <a id="bulk_download" class="btn btn-info" href="{% url "download_commcare_users" domain %}">
                                <i class="icon-download-alt"></i> {% trans "Download Mobile Workers" %}
                            </a>
                            <a id="bulk_upload" class="btn btn-default" href="{% url "upload_commcare_users" domain %}">
                                {% trans "Bulk Upload" %}
                            </a>
                        {% endif %}
                        {% if can_add_extra_users %}
                            <a class="btn btn-default" href="{% url "user_fields_view" domain %}" id="btn-edit_user_fields">
                                {% trans "Edit User Fields" %}
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal fade" id="newMobileWorkerModal">
                <div class="modal-dialog">
                    <form id="newMobileWorkerForm"
                          name="mobileWorkerForm"
                          novalidate
                          ng-submit="submitNewMobileWorker()">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal">
                                    <span aria-hidden="true">&times;</span>
                                    <span class="sr-only">{% trans 'Close' %}</span>
                                </button>
                                <h3 class="modal-title">{% trans "Create New Mobile Worker" %}</h3>
                            </div>
                            <div class="modal-body">
                                <div class="form-horizontal">
                                    {% crispy new_mobile_worker_form %}
                                    {% if custom_fields_form.fields %}
                                        {% crispy custom_fields_form %}
                                    {% endif %}
                                </div>
                                <div>{# TODO Remove #}
                                    {% angularjs %}
                                        {{ mobileWorker }}
                                    {% endangularjs %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
                                <button type="submit"
                                        ng-disabled="mobileWorkerForm.$invalid || usernameAvailabilityStatus !== 'available'"
                                        class="btn btn-primary">
                                    {% trans "Create" %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% angularjs %}

            <div class="panel panel-info"
                 ng-show="hasPending">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-circle-o-notch fa-spin"></i>
                        {% trans 'Pending Mobile Workers' %}
                    </h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped">
                        <thead workertable-header></thead>
                        <tbody>
                            <tr ng-repeat="worker in workers | filter: {creationStatus: 'pending'}">
                                <td><i class="fa fa-user"></i><strong> {{ worker.username }}</strong></td>
                                <td ng-repeat="(slug, field_val) in worker.customFields" custom-field-column></td>
                                <td>
                                    <i class="fa fa-circle-o-notch fa-spin"></i>
                                    {% trans 'Pending...' %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel panel-success"
                 ng-show="hasSuccess">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-check"></i>
                        {% trans 'New Mobile Workers' %}
                    </h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped">
                        <thead workertable-header></thead>
                        <tbody>
                            <tr ng-repeat="worker in workers | filter: {creationStatus: 'success'}">
                                <td><i class="fa fa-user"></i><strong> {{ worker.username }}</strong></td>
                                <td ng-repeat="(slug, field_val) in worker.customFields" custom-field-column></td>
                                <td><a href="{{ worker.editUrl }}"
                                       class="btn btn-primary">{% trans 'Edit' %}</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="panel panel-danger"
                 ng-show="hasError">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <i class="fa fa-exclamation-triangle"></i>
                        {% trans 'Errors Creating Workers' %}
                    </h3>
                </div>
                <div class="panel-body">
                    <table class="table table-striped">
                        <thead workertable-header></thead>
                        <tbody>
                            <tr ng-repeat="worker in workers | filter: {creationStatus: 'error'}">
                                <td><i class="fa fa-user"></i><strong> {{ worker.username }}</strong></td>
                                <td ng-repeat="(slug, field_val) in worker.customFields" custom-field-column></td>
                                <td>
                                    <button type="button"
                                            class="btn btn-default"
                                            data-toggle="modal"
                                            data-target="#newMobileWorkerModal"
                                            ng-click="initializeMobileWorker(worker); usernameAvailabilityStatus = USERNAME_STATUS.AVAILABLE; usernameStatusMessage = 'Username is available.'">
                                        {% trans 'Retry' %}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            {% endangularjs %}
        </div>
        <div class="panel panel-default" ng-controller="PaginatedListController">
            <div class="panel-heading">
                <h3 class="panel-title">{% trans 'Mobile Workers' %}</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-sm-4">
                        <div class="input-group">
                            <input type="text"
                                   class="form-control"
                                   ng-keypress="updateQuery($event)"
                                   ng-model="query"
                                   placeholder="{% trans "Filter Workers..." %}">
                            <span class="input-group-btn">
                                <button class="btn btn-default"
                                        ng-click="filterData()"
                                        type="button">
                                    <i class="fa fa-search"></i>
                                </button>
                            </span>
                        </div>
                        <p class="help-block">
                            <i class="fa fa-info-circle"></i>
                            {% blocktrans %}
                            Search any text, or use a targeted query. For more info see the <a
                                href='https://wiki.commcarehq.org/display/commcarepublic/Create+and+Manage+CommCare+Mobile+Workers#CreateandManageCommCareMobileWorkers-C.SearchforMobileWorkers'
                                target='_blank'>Mobile Workers</a> help page
                            {% endblocktrans %}
                        </p>
                    </div>
                    <div class="col-sm-4">
                        <select class="form-control"
                                ng-change="pageChanged()"
                                ng-model="limit"
                                ng-init="limit = {{ default_limit }}"
                                ng-options="pl.value as pl.key for pl in paginationLimits">
                        </select>
                    </div>
                    <div class="col-sm-4">
                        <button type="button"
                                class="btn btn-default pull-right"
                                ng-click="showDeactivatedUsers = true; filterData();"
                                ng-show="!showDeactivatedUsers">
                            {% trans 'Show Deactivated Mobile Workers' %}
                        </button>
                        <button type="button"
                                class="btn btn-default pull-right"
                                ng-click="showDeactivatedUsers = false; filterData();"
                                ng-show="showDeactivatedUsers">
                            {% trans 'Show Active Mobile Workers' %}
                        </button>
                        <div class="pull-right" style="clear: right;">
                            <pagination direction-links="true"
                                        total-items="total"
                                        items-per-page="limit"
                                        previous-text="&laquo;"
                                        next-text="&raquo;"
                                        max-size="maxSize"
                                        ng-model="currentPage"
                                        ng-change="pageChanged()"></pagination>
                        </div>
                    </div>
                </div>
                <table class="table table-striped table-responsive"
                       style="margin-bottom: 0;">
                    <thead>
                        <tr>
                            <th class="col-xs-3">{% trans "Username" %}</th>
                            {% angularjs %}
                            <th ng-repeat="field_name in customFormFieldNames">{{ field_name }}</th>
                            {% endangularjs %}
                            <th class="col-xs-2">{% trans 'Date Registered' %}</th>
                            <th class="col-xs-2">{% trans 'Action' %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="user in paginatedItems">
                            {% angularjs %}
                            <td>
                                <a href="{{ user.editUrl }}">
                                    <i class="fa fa-user"></i>
                                    <strong>{{ user.username }}</strong>
                                    <span ng-if="!!user.name">({{ user.name }})</span>
                                </a>
                            </td>
                            <td ng-repeat="(slug, field_val) in user.customFields"
                                custom-field-column></td>
                            <td>{{ user.dateRegistered }}</td>
                            <td ng-if="user.action === 'activate'">
                                <button type="button"
                                        class="btn btn-default"
                                        data-toggle="modal"
                                        ng-show="!user.mark_activated"
                                        data-target="#activate_{{ user.user_id }}">
                                        {% trans "Activate" %}
                                </button>
                                <span ng-show="user.mark_activated">
                                    <i class="fa fa-check"></i> {% trans "ACTIVE" %}
                                </span>
                                <p ng-show="!!user.action_error">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    {{ user.action_error }}
                                </p>
                                <div id="activate_{{ user.user_id }}"
                                     class="modal fade">
                                    <div class="modal-dialog">
                                        <form class="modal-content"
                                              method="post"
                                              ng-submit="activateUser(user, djangoRMI);">
                                            <div class="modal-header">
                                                <button type="button"
                                                        class="close"
                                                        data-dismiss="modal">
                                                    <span aria-hidden="true">&times;</span>
                                                    <span class="sr-only">{% trans "Close" %}</span>
                                                </button>
                                                <h4 class="modal-title">{% trans "Activate Mobile Worker" %}</h4>
                                            </div>
                                            <div class="modal-body">
                                                <p class="lead well well-small">
                                                    <i class="fa fa-user"></i>
                                                    <strong>{{ user.username }}</strong>
                                                    <span ng-if="!!user.name">({{ user.name }})</span>
                                                </p>
                                                <p class="lead">{% trans "Are you sure you want to ACTIVATE this worker?" %}</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button"
                                                        class="btn btn-default"
                                                        data-dismiss="modal">
                                                    {% trans "Cancel" %}
                                                </button>
                                                <button type="submit"
                                                        class="btn btn-success">
                                                    {% trans 'Activate' %}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </td>
                            <td ng-if="user.action === 'deactivate'">
                                <button type="button"
                                        class="btn btn-default"
                                        data-toggle="modal"
                                        data-target="#deactivate_{{ user.user_id }}"
                                        ng-show="!user.mark_deactivated">
                                        {% trans "Deactivate" %}
                                </button>
                                <span ng-show="user.mark_deactivated">
                                    <i class="fa fa-check"></i> {% trans "INACTIVE" %}
                                </span>
                                <p ng-show="!!user.action_error">
                                    <i class="fa fa-exclamation-triangle"></i>
                                    {{ user.action_error }}
                                </p>
                                <div id="deactivate_{{ user.user_id }}"
                                     class="modal fade">
                                    <div class="modal-dialog">
                                        <form class="modal-content"
                                              method="post"
                                              ng-submit="deactivateUser(user, djangoRMI);">
                                            <div class="modal-header">
                                                <button type="button"
                                                        class="close"
                                                        data-dismiss="modal">
                                                    <span aria-hidden="true">&times;</span>
                                                    <span class="sr-only">{% trans "Close" %}</span>
                                                </button>
                                                <h4 class="modal-title">{% trans "Deactivate Mobile Worker" %}</h4>
                                            </div>
                                            <div class="modal-body">
                                                <p class="lead well well-small">
                                                    <i class="fa fa-user"></i>
                                                    <strong>{{ user.username }}</strong>
                                                    <span ng-if="!!user.name">({{ user.name }})</span>
                                                </p>
                                                <p class="lead">{% trans "Are you sure you want to DEACTIVATE this worker?" %}</p>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button"
                                                        class="btn btn-default"
                                                        data-dismiss="modal">
                                                    {% trans "Cancel" %}
                                                </button>
                                                <button type="submit"
                                                        class="btn btn-default btn-danger">
                                                    {% trans 'Deactivate' %}
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </td>
                            {% endangularjs %}
                        </tr>
                    </tbody>
                </table>
                <div class="alert alert-info"
                     ng-hide="hasError"
                     ng-show="notLoaded">
                    <i class="fa fa-circle-o-notch fa-spin"></i>
                    {% trans "Loading Workers..." %}
                </div>
                <div class="alert alert-danger"
                     ng-show="hasError">
                    {% blocktrans %}
                        <strong>There was an issue contacting the server.</strong>
                        Please check your internet connection.
                        If this issue continues, please
                        <a href="#modalReportIssue"
                           data-toggle="modal">file a bug report</a>.
                    {% endblocktrans %}
                </div>
                <div class="pull-right">
                    <pagination direction-links="true"
                                total-items="total"
                                items-per-page="limit"
                                previous-text="&laquo;"
                                next-text="&raquo;"
                                max-size="maxSize"
                                ng-model="currentPage"
                                ng-change="pageChanged()"></pagination>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
