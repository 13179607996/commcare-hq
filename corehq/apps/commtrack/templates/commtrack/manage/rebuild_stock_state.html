{% extends "settings/base_template.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block main_column %}
    <table class="table table-bordered table-striped">
    {% for key, actions, case_doc_info in actions_by_stock_state_key %}
    {% for action_type, action in actions %}
        {% with action.stock_transaction as stock_transaction %}
        {% if forloop.first %}
        <tr>
            <td colspan="6" style="text-align: center">
                <strong>{{ case_doc_info|pretty_doc_info }}</strong>
                {{ stock_transaction.section_id }}
                for <em>{{ stock_transaction.sql_product.name }}</em>
                {% if request.user.is_superuser and request|toggle_enabled:'SUPPORT' %}
                <form method="post" action="" class="pull-right">
                    <input type="hidden" name="case_id" value="{{ key.case_id }}">
                    <input type="hidden" name="section_id" value="{{ key.section_id }}">
                    <input type="hidden" name="product_id" value="{{ key.product_id }}">
                    <input type="submit" class="btn btn-primary" value="Rebuild"/>
                </form>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th colspan="2"></th>
            <th colspan="2">Current Values</th>
            <th colspan="2">Rebuilt Values</th>
        </tr>
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Quantity</th>
            <th>Stock on Hand</th>
            <th>Quantity</th>
            <th>Stock on Hand</th>
        </tr>
        {% endif %}
        <tr>
            <td>{{ stock_transaction.report.date }}</td>
            <td>{{ stock_transaction.report.type }}</td>
            <td>{{ stock_transaction.quantity }}</td>
            <td>{{ stock_transaction.stock_on_hand }}</td>
            {% if action_type == '_SaveStockTransaction' %}
            <td>
                {% if stock_transaction.quantity != action.ledger_values.delta %}
                <span class="text-error">
                {% else %}
                <span class="muted">
                {% endif %}
                {{ action.ledger_values.delta }}</span>
            </td>
            <td>
                {% if stock_transaction.stock_on_hand != action.ledger_values.balance %}
                <span class="text-error">
                {% else %}
                <span class="muted">
                {% endif %}
                {{ action.ledger_values.balance }}</span>
            </td>
            {% else %}
            <td colspan="2">(will be deleted)</td>
            {% endif %}
        </tr>
        {% endwith %}
        {% if forloop.last and not forloop.counter|divisibleby:2 %}
            {# this is to get the striping right on each table section #}
            <tr></tr>
        {% endif %}
    {% endfor %}
    {# this is to put space between each table section #}
    {# while still having the columns between sections line up #}
    <tr>
        <td style="border-left: 0; border-right: 0;
         padding: 20px; background: transparent;" colspan="6"></td>
    </tr>
    {% endfor %}
    </table>
{% endblock %}
