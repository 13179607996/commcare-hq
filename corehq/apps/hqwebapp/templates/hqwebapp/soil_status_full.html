{% extends "hqwebapp/base_section.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js-inline %}{{ block.super }}
    <script>
        $(function () {
            var initialPageData = hqImport("hqwebapp/js/initial_page_data").get,
                downloadId = initialPageData("download_id"),
                autoRefresh = '',
                pollDownloader = function () {
                if ($('#ready_' + downloadId).length == 0)
                    {
                        $.ajax(initialPageData("poll_url"), {
                            success: function(data) {
                                $("#display_" + downloadId).html(data);
                            },
                            error: function(data) {
                                var message = initialPageData("error_text");
                                if (data.responseText !== undefined && data.responseText !== ''){
                                    message = data.responseText;
                                }
                                $("#display_" + downloadId).html('<p class="alert alert-danger">' + message + '</p>');
                                clearInterval(autoRefresh);
                            }
                        });
                    } else {
                        clearInterval(autoRefresh);
                    }
            };
            pollDownloader();
            autoRefresh = setInterval(pollDownloader, 2000);
        });
    </script>
{% endblock %}

{% block page_content %}
    {% initial_page_data 'download_id' download_id %}
    {% initial_page_data 'error_text' error_text %}
    {% initial_page_data 'poll_url' poll_url %}

    <header>
        <div class="row">
            <div class="col-sm-8">
                <h2>{{ title }}</h2>
            </div>
        </div>
    </header>

    <div class="downloader_container" id="display_{{ download_id }}">
        <legend>
            {{ progress_text }}
        </legend>
    </div>

    {% if next_url and next_url_text %}
        <a href='{{ next_url }}'>{{ next_url_text }}</a>
    {% endif %}
{% endblock %}
