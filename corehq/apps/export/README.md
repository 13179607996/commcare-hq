# Exports

### Architecture

Exports are designed to build off the corresponding application to generate a schema that represents the questions, properties, and system properties that are available to the user to select. There is exactly one schema for each Application/Module/Form triplet or Application/Case Type pair. On initial generation of an export schema, the export will be generated by only taking into account the current or "live" application. If the user chooses to view deleted questions, it will iterate through each built application that has `has_submissions` set to True.

Example:

Suppose there exists the following app builds

| app_id  | build_version | questions |
|---|---|---|
| 1234  | 12 (current) | q1,q2,q4   |
| 1234  | 10  | q1,q3   |
| 1234  | 1  | q1,q2,q3   |

Below illustrates what the schema will look like after processing each app from beginning to current. The example schema is simplified for understanding. Each question has an app_id and version associated with it.

After processing build_version 1:
```
q1.last_occurences = { app_id: 1 }
q2.last_occurences = { app_id: 1 }
q3.last_occurences = { app_id: 1 }
```

After processing build_version 10:
```
q1.last_occurences = { app_id: 10 }
q2.last_occurences = { app_id: 1 }
q3.last_occurences = { app_id: 10 }
```

After processing build_version 12 (current version, not necessarily built):
```
q1.last_occurences = { app_id: 12 }
q2.last_occurences = { app_id: 12 }
q3.last_occurences = { app_id: 10 }
q4.last_occurences = { app_id: 12 }
```

The export that is then generated will look something like this:

| question | is selected (by default) | is marked deleted | is hidden from user |
|------|---|---|---|
| q1 | ✓ |  |  |
| q2 | ✓ |  |  |
| q3 | | ✓ | ✓ |
| q4 | ✓ |  |  |

Since q3's latest build_version is 10, the code deduces that it has been deleted and therefore hides it and marks it as deleted.

### Exporting remote apps / defining your own schema

In order to export remote apps, you will need to define your own schema for the export since there are no forms and modules to build the export off of.

To enable the ability to do this turn on the toggle:
```
ALLOW_USER_DEFINED_EXPORT_COLUMNS ('Allows users to specify their own export columns')
```

The UI will then enable you to add columns and tables with a blank textbox to add a path. Paths are specified in a dot notation.

Support the form looked like this:

```
<data>
  <question1></question1>
<data>
```

To specify this in `.` notation, it'd look like this in the schema:
```
form.question1
```

If you need to specify a repeat group and the form looks like this:

```
<data>
  <repeat>
    <question1></question1>
  </repeat>
</data>
```

The table path for this repeat would be:
```
form.repeat[]
```
Note the `[]` after the question. This tells the schema that it is a repeat group.

Any columns added to this table will need to be prefixed with this path. So a column in the table would be:

```
form.repeat[].question1
```

### System Properties

System properties are properties that CommCareHQ adds to the form or case that are essentially meta data.  Examples of these include: form id, case type, case id, form xmlns, etc. System properties are added to a white list. This means that by default a system property on the form will _not_ be added to the export for selection. A list of the system properties can be found in [corehq/apps/export/system_properties.py](https://github.com/dimagi/commcare-hq/blob/master/corehq/apps/export/system_properties.py)

### Optimizations

Often times iterating through each build in an application can be time consuming. To reduce the time to process an application, the code only processes applications that have been marked as having submissions.

### Migrating Exports

At the time of writing this HQ is still in the process of migrating exports over to the new export
infrastructure. In order to migrate an export there are two commands you can use:

```
./manage.py migrate_exports
./manage.py migrate_exports_for_domain <domain>
```

Check out the command for more documentation on the options.

#### Migration strategy

The general approach for migrating exports is:

1. Load the `SavedExportSchema` (old export model)
2. Generate a new schema of the export using the applications in the project
3. Generate an `ExportInstance` based off the new schema
4. Use the `SavedExportSchema` to determine which columns should be selected and the order they should be in

If the old schema has a column that is not found in the new schema, then the conversion fails. The conversion process is fairly complex to cover the many edge cases. The function to convert a `SavedExportSchema` to a `ExportInstance` can be found in `corehq/apps/export/utils.py:convert_saved_export_to_export_instance`.

There are many situations where the new schema cannot find a column that was selected in the old schema. This is because old exports included every possible attribute and node to be exported from all the data submitted, and also included a few bugs that created duplicate or redundant columns. The new exports whitelists the properties you can export to avoid seeing things like `doc_type` on the export page. When we cannot find the corresponding column, we can use `--force-column-convert`. This option takes any columns that were not found in the new schema and force adds them via an `InferredSchema`. The `InferredSchema` accounts for all columns that should be added to the export, but CommCare cannot account for them in any of the `Application`s in the domain. Once added to the `InferredSchema`, the column will show up in any additional exports created.

There is one further difficulty that has made the last 20 or so domains difficult to migrate. When migrating some of the leftover domains, you may see the error:

```
Failed parsing 83b6fbfadc1fe0a43bc084fadb456a3f: Form exports require an app id
```

This is because when parsing the export 83b6fbfadc1fe0a43bc084fadb456a3f, it could not find a match application for the XMLNS found in the export. This usually happens because of `RemoteApplication`s. The new `FormExportInstance` requires that all exports contain an `app_id` in order to exist. In the future, the correct way to resolve this is to drop that requirement.

### Caveats and edge cases

- Unknown deleted questions: It is possible to have an export where there lists properties that do not have any data associated with them. This case can arise when adding a question, `q1`, to the current application (without making a build), opening an export (to kick off the processing of the current application), then deleting `q1` before making a build. `q1` will now always be in the schema but will be shown as deleted.
