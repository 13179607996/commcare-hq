{% extends 'style/bootstrap3/base_section.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load hq_shared_tags %}
{% load compress %}
{% load djangular_tags %}

{% block stylesheets %}
<link type="text/css"
      rel="stylesheet"
      media="all"
      href="{% new_static 'style/lib/daterangepicker-b3/daterangepicker.css' %}" />
<style type="text/css">
    .form-notice-container {
        position: relative;
        height: 145px;
    }
    @media (max-width: 767px) {
        .form-notice-container {
            height: 217px;
        }
    }
    .form-notice {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.6);
        z-index: 4999;

    }
    .form-notice .label {
        margin: 0 auto;
        position: absolute;
        width: 350px;
        left: 50%;
        margin-left: -150px;
        margin-top: -3px;
        z-index: 5000;
    }
</style>
{% endblock stylesheets %}

{% block head %}
<script type="text/javascript" src="{% new_static 'style/js/daterangepicker.config.js' %}"></script>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{% new_static 'style/lib/daterangepicker-b3/moment.min.js' %}"></script>
<script type="text/javascript" src="{% new_static 'style/lib/daterangepicker-b3/daterangepicker.js' %}"></script>
<script type="text/javascript" src="{% new_static 'export/js/download_export.ng.js' %}"></script>
{% endblock %}

{% block js-inline %}
<script type="text/javascript">
(function (angular, undefined) {
   'use strict';
    var downloadExportsApp = angular.module('downloadExportsApp', ['hq.download_export']);
    downloadExportsApp.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
    }]);
    downloadExportsApp.config(["djangoRMIProvider", function(djangoRMIProvider) {
        djangoRMIProvider.configure({% djng_current_rmi %});
    }]);
    downloadExportsApp.constant('exportList', {{ export_list|JSON }});
    downloadExportsApp.constant('maxColumnSize', {{ max_column_size|JSON }});
    downloadExportsApp.constant('defaultDateRange', '{{ default_date_range }}');
    downloadExportsApp.constant('allowPreview', {{ allow_preview|BOOL }});
}(window.angular));
</script>
{% endblock %}

{% block page_content %}
    <div ng-app="downloadExportsApp">
        <div ng-controller="DownloadExportFormController"
             ng-cloak>
            <div class="alert alert-info">
                {% blocktrans %}
                    You are downloading the following exports:
                {% endblocktrans %}
                <ul>
                    {% angularjs %}
                    <li ng-repeat="export in exportList">
                        <a href="{{ export.edit_url }}" target="_blank">
                            <i class="fa fa-file-text"></i>
                            {{ export.name }}</a>
                    </li>
                    {% endangularjs %}
                </ul>
            </div>
            <div class="panel panel-default"
                 ng-show="!!isPreviewLoading">
                <div class="panel-heading">{% trans "Export Preview" %}</div>
                <div class="panel-body" style="height: 300px; overflow-y: scroll;">
                    <div ng-show="!isPreviewReady">
                        <p class="lead">
                            <i class="fa fa-spinner fa-spin"></i>
                            {% trans "Loading Preview..." %}
                        </p>
                    </div>
                    <div ng-show="!!isPreviewReady">
                        {% angularjs %}
                        <div ng-repeat="table in previewTables">
                            <h4>{{ table.table_name }}</h4>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th ng-repeat="header in table.headers">{{ header }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr ng-repeat="row in table.rows">
                                        <td ng-repeat="col in row">
                                            {{ col }}
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% endangularjs %}
                    </div>
                </div>
            </div>
            <form class="form form-horizontal form-notice-container"
                  name="exportFiltersForm"
                  ng-submit="prepareExport()"
                  novalidate="novalidate">
                <div class="form-notice-container">
                    {% crispy download_export_form %}
                    <div class="form-notice"
                         ng-show="!!downloadInProgress">
                        <div class="label label-default label-lg">
                            <i class="fa fa-info-circle"></i>
                            {% trans "Filters inactive while download in progress. " %}
                        </div>
                    </div>
                </div>
                <div class="form-actions" ng-show="!downloadInProgress">
                    <div class="col-sm-5 col-sm-offset-3">
                        {% angularjs %}
                        <div class="alert alert-warning"
                             ng-show="!!prepareExportError">
                            <i class="fa fa-exclamation-triangle"></i>
                            <span ng-if="prepareExportError === 'default'">
                                {% blocktrans %}
                                Sorry, there was a problem reaching the server.
                                Please try again or
                                <a href="#reportIssueModal"
                                   data-toggle="modal">Report an Issue</a>.
                                {% endblocktrans %}
                            </span>
                            <span ng-if="prepareExportError !== 'default'">
                                {{ prepareExportError }}
                            </span>
                        </div>
                        {% endangularjs %}
                        <button type="submit"
                                class="btn btn-primary"
                                ng-show="!preparingExport"
                                ng-disabled="(!!exportFiltersForm.$invalid || isFormInvalid()) && !preparingExport">
                            <i class="fa fa-download"></i>
                            {% trans "Prepare Export" %}
                        </button>
                        <button type="button"
                                class="btn btn-info"
                                data-toggle="modal"
                                ng-show="!!allowPreview"
                                ng-click="getPreview()">
                            {% trans 'Preview Export' %}
                        </button>
                        <a href="{{ export_list_url }}" class="btn btn-default">
                            {% trans "Cancel" %}
                        </a>
                        <div class="label label-info label-lg"
                             ng-show="preparingExport">
                            <i class="fa-spin fa fa-spinner"></i>
                            {% trans "Preparing Export" %}
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div ng-controller="DownloadProgressController"
             ng-cloak>
            <div class="form-actions"
                 ng-show="!!showDownloadStatus">
                <div class="col-sm-9 col-lg-5 col-sm-offset-3">
                    <div class="row"
                         ng-show="!!showCeleryError">
                        <div class="col-sm-12">
                            <div class="alert alert-warning">
                                <i class="fa fa-cog fa-spin"></i>
                                <strong>{% trans "Server maintenance in progress. Please try again later." %}</strong>
                                <p>
                                    {% blocktrans %}
                                        If the problem persists, please
                                        <a href="#reportIssueModal"
                                           data-toggle="modal">
                                            Report an Issue</a>.
                                    {% endblocktrans %}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="row"
                         ng-show="!showCeleryError">
                        <div class="col-sm-3 col-md-4">
                            {% angularjs %}
                            <form class="form-inline download-form"
                                  method="POST"
                                  action="{{ dropboxUrl }}">
                                <a href="{{ downloadUrl }}"
                                   class="btn btn-primary btn-lg"
                                   style="width: 100%;"
                                   ng-show="!!isDownloadReady"
                                   ng-disabled="!isDownloadReady"
                                   ng-click="isDownloaded = true;">
                                        <i class="fa fa-download"></i>
                                        {% trans "Download" %}
                                </a>
                                <button type="button"
                                        class="btn btn-primary btn-lg"
                                        style="width: 100%;"
                                        ng-show="!isDownloadReady"
                                        ng-disabled="!isDownloadReady">
                                        <i class="fa fa-download"></i>
                                    {% trans "Download" %}
                                </button>
                                <button button="submit"
                                        class="btn btn-default"
                                        style="margin-top: 5px; width: 100%;"
                                        ng-disabled="!isDownloadReady"
                                        ng-click="isDownloaded = true;">
                                    <i class="fa fa-dropbox"></i>
                                    {% trans "Sync to Dropbox" %}
                                </button>
                            </form>
                            {% endangularjs %}
                        </div>
                        <div class="col-sm-9 col-md-8"
                             style="padding-top: 10px;"
                             ng-show="!isDownloaded && !showCeleryError">
                            <div class="label label-danger label-lg"
                                 ng-show="!!progress.error">
                                <i class="fa fa-exclamation-triangle"></i>
                                <strong>{% trans "Something went wrong!" %}</strong>
                                {{ progress.error_message }}
                            </div>
                            <div class="label label-info label-lg"
                               ng-show="!isDownloadReady">
                                <i class="fa fa-spinner fa-spin"></i>
                                {% trans "Collecting Data" %}
                            </div>
                            <div class="label label-success label-lg"
                               ng-show="!!isDownloadReady">
                                <i class="fa fa-check"></i>
                                {% trans "Export is Ready" %}
                            </div>
                            <div class="progress">
                                <div id="download-progress-bar"
                                     class="progress-bar"
                                     role="progressbar"
                                     aria-valuenow="60"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                    {% angularjs %}
                                    <span class="sr-only">{{ progress.percent }}% {% trans 'Complete' %}</span>
                                    {% endangularjs %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-9 col-md-8"
                             ng-show="!!isDownloaded">
                            <button type="button"
                                    class="btn btn-default btn-lg"
                                    ng-click="resetDownload()">
                                {% trans "Update Filters & Re-Download" %}
                            </button>
                        </div>
                    </div>
                    <p class="alert alert-info"
                       style="margin-top: 10px;"
                       ng-show="!showCeleryError">
                        <i class="fa fa-info-circle"></i>
                        {% blocktrans %}
                            If you are downloading a large file over
                            a slow or unstable connection, we
                            recommend syncing to Dropbox.
                        {% endblocktrans %}
                        <a href="https://confluence.dimagi.com/display/commcarepublic/Syncing+Downloads+to+Dropbox"
                           target="_blank">
                            {% trans 'Learn more about Sync to Dropbox' %}</a>.
                    </p>
                </div>
            </div>
        </div>
    </div>

{% endblock page_content %}
