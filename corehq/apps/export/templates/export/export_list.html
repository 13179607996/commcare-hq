{%  extends 'style/bootstrap3/base_section.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load hq_shared_tags %}
{% load compress %}
{% load djangular_tags %}

{% block stylesheets %}{{ block.super }}
    <script type="text/css">
        .bulk-checkbox {
            margin-top: 8px;
            vertical-align: top;
            line-height: 20px;
            display: inline-block;
        }
    </script>
{% endblock %}

{% block js %}
<script type="text/javascript" src="{% new_static 'export/js/list_exports.ng.js' %}"></script>
<script type="text/javascript" src="{% new_static 'app_manager/js/hq.app_data_drilldown.ng.js' %}"></script>
{% endblock %}

{% block js-inline %}
<script type="text/javascript">
(function (angular, undefined) {
   'use strict';
    var listExportsApp = angular.module('listExportsApp', ['hq.list_exports', 'hq.app_data_drilldown']);
    listExportsApp.config(['$httpProvider', function($httpProvider) {
        $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
    }]);
    listExportsApp.config(["djangoRMIProvider", function(djangoRMIProvider) {
        djangoRMIProvider.configure({% djng_current_rmi %});
    }]);
    listExportsApp.constant('formModalSelector', '#createExportOptionsModal');
    listExportsApp.constant('processApplicationDataFormSuccessCallback', function (data) {
        window.location = data.url;
    });
}(window.angular));
</script>
{% endblock %}

{% block page_content %}
    <div ng-app="listExportsApp">
        <div ng-controller="ListExportsController"
             ng-cloak>
            {% if is_deid %}
            <p>
                {% blocktrans %}
                    These exports are <strong>De-Identified</strong>, meaning that
                    the administrator of this domain has removed all personally-identifying
                    properties from the exported data.
                {% endblocktrans %}
            </p>
            {% endif %}
            <p>
                {% blocktrans %}
                    Exports are a way to download data from CommCare HQ
                    in a variety of formats (CSV, Excel, etc.) for use in
                    third-party data analysis tools.
                {% endblocktrans %}
            </p>
            {% if not is_deid %}
            <p ng-show="!_.isEmpty(exports) || !hasLoaded">
                <a href="#createExportOptionsModal"
                   data-toggle="modal"
                   class="btn btn-success">
                    <i class="fa fa-plus"></i>
                    {% trans "Create New Export" %}
                </a>
            </p>
            <div class="alert alert-success"
                 ng-show="_.isEmpty(exports) && !!hasLoaded">
                <p class="lead"><strong>{% blocktrans %}
                    It seems you haven't created any exports yet!
                {% endblocktrans %}</strong></p>
                <p><a href="#createExportOptionsModal"
                      data-toggle="modal"
                      class="btn btn-success">
                    <i class="fa fa-plus"></i>
                    {% trans "Create New Export" %}
                </a></p>
            </div>
            {% endif %}
            <div class="panel panel-default">
                <div class="panel-heading">{% trans "Exports" %}</div>
                <div class="panel-body">
                    <div class="alert alert-info"
                         ng-show="!hasLoaded">
                        <p>
                            <i class="fa fa-spinner fa-spin"></i>
                            <strong>{% trans 'Fetching List of Exports...' %}</strong>
                        </p>
                    </div>
                    <div class="alert alert-info"
                         ng-show="_.isEmpty(exports) && !!hasLoaded && !exportsListError">
                        <p>
                            {% if is_deid %}
                                {% trans "No De-Identified Exports are available at this time." %}
                            {% else %}
                                {% trans 'No Exports Created Yet.' %}
                            {% endif %}
                        </p>
                    </div>
                    <div class="alert alert-warning"
                         ng-show="!!exportsListError">
                        <strong ng-if="exportsListError === 'default'">
                            {% trans "Issue fetching list of exports. Please check your Internet connection." %}
                        </strong>
                        <strong ng-if="exportsListError !== 'default'">
                            {% angularjs %}{{ exportsListError }}{% endangularjs %}
                        </strong>
                        {% blocktrans %}
                            If this problem persists, please
                            <a href="#reportIssueModal"
                               data-toggle="modal">Report an Issue</a>.
                        {% endblocktrans %}
                    </div>
                    {% include 'export/partial/export_bulk_notice.html' %}
                    <table class="table table-striped"
                           ng-show="!!hasLoaded && !_.isEmpty(exports)">
                        <thead>
                            <tr>
                                <th class="col-sm-6">{% trans 'Name' %}</th>
                                {% if not is_deid %}
                                <th class="col-sm-1">{% trans 'Edit' %}</th>
                                {% endif %}
                                <th class="col-sm-2">{% trans 'Export' %}</th>
                                {%  if allow_bulk_export %}
                                <th class="col-sm-3">
                                    {% trans 'Bulk Export:' %}
                                    <button type="button"
                                            class="btn btn-xs btn-default"
                                            ng-click="selectAll()">
                                        {% trans 'All' %}
                                    </button> {% trans 'or' %}
                                    <button type="button"
                                            class="btn btn-xs btn-default"
                                            ng-click="selectNone()">
                                        {% trans 'None' %}
                                    </button>
                                </th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="export in exports">
                                <td>
                                    {% angularjs %}
                                    <h4>{{ export.name }}
                                        <label class="label label-default label-default"
                                           ng-show="!!export.isDeid">
                                        {% trans 'De-Identified' %}
                                        </label></h4>
                                    <p ng-show="!!export.formname">
                                        <i class="fa fa-file-o"></i> <strong>{% trans 'Form:' %}</strong> {{ export.formname }}
                                    </p>
                                    {% endangularjs %}
                                    {% if not is_deid %}
                                    {% angularjs %}
                                    <div class="alert alert-neutral alert-small"
                                         ng-show="!_.isEmpty(export.emailedExports)">
                                        <div ng-repeat="component in export.emailedExports">
                                            <h5>
                                                <i class="fa fa-envelope"></i>
                                                {% trans "Saved for Daily Report" %}
                                                <button type="button"
                                                        class="btn btn-default btn-xs"
                                                        ng-show="!component.updatingData"
                                                        data-toggle="modal"
                                                        data-target="#modalRefreshExportConfirm-{{ export.id }}-{{ component.groupId }}">
                                                    <i class="fa fa-refresh"></i>
                                                    {% trans "Update Data" %}
                                                </button>
                                                <button type="button"
                                                        class="btn btn-default btn-xs btn-disabled"
                                                        ng-show="component.updatingData"
                                                        disabled="disabled">
                                                    <i class="fa fa-refresh fa-spin"></i>
                                                    {% trans "Updating Data, please wait..." %}
                                                </button>
                                            </h5>
                                            <p class="text-warning"
                                               ng-if="component.hasFile && component.fileData.showExpiredWarning && !component.updateDataTriggered">
                                                <i class="fa fa-exclamation-triangle"></i>
                                                {% blocktrans %}
                                                    This saved export has expired because it has not been used in
                                                    the last 35 days. To renew daily updates, click the 'Update Data'
                                                    button and download the file.
                                                {% endblocktrans %}
                                            </p>
                                            <p ng-if="component.updatedDataTriggered">
                                                <i class="fa fa-check"></i>
                                                <strong>{% trans "Data update started." %}</strong><br />
                                                {% trans "Please check back later for updates. (Page refresh required)" %}
                                            </p>
                                            <p ng-if="component.hasFile">
                                                <a href="{{ component.fileData.downloadUrl }}"
                                                   class="btn btn-info btn-xs">
                                                    <i class="fa fa-download"></i>
                                                    {% trans "Download" %}
                                                </a>&nbsp;&nbsp;
                                                <strong>{% trans "Size:" %}</strong> {{ component.fileData.size }}&nbsp;&nbsp;&nbsp;
                                                <strong>{% trans "Last Updated:" %}</strong> {{ component.fileData.lastUpdated }}
                                            </p>
                                            <p ng-if="!component.hasFile && !component.updatedDataTriggered">
                                                {% blocktrans %}
                                                <strong>No data is available yet.</strong><br />
                                                    Please click 'update data' if the automatic scheduler hasn't picked up the changes in a while.
                                                {% endblocktrans %}
                                            </p>
                                            <div class="modal fade"
                                                 id="modalRefreshExportConfirm-{{ export.id }}-{{ component.groupId }}">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
                                                            <h4 class="modal-title">{% trans "Confirm data updates." %}</h4>
                                                        </div>
                                                        <div class="modal-body" ng-if="component.hasFile && component.fileData.showExpiredWarning">
                                                            {% blocktrans %}
                                                                To renew daily updates, click the Update Data button below and check back in a little
                                                                bit once the updates have finished processing.
                                                            {% endblocktrans %}
                                                        </div>
                                                        <div class="modal-body" ng-if="!(component.hasFile && component.fileData.showExpiredWarning)">
                                                            <p class="lead">
                                                                {% blocktrans %}
                                                                    <strong>Once the data is updated, a data refresh should occur automatically on a daily basis.</strong>
                                                                {% endblocktrans %}
                                                            </p>
                                                            <p>
                                                                {% blocktrans %}
                                                                    To download data now, please click the Export button instead.
                                                                {% endblocktrans %}
                                                            </p>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <a href="#"
                                                               class="btn btn-default"
                                                               data-dismiss="modal">{% trans "Cancel" %}</a>
                                                            <button type="button"
                                                                    class="btn btn-primary"
                                                                    ng-click="updateEmailedExportData(component, export)">
                                                                {% trans "Update Data" %}
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endangularjs %}
                                    {% endif %}
                                </td>
                                {% if not is_deid %}
                                {% angularjs %}
                                <td>
                                    <a href="{{ export.editUrl }}"
                                       class="btn btn-default"><i class="fa fa-pencil"></i>
                                        {% trans 'Edit' %}</a>
                                </td>
                                {% endangularjs %}
                                {% endif %}
                                {% angularjs %}
                                <td>
                                    <a href="{{ export.downloadUrl }}"
                                       class="btn btn-primary">
                                        {% trans 'Export' %}</a>
                                </td>
                                {% endangularjs %}
                                {% if allow_bulk_export %}
                                {% angularjs %}
                                <td>
                                    <div class="checkbox checkbox-table-cell">
                                        <label>
                                            <input type="checkbox"
                                                   class="bulk-checkbox"
                                                   ng-model="export.addedToBulk"
                                                   ng-change="updateBulkStatus()"
                                                   id="add-to-bulk-{{ export.id }}" />
                                        </label>
                                    </div>
                                </td>
                                {% endangularjs %}
                                {% endif %}
                            </tr>
                        </tbody>
                    </table>
                    <div ng-show="exports.length > 6">
                        {% include 'export/partial/export_bulk_notice.html' %}
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade"
             id="createExportOptionsModal"
             ng-controller="DrilldownToFormController">
            <div class="modal-dialog">
                <form name="exportOptionsForm"
                      class="form form-horizontal"
                      ng-submit="handleSubmitForm()">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span>
                            </button>
                            <h4 class="modal-title">{{ create_export_form_title }}</h4>
                        </div>
                        <div class="modal-body"
                             ng-show="!isLoaded">
                            <i class="fa fa-spinner fa-spin"></i> {% trans 'Loading Form' %}
                        </div>
                        <div class="modal-body"
                             ng-show="!showNoAppsError && !formLoadError && !!isLoaded && !isSubmittingForm">
                            <div class="alert alert-warning"
                                 ng-show="!!formSubmissionError">
                                <i class="fa fa-exclamation-triangle"></i>
                                <strong ng-if="formSubmissionError === 'default'">
                                    {% blocktrans %}
                                        There was an issue fetching the export data.
                                        Please check your internet connection.
                                    {% endblocktrans %}
                                </strong>
                                <strong ng-if="formSubmissionError !== 'default'">
                                    {% angularjs %}{{ formSubmissionError }}{% endangularjs %}
                                </strong>
                                <p>
                                    If this problem persists,
                                    please <a href="#reportIssueModal"
                                              data-toggle="modal">Report an Issue</a>.
                                </p>
                            </div>
                            {% crispy create_export_form %}
                            <div class="alert alert-info"
                                 ng-show="hasNoCaseTypes && !!formData.application">
                                {% blocktrans %}
                                    This application does not appear to be using
                                    <a href="https://wiki.commcarehq.org/display/commcarepublic/Case+Management"
                                       target="_blank"><i class="fa fa-info-circle"></i> case management</a>.
                                {% endblocktrans %}
                             </div>
                            <div class="alert alert-info"
                                 ng-show="!_.isEmpty(selectedFormData)">
                                {% angularjs %}
                                    {{ selectedFormData.submissions }}
                                    {% blocktrans %}form submission<span ng-show="selectedFormData.submissions != 1">s</span> available.{% endblocktrans %}
                                {% endangularjs %}
                            </div>
                            <div class="alert alert-warning"
                                 ng-show="formData.app_type === '_unknown' && !formData.form && !selectedFormData.app_copy">
                                <i class="fa fa-exclamation-triangle"></i>
                                {% trans "Mislabeled" %}
                            </div>
                            <div class="well"
                                 ng-show="formData.app_type === '_unknown' && !formData.form && !selectedFormData.no_suggestions">
                                <h4>{% trans "Suggestions" %}:</h4>
                                <div ng-show="selectedFormData.app_does_not_exist">
                                    {% trans "These form submissions are tagged as if they belong to an application that doesn't exist." %}
                                </div>
                                <div ng-show="selectedFormData.duplicate">
                                    <p>{% trans "These submissions could belong to one of the following forms:" %}</p>
                                    {% angularjs %}
                                    <ul>
                                        <li ng-repeat="possiblitly in selectedFormData.possibilities">
                                            {{ possibility.app.name }} &gt;
                                            <span ng-if="selectedFormData.is_user_registration">
                                                {% trans "User Registration" %}
                                            </span>
                                            <span ng-if="!selectedFormData.is_user_registration">
                                                {{ selectedFormData.name }}
                                            </span>
                                            <span ng-if="possiblity.app_deleted">
                                                {% trans "App was deleted." %}
                                            </span>
                                        </li>
                                    </ul>
                                    {% endangularjs %}
                                </div>
                             </div>
                            {% if request.couch_user.can_edit_apps %}
                                <div class="well"
                                     ng-show="formData.app_type === 'deleted' && !!formData.application">
                                    {% angularjs %}
                                        <h4>
                                            "{{ selectedAppData.name }}" {% trans "is a deleted Application." %}
                                        </h4>
                                        <p>
                                            <a class="btn btn-default"
                                               href="{{ selectedAppData.restoreUrl }}">{% trans "Restore App" %}</a>
                                        </p>
                                    {% endangularjs %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="modal-body"
                             ng-show="!!isSubmittingForm">
                            <p class="lead">
                                <i class="fa fa-spinner fa-spin"></i>
                                {% blocktrans %}
                                    Preparing Export Data...
                                {% endblocktrans %}
                            </p>
                            <p>
                                {% blocktrans %}
                                    Please note that for some forms this may take several minutes.
                                    Thank you for your patience!
                                {% endblocktrans %}
                            </p>
                        </div>
                        <div class="modal-body"
                             ng-show="!!formLoadError">
                            <div class="alert alert-warning">
                                <i class="fa fa-exclamation-triangle"></i>
                                <span ng-if="formLoadError === 'default'">
                                    {% trans "There is an issue communicating with the server at this time." %}
                                </span>
                                <span ng-if="formLoadError !== 'default'">
                                    {% angularjs %}{{ formLoadError }}{% endangularjs %}
                                </span>
                            </div>
                            <p>
                                {% blocktrans %}
                                    If this problem persists, please <a href="#reportIssueModoal"
                                        data-toggle="modal">Report an Issue</a> and include this error
                                        message in the description.
                                {% endblocktrans %}
                            </p>
                            <p>
                                {% blocktrans %}
                                    We apologize for the inconvenience, and thank you for your patience. Someone
                                    on our development team is quickly working to resolve this issue.
                                {% endblocktrans %}
                            </p>
                        </div>
                        <div class="modal-body"
                             ng-show="!!showNoAppsError">
                            <p class="lead">
                            {% blocktrans %}
                                It seems as though you haven't submitted any data to CommCare HQ.
                                Please deploy an Application and submit data before creating any exports.
                            {% endblocktrans %}
                            </p>
                            <a href="https://confluence.dimagi.com/display/commcarepublic/Application+Building"
                               target="_blank">
                                <i class="fa fa-info-circle"></i>
                                {% trans 'How to Create and Deploy a CommCare Application.' %}
                            </a>
                         </div>
                        <div class="modal-footer">
                            <button type="button"
                                    class="btn btn-default"
                                    data-dismiss="modal"
                                    ng-disabled="!!isSubmittingForm">{% trans 'Cancel' %}</button>
                            <button type="submit"
                                    class="btn btn-success"
                                    ng-show="!showNoAppsError && !formLoadError"
                                    ng-disabled="!!exportOptionsForm.$invalid || !!isSubmittingForm">
                                {% trans "Create Export" %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
