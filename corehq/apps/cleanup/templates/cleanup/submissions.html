<!DOCTYPE html>

<html>
    <head>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
        <!--script src="{{ STATIC_URL }}hqwebapp/js/jsonreport.js"></script-->
        <script src="{{ STATIC_URL }}hqwebapp/js/ejs.min.js"></script>
        <script src="{{ STATIC_URL }}cleanup/js/jsontable.js"></script>
        <script>
            $(function(){
                var renderCode = (function(code){
                    return "<code>" + code + "</code>";
                })
                var state = {
                    get_url: function(){
                        return '{% url corehq.apps.cleanup.views.submissions_json domain %}' +
                                '?group=' + JSON.stringify(this.get_group()) +
                                '&userID=' + JSON.stringify(this.get_userID()) +
                                '&limit=' + this.get_limit() +
                                '&username__exclude=' + this.get_username__exclude();
                    },
                    get_group: function(){
                        return $("#group").is(':checked');
                    },
                    get_userID: function(){
                        return $("#use_userID").is(':checked') ? $("#userID").val() : null;
                    },
                    get_limit: function(){
                        return $("#limit").val();
                    },
                    get_username__exclude: function(){
                        return $("#username__exclude").val();
                    },

                    reload: function(){
                        $("#case_report").html("Loading...");
                        $.get(this.get_url(), function(data){
                            $("#case_report").html("Processing...");
                            $("#selected").html("");
                            var data = JSON.parse(data);
                            //var report = _.jsonreport(JSON.stringify(data.results));
                            state.table = new JsonTable({
                                data: data.results,
                                order: ["username", "userID", "deviceID", "submissions", "received_on"],
                                element: $("#case_report"),
                                selected: $("#selected"),
                                render: {userID: renderCode, deviceID: renderCode},
                                getId: function(x){
                                    if(state.get_group()) {
                                        return "All submissions from " + x.username + " (" + renderCode(x.userID) + ") on phone " + renderCode(x.deviceID);
                                    } else {
                                        return "Submission from " + x.username + " (" + renderCode(x.userID) + ") on phone " + renderCode(x.deviceID) + " recieved on " + x.received_on;
                                    }
                                }
                            });
                            $("#case_report").bind('change-selected', function(){
                                var self = state.table;
                                $("#selected").html("<table></table>");
                                for(var id in self.selected) {
                                    $('table', $("#selected")).append(self.selected[id].render({copy: true}));
                                }
                            });
                            $("#message").html(data.total);
                        });
                    }
                };
                $("#reload").click(function(){
                    state.reload();
                    return false;
                }).trigger('click');
                $("#user_reassignment select[name='user']").each(function(){
                    $.get('users.json', function(data){
                        var users = JSON.parse(data);
                        for(var i in users) {
                            var $option = $("<option />");
                            $option.attr("value", users[i].userID);
                            $option.text(users[i].username);
                            $("#user_reassignment select[name='user']").append($option);
                        }
                    });
                });
            });
        </script>
    </head>
    <body>
        <table>
            <tr>
            <td>
                <table>
                    <tr>
                        <td><label for="group">Collapse</label></td>
                        <td><input type="checkbox" id="group"/></td>
                    </tr>
                    <tr>
                        <td><label for="userID">User ID</label></td>
                        <td><input type="checkbox" id="use_userID" value="null"/><input type="text" id="userID" value=""/></td>
                    </tr>
                    <tr>
                        <td><label for="limit">Limit results to</label></td>
                        <td><input type="text" id="limit" value="100"/></td>
                    </tr>
                    <tr>
                        <td><label for="username__exclude">Exclude usernames:</label></td>
                        <td><input type="text" id="username__exclude" value='["demo_user", "admin"]' /></td>
                    </tr>
                </table>
                <!--input type="text" id="query" value='userID=""&limit=100'/-->
                <a id="reload" href="#">Reload</a>
                <div id="message"></div>
                <div id="case_report" class="jsontable">

                </div>
            </td>
            <td style="vertical-align:top;">
                <p>Reassign the following submissions:</p>
                <div id="selected"></div>
                <p>to the following user:</p>
                <form id="user_reassignment" action="" method="POST">
                    <select name="user">
                        
                    </select>
                </form>
            </td>
            </tr>
        </table>
    </body>
</html>