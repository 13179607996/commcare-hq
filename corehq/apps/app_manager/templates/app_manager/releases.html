{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load url_extras %}
{% load timezone_tags %}
{% load hq_shared_tags %}
{% load timezone_tags %}
{% load i18n %}
{% block js %}{{ block.super }}
    <script src="{% static 'hqwebapp/javascripts/knockout.mapping.js' %}"></script>
    <script src="{% static 'hqwebapp/js/knockout-bindings.js' %}"></script>
    <script src="{% static 'app_manager/js/releases.js' %}"></script>
{% endblock %}
{% block js-inline %}{{ block.super }}
<script>
    $(function () {
        {% if edit %}
        function setIsReleased(element, is_released) {
            if (is_released === undefined) {
                is_released = $(element).data('is-released');
            } else {
                $(element).data('is-released', is_released);
                $(element).attr('data-is-released', is_released);
            }
            function destroyPopover(element) {
                var p = $(element).data('popover');
                if (p) {
                    if (p.$tip) {
                        p.$tip.remove();
                    }
                    $(element).data('popover', null);
                }
            }
            destroyPopover(element);
            var row = $(element).parents('tr');
            if (is_released === true) {
                $(element).popover({
                    placement: 'left',
                    title: 'Retract Build',
                    content: (
                            "We recommend caution when retracting a build. Although " +
                                    "this build will no longer be considered when a CommCare application searches for updates, " +
                                    "it will not be purged from phones onto which it has already been downloaded."
                            )
                });
                row.removeClass('build-unreleased');
                row.addClass('build-released');
            } else if (is_released === false) {
                $(element).popover({
                    placement: 'left',
                    title: 'Release Build',
                    content: (
                            "Once you've fully tested an application, you can star it to mark it as released. " +
                                    "When a CommCare application searches for updates, only starred builds will be considered."
                            )
                });
                row.removeClass('build-released');
                row.addClass('build-unreleased');
            }
            var LATEST = 'build-latest-release';
            $('.' + LATEST).removeClass(LATEST);
            $('.build-is-released [data-is-released="true"]').first().each(function () {
                var row = $(this).parents('tr');
                row.addClass(LATEST);
            });
        }
        {% endif %}
        $('#build-errors').each(function () {
            var specialMessage = $('span', this)[0];
            var defaultMessage = $('span', this)[1];
            if ($.trim($(specialMessage).text())) {
                $(defaultMessage).hide();
            }
        });
        $('.showAccordionButton').click(function(e) {
            $($(this).attr('href')).slideDown();
            $(this).parent().hide();
            return false;
        });
        // init releases
        var urls = {
            fetch: '{% url paginate_releases domain app.id %}',
            delete: '{% url corehq.apps.app_manager.views.delete_copy domain app.id %}',
            emulator: '{% url emulator domain '___' %}',
            cloudcare: '{% url cloudcare_get_app domain '___' %}',
            jad: '{% url corehq.apps.app_manager.views.download_jad domain '___' %}',
            jar: '{% url corehq.apps.app_manager.views.download_jar domain '___' %}',
            odk: '{% url corehq.apps.app_manager.views.odk_install domain '___' %}',
            source: '{% url download_index domain '___' %}',
            release: '{% url release_build domain app.id '___' %}'
        };
        var o = {
            users_cannot_share: {{ users_cannot_share|JSON }},
            urls: urls
        };
        var el = $('#releases-table');
        ko.applyBindings(new ReleasesMain(o), el.get(0));
        el.show();
    });
</script>
{% endblock %}
{% block head %}{{ block.super }}
<style>
    .build:hover {
        color: black !important;
    }
    .build.build-unreleased {
        color: #888;
    }
    .build.build-released {
    }
    .build.build-latest-release {
        background-color: #EFEFFF;
    }
    .build.build-latest-release .build-is-released:after{
        content: "Latest";
    }
    .nowrap {
        white-space: nowrap;
    }
    .star{
        min-width: 20px;
        min-height: 20px;
        background-repeat: no-repeat;
    }
    .star.star-true {
        background-image: url("{% static 'app_manager/img/star-filled.svg' %}");
    }
    .star.star-false {
        background-image: url("{% static 'app_manager/img/star-empty.svg' %}");
    }
    .star.star-error:after {
        content: "Error";
    }
</style>
{% endblock %}
{% block form-view %}
    <form id="make-new-build" action="{% url corehq.apps.app_manager.views.save_copy domain app.id %}" method="post">
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <input type="hidden" name="comment" value="" />
        <input type="submit" value="Make New Build" />
    </form>
    {% if build_errors %}
    <div class="message">
        Build Failed!
        <ul id="build-errors">
            {% for error in build_errors %}
            <li>
                <span>
            {% if error.type == "invalid xml" %}
                {% if error.form.content %}
                    Invalid xml in form
                {% else %}
                    Blank form
                {% endif %}
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "no ref detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses referrals but doesn't have
                detail screens configured for referrals.
            {% endif %}
            {% if error.type == "no case detail" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">
                    {{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have
                detail screens configured for cases.
            {% endif %}
            {% if error.type == "no modules" %}
                This application has no modules.
            {% endif %}
            {% if error.type == "no forms" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                has no forms.
            {% endif %}
            {% if error.type == "no case type" %}
                Module
                <a href="{% url view_module domain app.id error.module.id %}">{{ error.module.name|trans:langs }}</a>
                uses cases but doesn't have a
                case type defined.
            {% endif %}
            {% if error.type == "form error" %}
                One or more forms are invalid: check all your forms for error messages.
            {% endif %}
            {% if error.type == "missing languages" %}
                {% include "app_manager/partials/form_error_message.html" %} missing languages:
                {% for lang in error.missing_languages %}
                    {{ lang }}
                {% endfor %}
            {% endif %}
            {% if error.type == "duplicate xmlns" %}
                You have two forms with the xmlns "{{ error.xmlns }}"
            {% endif %}
            {% if error.type == "update_case uses reserved word" %}
                Case Update uses reserved word "{{ error.word }}"
                in form
                {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "update_case word illegal" %}
                Case Update "{{ error.word }}" should start with a letter and only contain letters, numbers, '-', and '_'
                in form {% include "app_manager/partials/form_error_message.html" %}
            {% endif %}
            {% if error.type == "path error" %}
                The case configuration in form
                {% include "app_manager/partials/form_error_message.html" %}
                contains the invalid path "{{ error.path }}".
            {% endif %}
            {% if error.type == "remote error" %}
                Remote Error: {{ error.message }}
            {% endif %}
            {% if error.type == "empty lang" %}
                One of your languages is empty. Check your <a href="{% url view_app domain app.id %}">app settings</a>.
            {% endif %}
                </span>
                <span>{{ error.message }}</span>
            </li>
            {% endfor %}
        </ul>
        <p class="help-block">
            For more information on build errors, please see
            <a href="https://confluence.dimagi.com/display/commcarepublic/Errors+Building+an+Application" target="_blank">
                Errors Building an Application
            </a>
        </p>
    </div>
    {% endif %}
    <div id="releases-table">
        {% include 'app_manager/partials/releases.html' %}
    </div>
{% endblock %}