{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load url_extras %}
{% load timezone_tags %}
{% load hq_shared_tags %}
{% load timezone_tags %}
{% load i18n %}
{% block js %}{{ block.super }}
    <script src="{% static 'hqwebapp/javascripts/knockout.mapping.js' %}"></script>
    <script src="{% static 'hqwebapp/js/knockout-bindings.js' %}"></script>
    <script src="{% static 'app_manager/js/releases.js' %}"></script>
{% endblock %}
{% block js-inline %}{{ block.super }}
<script>
    $(function () {
        // init releases
        var urls = {
            fetch: '{% url paginate_releases domain app.id %}',
            delete: '{% url corehq.apps.app_manager.views.delete_copy domain app.id %}',
            emulator: '{% url emulator domain '___' %}',
            cloudcare: '{% url cloudcare_get_app domain '___' %}',
            jad: '{% url corehq.apps.app_manager.views.download_jad domain '___' %}',
            jar: '{% url corehq.apps.app_manager.views.download_jar domain '___' %}',
            odk: '{% url corehq.apps.app_manager.views.odk_install domain '___' %}',
            source: '{% url download_index domain '___' %}',
            release: '{% url release_build domain app.id '___' %}',
            newBuild: '{% url corehq.apps.app_manager.views.save_copy domain app.id %}',
            revertBuild: '{% url corehq.apps.app_manager.views.revert_to_copy domain app.id %}'
        };
        var o = {
            users_cannot_share: {{ users_cannot_share|JSON }},
            urls: urls,
            appVersion: {% if app.version %}{{ app.version }}{% else %}-1{% endif %}
        };
        var el = $('#releases-table');
        ko.applyBindings(new ReleasesMain(o), el.get(0));
        el.show();
        {# This currently doesn't work because of a bootstrap update, #}
        {# but no one's asked for it back so it doesn't seem urgent. #}
        {% comment %}
        {% if edit %}
            $(document).popover({
                placement: 'left',
                title: 'Release Build',
                selector: '.star-false',
                trigger: 'hover',
                content: (
                        "Once you've fully tested an application, you can star it to mark it as released. " +
                                "When a CommCare application searches for updates, only starred builds will be considered."
                        )
            });
            $(document).popover({
                placement: 'left',
                title: 'Retract Build',
                selector: '.star-true',
                trigger: 'hover',
                content: (
                        "We recommend caution when retracting a build. Although " +
                                "this build will no longer be considered when a CommCare application searches for updates, " +
                                "it will not be purged from phones onto which it has already been downloaded."
                        )
            });
        {% endif %}
        {% endcomment %}
    });
</script>
{% endblock %}
{% block head %}{{ block.super }}
<style>
    .build:hover {
        color: black !important;
    }
    .build.build-unreleased {
        color: #888;
    }
    .build.build-released {
    }
    .build.build-latest-release {
        background-color: #EFEFFF;
    }
    .build.build-latest-release .build-is-released:after{
        content: "Latest";
    }
    .nowrap {
        white-space: nowrap;
    }
    .star, .pending {
        width: 20px;
        height: 20px;
        background-repeat: no-repeat;
    }
    .star.star-true {
        background-image: url("{% static 'app_manager/img/star-filled.svg' %}");
    }
    .star.star-false {
        background-image: url("{% static 'app_manager/img/star-empty.svg' %}");
    }
    .pending, .star-pending {
        background-image: url("{% static 'hqwebapp/img/ajax-loader.gif' %}");
        background-size: 80%;
        background-position: center;
        max-height: 50px;
    }
    .star.star-error:after {
        content: "Error";
    }
</style>
{% endblock %}
{% block form-view %}
    <div id="releases-table">
        {% include 'app_manager/partials/releases.html' %}
    </div>
{% endblock %}