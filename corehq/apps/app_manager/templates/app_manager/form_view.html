{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load hq_shared_tags %}
{% block head %}
    {{ block.super }}
    <style>
        .casexml ul {
            margin-left: 15px;
        }
        .no-edit-select {
            font-weight: bold;
            color: #444;
        }
        input[type="radio"]{
            margin: 3px 5px 5px 0px;
        }
    </style>
    <script src="{{ STATIC_URL }}app_manager/js/ejs.min.js"></script>
{#    <script src="{{ STATIC_URL }}app_manager/js/ejs_fulljslint.js"></script>#}
    <script src="{{ STATIC_URL }}app_manager/js/casexml-004.js"></script>
    <script src="{{ STATIC_URL }}app_manager/js/langcodeVerifier-6214661a.js"></script>

    <script src="{{ STATIC_URL }}syntaxhighlighter/scripts/shCore.js"></script>
    <script src="{{ STATIC_URL }}syntaxhighlighter/scripts/shBrushXml.js"></script>
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}syntaxhighlighter/styles/shCoreDefault.css"/>
    
    <script>
        $(function(){
            (function doStyling() {
                $(".xml-source").dialog({height: 700, width: 900});
            })();
            (function doFileUploadCheck(){
                $("#xform_file_input").change(function(){
                    if ($(this).val()) {
                        $("#xform_file_submit").show();
                    } else {
                        $("#xform_file_submit").hide();
                    }
                }).trigger('change');
            })();
            (function configNonChromeWarning() {
                
                if ($.browser.webkit) {
                    $("#nonChromeWarning").hide();
                } else {
                    $("#nonChromeWarning").show();
                    $("#editXFormWrapper").css({backgroundColor: "yellow"}).
                            find('input[type="submit"]').button('disable');
                }
            }());
            (function configXFormSourceAjax(){
                $("#xform-source-opener").click(function (){
                    $("#xform-source").text("Loading...");
                    $.get($(this).attr('href'), function (data) {
                        var brush = new SyntaxHighlighter.brushes.Xml();
                        brush.init({ toolbar: false });
                        // brush.getDiv seems to escape inconsistently, so I'm helping it out
                        data = data.replace(/&/g, '&amp;');
                        $("#xform-source").html(brush.getDiv(data));
                    }, 'json');
                });
            }());
            var edit = {% if edit %}true{% else %}false{% endif %};
            var langcodeValidator = new LangcodeValidator({
                home: 'langcode_validator',
                langcodes: {{ xform_languages|JSON }},
                edit: edit,
                renameURL: "{% url corehq.apps.app_manager.views.rename_language app.domain form.unique_id %}",
            });
            var form_empty = {% if form.source %}false{% else %}true{% endif %};
        {% if not is_user_registration %}
            if (!form_empty) {
                var casexml = new CaseXML({
                    home: $('#casexml_home'),
                    actions: {{ form.actions|JSON }},
                    questions: {{ xform_questions|JSON }},
                    edit: edit,
                    save_url: "{% url corehq.apps.app_manager.views.edit_form_actions app.domain app.id module.id nav_form.id %}",
                    requires: "{{ form.requires }}",
{#                    save_requires_url: "{% url corehq.apps.app_manager.views.edit_form_attr domain app.id form.get_unique_id  'requires' %}",#}
                    reserved_words: {{ case_reserved_words_json|JSON }}
                });
                casexml.init();
            }
        {% endif %}
        });
    </script>
{% endblock %}
{% block form-view %}
    {% if edit and not is_user_registration %}
        <div class="delete-me">
            <form action="{% url delete_form domain app.id module.id form.id %}" method="post">
                <a class="submit" href="#">
                    <span class="ui-icon ui-icon-trash"></span>
                    Delete this form
                </a>
            </form>
        </div>
    {% endif %}
    {% if is_user_registration %}
        <h3>User Registration</h3>
    {% else %}
        <h3 class="variable-form_name">{{ form.name|trans:langs }}</h3>
    {% endif %}
    {% if xform_errors %}
        <div class="warning padded">
            <p>Your XForm is not valid XML:</p>
            <p>{{ xform_errors }}</p>
        </div>
    {% endif %}
    {% if nav_form %}
        <h4>Form Settings</h4>
        <div class="config">
            <form class="save-button-form" action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id form.get_unique_id  'name' %}">
                <div class="save-button-holder"></div>
                <table>
                    {% if edit %}
                        <tr>
                            <th>Form Name</th>
                            <td>
                                <input class="wide" type="text" name="name" value="{{ form.name|trans:langs }}" />
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <th>Form Name</th>
                            <td>
                                {{ form.name|trans:langs }}
                            </td>
                        </tr>
                    {% endif %}
                </table>
            </form>
        </div>
    {% endif %}

        <h4>XForm</h4>
    <table class="config">
        {% if edit %}
            <tr>
                <th>Edit XForm</th>
                <td>
                    <a href="./source/">{% if form.source %}Edit{% else %}Create{% endif %} in Vellum (New!)</a>
                        or
                    {% if not is_user_registration %}
                        <form method="POST" id="editXFormWrapper" action="{% url xep_hq_server.views.initiate form.get_unique_id %}" style="display: inline">
                            {% csrf_token %}
                            <input type="hidden" name="callback" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                            <input type="hidden" name="editor" value="{{ editor_url }}" />

                            <input type="submit" value="{% if form.source %}Edit{% else %}Create{% endif %}â€¦" />
                            <span id="nonChromeWarning" style="font-size: .9em; display: none">
                                Google Chrome only
                            </span>
                        </form>
                      or
                    {% endif %}
                    <a class="dialog_opener" href="#">Upload XForm</a>
                    <div class="dialog" title="Upload XForm">
                        <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id form.get_unique_id  'xform' %}" method="POST" enctype="multipart/form-data">
                            <input id="xform_file_input" type="file" name="xform" />
                            <input type="hidden" name="ajax" value="false" />
                            <input id="xform_file_submit"type="submit" value="Upload" />
                        </form>
                    </div>
                </td>
            </tr>
        {% endif %}
        {% if form.source %}
            <tr>
                <th>Demo this form</th>
                <td>
                    <form method="POST" action="{{ XFORMPLAYER_URL }}" style="display: inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                        <input type="hidden" name="data" value="{}" />
                        <textarea class="hidden" name="xform">{{ form.source }}</textarea>
                        <input type="radio" name="input_mode" value="type" checked="checked" /> Web Entry &nbsp;&nbsp;
                        <input type="radio" name="input_mode" value="touch" /> Touchscreen Entry &nbsp;&nbsp;
                        <input type="submit" value="Try it!" />
                    </form>
                </td>
            </tr>
            <tr>
                <th>
                    View XForm
                </th>
                <td>
                    <a id="xform-source-opener" class="dialog_opener"
                    {% if is_user_registration %}
                       href="{% url get_user_registration_source domain app.id %}">
                    {% else %}
                       href="{% url get_xform_source domain app.id module.id form.id %}">
                    {% endif %}
                        View Source XML
                    </a>
                    <div class="xml-source dialog" title="XML Source">
                        Double-click to select all.
                        <pre id="xform-source" class="brush: xml;"></pre>
                    </div>
                    or
                    {% if is_user_registration %}
                       <a href="{% url get_user_registration_source domain app.id %}?download=true">Download XForm</a>
                    {% else %}
                       <a href="{% url get_xform_source domain app.id module.id form.id %}?download=true">Download XForm</a>
                    {% endif %}

                </td>
            <tr>
                <th>Languages in this XForm</th>
                <td>
                    <div id="langcode_validator"></div>
                </td>
            </tr>
        {% else %}
            {% if not edit %}
                <tr><td class="warning">
                    You have not yet created or uploaded a form.
                </td></tr>
            {% endif %}
        {% endif %}
    </table>

    {% if form.source and not is_user_registration %}
        <h4>Cases and Referrals <span class="help-link" data-help-key="app_manager/casexml_overview"></span></h4>
        <div class="help-text" data-help-key="app_manager/casexml_overview"></div>
        <div class="casexml config" id="casexml_home">
        </div>
    {% endif %}

    <div id="questions"></div>
{% endblock %}
