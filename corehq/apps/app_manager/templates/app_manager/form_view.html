{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% block head %}
    {{ block.super }}
    <style>
        .casexml ul {
            margin-left: 15px;
        }
    </style>
    <script>
        function doStyling() {
            $(".xml-source").dialog({height: 700, width: 900});
        }
        function initCondition() {
            $condition = $("#condition-template");
            $condition.removeAttr("id").remove();
            $('.casexml .action .config .condition').html($condition.html());
        }
        function truncateLabel(label) {
            var MAXLEN = 40;
            return (label.length <= MAXLEN) ? (label) : (label.slice(0, MAXLEN) + "...");
        }
        function makeConditionInteractive(questions) {
            $(".condition select[name='condition-question']").change(function(){
                $answers = $(this).next("select[name='condition-answer']");
                $answers.html("");
                value = $(this).attr('value');
                found = false;
                for(i in questions) {
                    q = questions[i];
                    if(q.value == value) {
                        found = true;
                        break;
                    }
                }
                if(found){
                    $answers.show();
                    for(i in q.options) {
                        o = q.options[i];
                        option = "<option value='" + o.value + "' title='" + o.label + "'>" +
                                truncateLabel(o.label)
                                + "</option>";
                        $answers.append($(option));
                    }
                }
            });
        }
        function escapeQuotes(string){
            return string.replace("'", "&apos;").replace("\"", "&quot;");
        }
        function populateQuestions(questions) {
            $("select.questions").each(function(){
                //$answers = $(this).next("select[name='trigger_answer']");
                //$answers.hide();
                for(i in questions) {
                    q = questions[i];
                    if(($(this).hasClass("questions-all")) ||
                       ($(this).hasClass('questions-select1') && q.tag == "select1") ||
                       ($(this).hasClass('questions-select') && q.tag == "select") ||
                       ($(this).hasClass('questions-input') && q.tag == "input")) {
                        option = "<option value='" + q.value + "' title='" + escapeQuotes(q.label) + "'>" + truncateLabel(q.label) + "</option>";
                        $(this).append($(option));
                    }
                }
            });
        }
        function add_update_row(){
            $new_row = initUpdateCase.template.clone();
            $new_row.addClass('action-update');
            $("#update-case-config").find('table').append($new_row);
        }
        function initUpdateCase() {
            $update_template = $("#action-update-template");
            $update_template.removeAttr("id").remove();
            initUpdateCase.template = $update_template;

            add_update_row();

            $('.casexml [name="action-update-value"]').live('change', function (){
                if($(this).closest('tr').is(':last-child')) {
                    add_update_row();
                }
            });
        }
        function checkboxShowHide($checkbox, f_or_things){
            // makes $checkbox toggle an element or elements given by f_or_things
            // f_or_things is either a jquery set (things)
            // or a function (f) that returns a jquery set based on $checkbox
            // (which inside the function would be called `this`
            $checkbox.change(function(){
                if(typeof f_or_things == 'function') {
                    $things = f_or_things.apply(this);
                } else {
                    $things = f_or_things;
                }

                that = this;
                $things.each(function(){
                    if($(that).is(":checked")) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }).trigger('change');
        }
        function generateCasexmlJson(){
            actions = {};
            function lookup(root, key){
                return $(root).find('[name="' + key + '"]').attr('value');
            }
            $(".casexml .action").each(function(){

                $checkbox = $(this).find('input[type="checkbox"]');
                if(!$checkbox.is(":checked")) return;
                action = {};
                id = $checkbox.attr('id').replace('-','_');
                if(id=="update_case") {
                    action.update = {};
                    $('.action-update', this).each(function(){
                        key = lookup(this, "action-update-key");
                        val = lookup(this, "action-update-value");
                        if(key || val) {
                            action.update[key] = val;
                        }
                    });
                }
                else if (id=="open_referral" || id=="open_case") {
                    action.name_path = lookup(this, 'name_path');
                }
                else if (id=="update_referral") {
                    action.followup_date = lookup(this, 'followup_date');
                }
                action.condition = {'type': 'always'}; // default value
                $('.condition', this).each(function(){ // there is only one
                    action.condition = {};
                    action.condition.type = $('input[name="if"]', this).is(':checked') ? 'if' : 'always';
                    if(action.condition.type == 'if') {
                        action.condition.question = lookup(this, 'condition-question');
                        action.condition.answer = lookup(this, 'condition-answer');
                    }
                });
                actions[id] = action;

            });
            return JSON.stringify(actions);
        }
        function populateCasexmlForm(actions){
            //actions = JSON.parse(actions);
            function is_active(action) {
                return action.condition && action.condition.type in {'if': true, 'always': true};
            }
            for(a in actions) {
                action = actions[a];                
                if(!is_active(action)) continue;
                id = a.replace('_', '-');
                $checkbox = $("#"+id);
                $action = $checkbox.parent();
                $checkbox.attr('checked', true).trigger('change');

                if(action.condition.type == 'if') {
                    $if = $('.condition input[name="if"]', $action);
                    $if.attr('checked', true).trigger('change');
                    $('.condition [name="condition-question"]', $action).attr('value', action.condition.question).trigger('change');
                    $('.condition [name="condition-answer"]', $action).attr('value', action.condition.answer);
                }

                if(a == 'update_case') {

                    update = action.update;
                    for(key in update) {
                        val = update[key];
                        $row = $('.action-update:last-child');
                        $('[name="action-update-key"]', $row).attr('value', key);
                        $('[name="action-update-value"]', $row).attr('value', val)
                                .trigger('change'); // create new row
                    }
                }
                else if(a == "open_referral" || a == "open_case") {
                    name_path = action.name_path;
                    $('[name="name_path"]', $action).attr('value', name_path);
                }
                else if(a == "update_referral") {
                    followup_date = action.followup_date;
                    $('[name="followup_date"]', $action).attr('value', followup_date);
                }
            }
        }
        function get_actions() {
            return JSON.parse($("#casexml_json").text());
        }
        $(function(){
            doStyling();
            initCondition();
            $("#casexml_json, #xform_questions").hide();
            var questions = JSON.parse($("#xform_questions").text());
            if(questions.length) {
                populateQuestions(questions);

                makeConditionInteractive(questions);
                initUpdateCase();
                populateCasexmlForm(get_actions());
                $(".casexml").delegate('*', 'change', function(){
                    // recompute casexml_json
                    $("#casexml_json").text(generateCasexmlJson());
                }).find('*').first().trigger('change');
                $(".no-edit *").each(function(){
                    if( ($(this).is('input[type="checkbox"]') && !$(this).is(":checked")) ||
                        (($(this).is('input[type="text"]') || $(this).is('select')) && !$(this).attr('value')) ||
                        ($(this).is('input[type="submit"]'))){
                        $(this).parent().hide();
                    }
                }).attr("disabled", true);
                if($('.no-edit').size()) {
                    no_actions = true;
                    actions = get_actions();
                    for(i in actions) {
                        no_actions = false;
                        break;
                    }
                    if(no_actions) {
                        $("#no_casexml_actions").show();
                    }
                }
                //checkboxShowHide($("#open-case"), $("#update-case, #open-referral").parent());
                //checkboxShowHide($(".action input[type='checkbox']"), function(){return $(this).next();});
            }
        });
    </script>
{% endblock %}
{% block form-view %}
    <h3 class="variable-form_name">{{ form.name|trans:langs }}</h3>
    {% if xform_errors %}
        <div class="warning padded">
            <p>Your XForm is not valid XML:</p>
            <p>{{ xform_errors }}</p>
        </div>
    {% endif %}
    <h4>Form Settings</h4>
    <table class="config">
        {% if edit %}
            <tr>
                <th>Form Name</th>
                <td>
                    <!-- autosave hijacks the form so that it sends automatically in the background-->
                    <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'name' %}">
                        <input class="autosave wide" type="text" name="name" value="{{ form.name|trans:langs }}" />
                    </form>
                </td>
            </tr>
{#            <tr>#}
{#                <th>Show Count</th>#}
{#                <td>#}
{#                    <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'show_count' %}">#}
{#                        <select class="autosave code" name="show_count">#}
{#                            <option value="True">True</option>#}
{#                            <option value="False" {% if not form.show_count %}selected="true"{% endif %}>False</option>#}
{#                        </select>#}
{#                    </form>#}
{#                </td>#}
{##}
{#            </tr>#}
        {% else %}
            <tr>
                <th>Form Name</th>
                <td>
                    {{ form.name|trans:langs }}
                </td>
            </tr>
{#            <tr>#}
{#                <th>Show Count</th>#}
{#                <td>#}
{#                    <code>{% if form.show_count %}True{% else %}False{% endif %}</code>#}
{#                </td>#}
{#            </tr>#}
        {% endif %}
    </table>


        <h4>XForm</h4>
    <table class="config">
        <!--tr>
            <th>XMLNS</th>
            <td>{{ form.xmlns }}</td>
        </tr-->
        {% if edit %}
            <tr>
                <th>Edit XForm</th>
                <td>
                     <form method="POST" action="{% url xep_hq_server.views.initiate form.get_unique_id %}">
                        {% csrf_token %}
                        <input type="hidden" name="callback" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                        <input type="hidden" name="editor" value="{{ editor_url }}" />

                        <input type="submit" value="{% if form.contents %}Edit{% else %}Create{% endif %}…" />
                    </form>
                </td>
                <td>
                    or 
                    <a class="dialog_opener" href="#">Upload XForm</a>
                    <div class="dialog" title="Upload XForm">
                        <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'xform' %}" method="POST" enctype="multipart/form-data">
                            <input type="file" name="xform" />
                            <input type="hidden" name="ajax" value="false" />
                            <input type="submit" value="Upload" />
                        </form>
                    </div>
                </td>
            </tr>
        {% endif %}
        {% if form.contents %}
            <tr>
                <th>
                    View XForm
                </th>
                <td>
                    <form method="POST" action="{{ XFORMPLAYER_URL }}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                        <input type="hidden" name="data" value="{}" />
                        <textarea class="hidden" name="xform">{{ form.contents }}</textarea>


                        <input type="submit" value="Play…" />
                    </form>
                </td>
                <td>
                    or
                    <a class="dialog_opener" href="#">View Source XML</a>
                    <div class="xml-source dialog" title="XML Source">
                        <pre>{{ form.contents }}</pre>
                    </div>
                </td>
            </tr>
        {% else %}
            {% if not edit %}
                <tr><td class="warning">
                    You have not yet created or uploaded a form.
                </td></tr>
            {% endif %}
        {% endif %}
    </table>

    <!-- Case XML -->
    <div id="condition-template" class="condition">
        <input type="checkbox" name="if" /> If
        <span>
             the answer to
            <select class="questions questions-select1" name="condition-question">
                <option value="" disabled="" selected="">Select a question</option>
            </select>
            is
            <select name="condition-answer">
                <option value="" disabled="" selected="">Select an answer</option>
            </select>
        </span>
    </div>
    {% if form.contents %}
        <h4>Cases and Referrals</h4>
        {% if xform_questions != "[]" %}
            <div class="casexml {% if not edit %}no-edit{% endif %} config">
                <ul>
                    <li>
                        <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'requires' %}" method="post">
                            Requires
                            <select class="autosave" name="requires" data-value="{{ form.requires }}">
                                <option value="none">neither a case nor a referral</option>
                                <option value="case">just a case</option>
                                <option value="referral">a case and a referral</option>
                            </select>
                            <input type="hidden" name="ajax" value="false" />
                        </form>
                    </li>
                </ul>
                <ul>
                    {% if form.requires == "none" %}
                        <li class="action">
                            <input type="checkbox" id="open-case"><label for="open-case">Opens a case</label>
                            <div class="config">
                                <div class="condition"></div>
                                <span>
                                    Name according to question
                                    <select class="questions questions-all" name="name_path">
                                        <option disabled="">Select a question</option>
                                    </select>
                                </span>
                            </div>
                        </li>

                    {% endif %}
                    <li class="action">
                        <input type="checkbox" id="update-case"><label for="update-case">Updates the case</label>
                        <div id="update-case-config">
                            <table class="config">
                                <tr>
                                    <th></th>
                                    <th>Question</th>
                                    <th>Case Property</th>
                                </tr>
                                <tr id="action-update-template" class="action-update">
                                    <td></td>
                                    <td>
                                        <select class="questions questions-all" name="action-update-value">
                                            <option></option>
                                        </select>
                                    </td>
                                    <td><input class="code" type="text" name="action-update-key" /></td>
                                </tr>

                            </table>
                        </div>
                    </li>
                    {% if form.requires != "none" %}
                        <li class="action">
                            <input type="checkbox" id="close-case"><label for="close-case">Closes the case</label>
                            <div class="config">
                                <div class="condition"></div>
                            </div>
                        </li>
                    {% endif %}
                    {% if form.requires != "referral" %}
                        <li class="action">
                            <input type="checkbox" id="open-referral"> <label for="open-referral">Opens a referral</label>
                            <div class="config">
        {#                        <div class="condition"></div>#}
                                <span>
                                    Name according to question
                                    <select class="questions questions-select questions-select1" name="name_path">
                                        <option disabled="">Select a question</option>
                                    </select>
                                </span>
                            </div>
                        </li>
                    {% endif %}
                    {% if form.requires == "referral" %}
                        <li class="action">
                            <input type="checkbox" id="update-referral"> <label for="update-referral">Updates the referral</label>
                            <div class="config">
        {#                        <div class="condition"></div>#}
                                <span>
                                    Change followup date to
                                    <select class="questions questions-input" name="followup_date">
                                        <option disabled="">Select a question</option>
                                    </select>
                                </span>
                            </div>
                        </li>
                        <li class="action">
                            <input type="checkbox" id="close-referral"> <label for="close-referral">Closes the referral</label>
                            <div class="config">
                                <div class="condition"></div>
                            </div>
                        </li>
                    {% endif %}
                    <li class="hidden" id="no_casexml_actions">This form does not perform any actions.</li>
                </ul>
                <form action="{% url corehq.apps.app_manager.views.edit_form_actions app.domain app.id module.id form.id %}" method="POST">
                    <textarea id="casexml_json" class="hidden" name="actions" >{{ form_actions }}</textarea><br/>
                    <input type="submit" value="Save Actions"/>
                </form>
            </div>
        {% else %} {# if not questions #}
            <p class="warning">
                I'm unable to get a list of questions from your form. This may mean that your form is corrupted or
                malformed.
            </p>
        {% endif %}
    {% endif %}
    <!-- end CaseXML -->
    <div>
        {# <a href="{% url corehq.apps.app_manager.views.xform_display app.domain form.get_unique_id %}">XForm Display</a> #}
        <!--input type="hidden" id="xform_questions_url" value="{% url corehq.apps.app_manager.views.xform_display app.domain form.get_unique_id %}?lang={{ lang }}" /-->
        <div id="xform_questions">{{ xform_questions }}</div>
    </div>
    <div id="questions"></div>
{% endblock %}
