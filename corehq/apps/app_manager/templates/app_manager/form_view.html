{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% block head %}
    {{ block.super }}
    <style>
        .casexml ul {
            margin-left: 15px;
        }
    </style>
    <script src="{{ STATIC_URL }}app_manager/js/ejs.min.js"></script>
    <script src="{{ STATIC_URL }}app_manager/js/casexml.js"></script>
    
    <script>
        $(function(){
            (function doStyling() {
                $(".xml-source").dialog({height: 700, width: 900});
            })();
            var casexml = new CaseXML({
                home: "casexml_home",
                actions: {{ form_actions|safe }},
                questions: {{ xform_questions|safe }},
                edit: {% if edit %}true{% else %}false{% endif %},
                save_url: "{% url corehq.apps.app_manager.views.edit_form_actions app.domain app.id module.id form.id %}",
                requires: "{{ form.requires }}",
                save_requires_url: "{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'requires' %}",
            });
            casexml.init();
        });
    </script>
    {% include "app_manager/partials/casexml.html" %}
{% endblock %}
{% block form-view %}
    <h3 class="variable-form_name">{{ form.name|trans:langs }}</h3>
    {% if xform_errors %}
        <div class="warning padded">
            <p>Your XForm is not valid XML:</p>
            <p>{{ xform_errors }}</p>
        </div>
    {% endif %}
    <h4>Form Settings</h4>
    <table class="config">
        {% if edit %}
            <tr>
                <th>Form Name</th>
                <td>
                    <!-- autosave hijacks the form so that it sends automatically in the background-->
                    <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'name' %}">
                        <input class="autosave wide" type="text" name="name" value="{{ form.name|trans:langs }}" />
                    </form>
                </td>
            </tr>
{#            <tr>#}
{#                <th>Show Count</th>#}
{#                <td>#}
{#                    <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'show_count' %}">#}
{#                        <select class="autosave code" name="show_count">#}
{#                            <option value="True">True</option>#}
{#                            <option value="False" {% if not form.show_count %}selected="true"{% endif %}>False</option>#}
{#                        </select>#}
{#                    </form>#}
{#                </td>#}
{##}
{#            </tr>#}
        {% else %}
            <tr>
                <th>Form Name</th>
                <td>
                    {{ form.name|trans:langs }}
                </td>
            </tr>
{#            <tr>#}
{#                <th>Show Count</th>#}
{#                <td>#}
{#                    <code>{% if form.show_count %}True{% else %}False{% endif %}</code>#}
{#                </td>#}
{#            </tr>#}
        {% endif %}
    </table>


        <h4>XForm</h4>
    <table class="config">
        <!--tr>
            <th>XMLNS</th>
            <td>{{ form.xmlns }}</td>
        </tr-->
        {% if edit %}
            <tr>
                <th>Edit XForm</th>
                <td>
                     <form method="POST" action="{% url xep_hq_server.views.initiate form.get_unique_id %}">
                        {% csrf_token %}
                        <input type="hidden" name="callback" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                        <input type="hidden" name="editor" value="{{ editor_url }}" />

                        <input type="submit" value="{% if form.contents %}Edit{% else %}Create{% endif %}…" />
                    </form>
                </td>
                <td>
                    or 
                    <a class="dialog_opener" href="#">Upload XForm</a>
                    <div class="dialog" title="Upload XForm">
                        <form action="{% url corehq.apps.app_manager.views.edit_form_attr domain app.id module.id form.id  'xform' %}" method="POST" enctype="multipart/form-data">
                            <input type="file" name="xform" />
                            <input type="hidden" name="ajax" value="false" />
                            <input type="submit" value="Upload" />
                        </form>
                    </div>
                </td>
            </tr>
        {% endif %}
        {% if form.contents %}
            <tr>
                <th>
                    View XForm
                </th>
                <td>
                    <form method="POST" action="{{ XFORMPLAYER_URL }}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ URL_BASE }}{{ request.get_full_path|safe}}" />
                        <input type="hidden" name="data" value="{}" />
                        <textarea class="hidden" name="xform">{{ form.contents }}</textarea>


                        <input type="submit" value="Play…" />
                    </form>
                </td>
                <td>
                    or
                    <a class="dialog_opener" href="#">View Source XML</a>
                    <div class="xml-source dialog" title="XML Source">
                        <pre>{{ form.contents }}</pre>
                    </div>
                </td>
            </tr>
        {% else %}
            {% if not edit %}
                <tr><td class="warning">
                    You have not yet created or uploaded a form.
                </td></tr>
            {% endif %}
        {% endif %}
    </table>

    {% if form.contents %}
        <div id="casexml_home">
        </div>
    {% endif %}

    <div id="questions"></div>
{% endblock %}
