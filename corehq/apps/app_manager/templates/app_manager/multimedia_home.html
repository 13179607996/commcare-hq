{% extends base_template %}
{% load multimedia_tags %}
{% block js-inline %}{{ block.super }}
    <script>
    (function () {
        var HOME_URL = "{% url corehq.apps.app_manager.views.view_app domain app.get_id %}";
        // hat tip: http://stackoverflow.com/questions/985272/jquery-selecting-text-in-an-element-akin-to-highlighting-with-your-mouse/2838358#2838358
        function selectElementText(el, win) {
		    win = win || window;
		    var doc = win.document, sel, range;
		    if (win.getSelection && doc.createRange) {
		        sel = win.getSelection();
		        range = doc.createRange();
		        range.selectNodeContents(el);
		        sel.removeAllRanges();
		        sel.addRange(range);
		    } else if (doc.body.createTextRange) {
		        range = doc.body.createTextRange();
		        range.moveToElementText(el);
		        range.select();
		    }
		}

        $(function () {
            $( "#dialog" ).dialog({
                autoOpen: false,
                width: 550,
                open: function(event, ui) {
                    var af = $($(".active_file"));
                    var forms = af.data("formdata");
                    var refs = af.data("module-count");
                    var contents = "<h2>Information for " + af.text() + "</h2>";
                    contents += "<p>References: " + refs + "</p>"
                    contents += "<h3>Found in forms:</h3><ul>";
                    for (var i = 0; i < forms.length; i++) {
                        contents += "<li><a href='" + HOME_URL + "?m=" +forms[i].module + "&f=" + forms[i].form + "'>" +
                                    forms[i].display + "</a></li>";
                    }
                    contents += "</ul>"
                    $(this).html(contents);
                }
            });
            $( ".opener" ).click(function() {
                // i'm sure there's a smarter way to do this
                $("#dialog").dialog('close');
                $(".active_file").removeClass("active_file");
                $(this).addClass("active_file");
                $( "#dialog" ).dialog("open");
                return false;
            });
            $('.scary-settings').each(function () {
                var $scarySettings = $(this).addClass('ui-corner-bottom'),
                    $toggleBar = $(this).prev(".scary-settings-toggle").addClass('ui-corner-top'),
                    $toggleLink = $toggleBar.find('a'),
                    hidden = true;
                function setHidden(h) {
                    var closedIcon = 'ui-icon-triangle-1-e',
                        openedIcon = 'ui-icon-triangle-1-s',
                        openedClass = 'scary-settings-toggle-open';
                    if (hidden != h) {
                        $scarySettings.slideToggle();
                    } else if (hidden) {
                        $scarySettings.hide();
                    }
                    hidden = h;
                    if (hidden) {
                        $toggleBar.find('.ui-icon').addClass(closedIcon).removeClass(openedIcon);
                        $toggleBar.removeClass(openedClass, 1000);
                    } else {
                        $toggleBar.find('.ui-icon').addClass(openedIcon).removeClass(closedIcon);
                        $toggleBar.addClass(openedClass);
                    }
                }
                setHidden(hidden);
                $toggleLink.click(function () {
                    setHidden(!hidden);
                    return false;
                });
            });


            $("#select_contents").click(function() {
                selectElementText(document.getElementById("filelist"));
            });

            // select all/none
            $("#show_images").click(function() {
                if ($("#show_images").attr("checked")) {
                    $(".imagefile").show();
                } else {
                    $(".imagefile").hide();
                }
            });
            $("#show_audio").click(function() {
                if ($("#show_audio").attr("checked")) {
                    $(".audiofile").show();
                } else {
                    $(".audiofile").hide();
                }
            });
            $("#show_prefix").click(function() {
                $("li.jrfile").map(function(){
                    var text = $(this).text();
                    if ($("#show_prefix").attr("checked")) {
                        if (text.indexOf("jr://file/") !== 0) {
                            $(this).text("jr://file/" + text);
                        }
                    } else {
                        if (text.indexOf("jr://file/") === 0) {
                            $(this).text(text.substring("jr://file/".length, text.length));
                        }
                        // ignore, weird
                    }
                });
            });



        });
    }());
    </script>
{% endblock %}
{% block head %}{{ block.super }}
        <style>
            input[type="checkbox"] {
                margin-right: 1em;
            }
            #config {
                margin: 1em 0 1em 0;
            }
            
            .scary-settings {
                background-color: #FEFEFE;
                border: 1px solid #CCC;
                border-top: none;
                padding: 1em;
            }
            .scary-settings-toggle {
                margin-top: 1em;
                border: 1px solid transparent;
                padding: .5em;
            }
            .scary-settings-toggle-open {
                border: 1px solid #CCC;
                background-color: #EEE;
            }
            .jrfile {
                cursor: pointer;
                color: dark-blue;
            }
            .notice {
                margin: 1em auto 1em auto;
                padding: 1em;
                background: #FFB;
                border: 3px solid #EEA;
            }
        </style>
{% endblock %}

{% block content %}
<div id="main_container">
    <div class="padded">
        <p><a href="{% url corehq.apps.app_manager.views.view_app domain app.get_id %}">Back to App Home</a></p>
        <h1>Multimedia Home</h1>
        <p>This page allows you to export and check the multimedia references in your application.
        You can use these tools to check for missing references and clean up unused audio and 
        image files.</p>
        <br/>
        <h3>The easiest way to get started is the following:</h3>
        <p>1. Download the <a href="{% url corehq.apps.app_manager.views.multimedia_list_download domain app.get_id %}">full file list</a> for your app and name it "list.txt" 
        in your root folder (i.e. the root directory of the SD card)</p>
        <p>2. Download the <a href="https://raw.github.com/dimagi/commcare-hq/master/utilities/checkfiles.py">media checker tool</a> (requires python!) and save it in the
        same directory.</p>
        <p>3. Double click the <code>checkfiles.py</code> file and it should walk you through your options. 
        Press "?" in the tool for a list of instructions.</p>
        <br/>
        <p>You can also explore the file references below</p>
        <div class="scary-settings-toggle">
            <a href="#"><span class="ui-icon"></span>Raw file list</a>
        </div>
        <div class="scary-settings">
            <div id="config">
                <label for="show_images">Show images?</label><input type="checkbox" name="show_images" id="show_images" checked="checked"/>
                <label for="show_audio">Show audio clips?</label><input type="checkbox" name="show_audio" id="show_audio" checked="checked"/>
                <label for="show_audio">show <code> "jr://file/" </code> prefix?</label><input type="checkbox" name="show_prefix" id="show_prefix" checked="checked"/>
                <a href="#" id="select_contents">select all</a>
            </div>
            <div class="notice">Hint: click on a filename for more information.</div>
            <ul id="filelist">
                {% for image, modformlist in images.items %}
                    {% render_mm_node image "image" modformlist %} 
                {% endfor %}
                {% for audio, modformlist in audiofiles.items %}
                    {% render_mm_node audio "audio" modformlist %} 
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<div id="dialog" title="Multimedia Summary">
    <p>This is an animated dialog which is useful for displaying information. The dialog window can be moved, resized and closed with the 'x' icon.</p>
</div>
{% endblock %}