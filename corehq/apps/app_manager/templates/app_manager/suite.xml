  {% load xforms_extras %}
<suite version="{{ app.version }}">

 {% for module in app.get_modules %}
  {% for  form in module.get_forms %}
    <!-- Parse and cache the XForm -->
    <xform>
        <resource id="{{ form.unique_id }}" version="{{ app.version }}">
           <location authority="local">./m{{ module.id }}/f{{ form.id }}.xml</location>
           <location authority="remote">./m{{ module.id }}/f{{ form.id }}.xml</location>
        </resource>
    </xform>
  {% endfor %}
 {% endfor %}

 {% for lang in langs %}
    <!-- Read and locally store the translation strings-->
    <locale language="{{ lang }}">
        <resource id="app_{{ lang }}_strings" version="{{ app.version }}">
           <location authority="local">./{{ lang }}/app_strings.txt</location>
           <location authority="remote">./{{ lang }}/app_strings.txt</location>
        </resource>
    </locale>
 {% endfor %}

 {% for module in app.get_modules %}
  {% for detail in module.details %}
   {% if detail.columns %}
    <!-- Define the short detail model for household cases -->
    <detail id="m{{ module.id }}_{{ detail.type }}">
        <title><text><locale id="m{{ module.id }}.{{ detail.type }}.title"/></text></title>
        <filter><case case-type="{{ module.case_type }}"/></filter>
        <model>
            <data>
                {% for d in detail.columns %}
      	        <{{ d.model }}_{{ d.field }}_{{ forloop.counter }} reference="{{ d.model }}" field="{{ d.field }}"/>
                {% endfor %}
            </data>
        </model>
     {% for d in detail.columns %}
        <field>
            <header><text><locale id="m{{ module.id }}.{{ detail.type }}.{{ d.model }}_{{ d.field }}_{{ forloop.counter }}.header"/></text></header>
         {% ifequal d.format "plain" %}
            <template><text><xpath function="/data/{{ d.model }}_{{ d.field }}_{{ forloop.counter }}"/></text></template>
         {% else %}{% ifequal d.format "date" %}
            <template><text><xpath function="format_date(/data/{{ d.model }}_{{ d.field }}_{{ forloop.counter }}, 'short')"/></text></template>
         {% else %}{% ifequal d.format "advanced" %}
            <template><text><xpath function="{{ d.model }}_{{ d.field }}_{{ forloop.counter }}"/></text></template>
         {% else %}{% if d.format == "enum" or d.format == "enum-image"%}
             <template{% if d.format == "enum-image" %} form="image"{% endif %}><text>
                 <xpath function="
                  {% for key, val in d.enum.items %}
                     if(/data/{{ d.model }}_{{ d.field }}_{{ forloop.parentloop.counter }} = '{{ key }}', ${{ key }},
                  {% endfor %}
                     '?'
                  {% for _ in d.enum %}
                     )
                  {% endfor %}
                 ">
                  {% for key, val in d.enum.items %}
                     <variable name="{{ key }}">
                         <locale id="m{{ module.id }}.{{ detail.type }}.{{ d.model }}_{{ d.field }}_{{ forloop.parentloop.counter }}.enum.{{ key }}{% if d.format == "enum-image" %}.image{% endif %}"/>
                     </variable>
                  {% endfor %}
                 </xpath>
             </text></template>
         {% else %}{% ifequal d.format "years-ago" %}
             <template><text><xpath function="string(int((today() - date(/data/{{ d.model }}_{{ d.field }}_{{ forloop.counter }})) div 365.25))"/></text></template>
         {% endifequal %}{% endif %}{% endifequal %}{% endifequal %}{% endifequal %}

        </field>
     {% endfor %}
    </detail>
   {% endif %}
  {% endfor %}
 {% endfor %}
 {% for module in app.get_modules %}
  {% for form in module.get_forms %}
    <entry>
        <form>{{ form.xmlns }}</form>
        <command id="m{{ module.id }}-f{{ form.id }}">
            <text><locale id="forms.m{{ module.id }}f{{ form.id }}"/></text>
        </command>
     {% if form.requires == "case" or form.requires == "referral" %}
        <entity>
            <type>case</type>
            <reference>case</reference>
        </entity>
     {% endif %}
     {% if form.requires == "referral" %}
        <entity>
            <type>referral</type>
            <reference>referral</reference>
        </entity>
        <details>
           <short id="m{{ module.id }}_ref_short"/>
           <long id="m{{ module.id }}_ref_long"/>
        </details>
     {% endif %}
     {% if form.requires == "case" %}
        <details>
           <short id="m{{ module.id }}_case_short"/>
           <long id="m{{ module.id }}_case_long"/>
        </details>
     {% endif %}
    </entry>
  {% endfor %}
 {% endfor %}
 {% for module in app.get_modules %}
  {% if module.name|trans:app.langs == "root" %}
    <menu id="root">
  {% else %}
    <menu id="m{{ module.id }}">
  {% endif %}
    	<text><locale id="modules.m{{ module.id }}"/></text>
     {% for form in module.get_forms %}
    	<command id="m{{ module.id }}-f{{ form.id }}"/>
     {% endfor %}
    </menu>
 {% endfor %}
</suite>
