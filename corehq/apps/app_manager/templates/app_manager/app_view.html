{% extends "app_manager/managed_app.html" %}
{% load xforms_extras %}
{% load hq_shared_tags %}
{% load i18n %}

{% block js %}{{ block.super }}
    {% if app.get_doc_type == "Application" %}
        <script src="{% static 'app_manager/js/commcareProperties.js' %}"
                xmlns="http://www.w3.org/1999/html"></script>
        <script src="{% static 'translations/js/translations.js' %}"></script>
    {% endif %}
    <script src="{% static 'hqwebapp/js/knockout-bindings.js' %}"></script>
    <script src="{% static 'app_manager/js/supported-languages.js' %}"></script>
{% endblock %}
{% block js-inline %}
    {{ block.super }}
    <script>
        $(function(){
            var version_function = function () {
                var i;
                var options = {{ commcare_build_options|JSON }};
                var app_version = $(this).val();
                var version = options[app_version];
                var commcare_versions = version['options'];
                var commcare_version_val = $('#commcare_version').val() || {{ app_build_spec_string|JSON }};

                var commcare_version_label = $('#commcare_version option:selected').text() || {{ app_build_spec_label|JSON }};
                var superuser = {{ user.is_superuser|BOOL }};
                $('#commcare_version').find('option').remove().end().find('optgroup').remove().end();
                for (i = 0; i < commcare_versions.length; i++) {
                    var option = commcare_versions[i];
                    var superuser_option = option['superuser_only'];
                    if (superuser || !(superuser_option)) {
                        var option_val = version["builds"][i];
                        var option_label = version["labels"][i];
                        $('#commcare_version').append('<option value="' + option_val + '">' + option_label + '</option>');
                    }
                }
                var standard_build = false;
                for (i = 0; i < commcare_versions.length; i++) {
                    if (commcare_version_val === version["builds"][i]) {
                        standard_build = true;
                    }
                }
                if (!standard_build && commcare_version_val != null) {
                    $('#commcare_version').append(
                        $('<optgroup label="Custom">').append('<option value="' + commcare_version_val + '">' + commcare_version_label + '</option>')
                    );
                }
                $('#commcare_version').val(commcare_version_val);

            };

            $('#app_version').change(version_function);
            $('#app_version').each(version_function);

        });
    </script>
    {% if app %}
    <script>
        $(function () {
            var langs = {{ app.langs|JSON }};
            var buildLangs = {{ app.build_langs|JSON }};
            var saveURL = "{% url edit_app_langs domain app.id %}";
            var edit = {{ edit|JSON }};
            var validate = !{{ app.is_remote_app|BOOL }};
            ko.applyBindings(new SupportedLanguages({
                langs: langs,
                buildLangs: buildLangs,
                saveURL: saveURL,
                edit: edit,
                validate: validate
            }), $("#supported-languages").get(0));
        });
    </script>
    {% endif %}
    <script>
        $.fn.password_setter = function (options) {
            var that = this,
                options = options || {},
                title = options.title || "Set Password",
                randID = Math.floor(Math.random() * 1000),
                password1ID = 'password-' + randID + '-1',
                password2ID = 'password-' + randID + '-2',
                message = {
                    RESET: "Reset",
                    LABEL1: "Password",
                    LABEL2: "Repeat Password",
                    OK: "OK",
                    CANCEL: "Cancel",
                    PASSWORD_EMPTY: "You must enter a password.",
                    PASSWORD_MISMATCH: "Try again. The passwords don't match"
                },
                label1 = $('<label/>').attr({'for': password1ID}).text(message.LABEL1),
                label2 = $('<label/>').attr({'for': password2ID}).text(message.LABEL2),
                password1 = $('<input/>').attr({type: 'password', id: password1ID}),
                password2 = $('<input/>').attr({type: 'password', id: password2ID}),
                popupLink = $('<a/>').attr({href: '#'}).text(message.RESET),
                popup = $('<section/>').addClass('password-setter-popup'),
                popupOK = $('<input/>').attr({type: 'submit'}).val(message.OK).button(),
                popupCancel = $('<a/>').attr({href: '#'}).text(message.CANCEL).button(),
                passwordMismatch = $('<p/>').text(message.PASSWORD_MISMATCH),
                passwordEmpty = $('<p/>').text(message.PASSWORD_EMPTY),
                form = $('<form/>').attr({action: ''}),
                undefined = undefined;
            this.hide();
            this.after(popupLink);
            popup.append(
                $('<h1/>').text(title),
                form.append(
                    passwordMismatch,
                    $('<table/>').append(
                        $('<tr/>').append(
                            $('<td/>').append(label1),
                            $('<td/>').append(passwordEmpty, password1)
                        ),
                        $('<tr/>').append(
                            $('<td/>').append(label2),
                            $('<td/>').append(password2)
                        )
                    ),
                    popupOK,
                    popupCancel
                )
            );
            passwordEmpty.hide();
            passwordMismatch.hide();
            popupLink.click(function (e) {
                var position = popupLink.offset();
                e.preventDefault();
                popup.css({
                    display: 'block',
                    position: 'absolute',
                    top: position.top,
                    left: position.left,
                }).addClass('ui-corner-tr ui-corner-br ui-corner-bl shadow');
                $('body').append(popup);
                password1.focus();
            });

            popupCancel.click(function (e) {
                e.preventDefault();
                popup.detach();
            });

            form.submit(function (e) {
                e.preventDefault();
                passwordEmpty.hide();
                passwordMismatch.hide();
                if (password1.val() && password1.val() === password2.val()) {
                    popup.detach();
                    that.val(password1.val()).trigger('textchange');
                } else if (!password1.val()) {
                    passwordEmpty.show();
                } else {
                    passwordMismatch.show();
                }
            });
        };
        $(function () {
            $('#app_admin_password').password_setter({title: 'Admin Password'});
        });
    </script>
    {% if app.doc_type == "Application" %}
        <script>
            $(function () {
                var $translation_ui = $("#translations_ui");
                mk_translation_ui({
                    translations: {{ translations|JSON }},
                    url: "{% url edit_app_translations domain app.id %}",
                    lang: "{{ lang }}",
                    edit: {{ edit|yesno:"true,false" }},
                    $home: $translation_ui
                });
            });
        </script>
        <script>
            $(function () {
                var saveURL = "{% url edit_commcare_profile domain app.id %}",
                    groupMapping = {
                        'sense': '#commcare-sense-properties',
                        'log': '#log-properties',
                        'language': '#language-properties',
                        'default': '#other-commcare-settings'
                    },
                    $block,
                    saveButtonHolder = $('#commcare-settings .save-button-holder');
                $.get('{% url corehq.apps.app_manager.views.commcare_profile domain app.id %}', function (initialValues) {
                    initialValues = JSON.parse(initialValues);
                    $.get('{% static "app_manager/json/custom-commcare-properties.json" %}', function (profile_spec) {
                        var settings = CommcareSettings.wrap(
                            profile_spec,
                            initialValues,
                            function (p) {
                                return $(groupMapping[p.group] || groupMapping['default']);
                            },
                            saveURL,
                            {% if edit %}true{% else %}false{% endif %},
                            saveButtonHolder
                        );
                        $block = settings.render();
                        $block.find('[name="cur_locale"]').addClass('langcodes');
                        COMMCAREHQ.initBlock($block);
                    });
                });
            });
            $(function () {
                $('#show-user-registration-select').change(function () {
                    if (JSON.parse($(this).val())) {
                        $('#user-registration-nav-link').slideDown();
                    } else {
                        $('#user-registration-nav-link').slideUp();
                    }
                });
            });
        </script>
    {% endif %}
    <script>
        $(function(){
            $("#view_source").click(function(){
                $.get($(this).attr('href'), function(data){
                    $("#app_source").text(data);
                });
            });
//            $('.langcodes').langcodes();
        });
        $(function () {
            var appSettings = $("#app-settings"),
                textInput = appSettings.find('[name="text_input"]'),
                buildSpec = appSettings.find('[name="build_spec"]'),
                customKeysExampleOpener = appSettings.find('a[href="#custom-keys-example"]'),
                customKeysExample = $('#custom-keys-example');
            
            var onChangeBuildSpec = function () {
                var build = buildSpec.val().split('.'),
                    customKeys = textInput.find('[value="custom-keys"]');
                build = [parseInt(build[0]), parseInt(build[1])];
                if (build[0] <= 1 && build[1] < 3) {
                    customKeys.attr('disabled', 'true');
                    if (textInput.val() == 'custom-keys') {
                        textInput.val('roman');
                        textInput.trigger('change');
                    }
                } else {
                    customKeys.removeAttr('disabled');
                }
            };
            // proxy for this existing.
            if (buildSpec.val()) {
                onChangeBuildSpec();
	            buildSpec.change(onChangeBuildSpec);
            }
            var customKeysHelp = $('#custom-keys-help');
            customKeysExample.hide();
            customKeysHelp.hide();
            var onChangeTextInput = function () {
                if (textInput.val() == 'custom-keys') {
                    customKeysHelp.slideDown();
                } else {
                    customKeysExample.hide();
                    customKeysHelp.slideUp();
                }
            };
            onChangeTextInput();
            textInput.change(onChangeTextInput);

            customKeysExampleOpener.click(function (e) {
                e.preventDefault();
                customKeysExample.slideToggle();
            });
        });
    </script>
{% endblock %}

{% block head %}{{ block.super }}
    <style>
        .sortable-handle {
            cursor: move;
        }
        #custom-keys-help {
            width: 400px;
            font-size: .9em;
        }
        #custom-keys-help p {
            color: #888;
            vertical-align: bottom;
        }
        #custom-keys-example {
            margin-top: 1em;
        }
        #custom-keys-help ul {
            margin-left: 2em;
        }
        #custom-keys-help li span {
            display: inline-block;
            border: 1px solid #CCC;
            padding: 2px;
            margin: 1px;
        }
        #supported-languages .light {
            color: #BBB;
        }
        #supported-languages td {
            vertical-align: baseline;
        }
        #default-language-help {
            position: absolute;
            /*width: 100%;*/
            border: 1px solid #CCC;
            padding: .5em 1em;
            padding-left: 150px;
            left: 35px;
            background-color: #FFF;
            border-radius: 40px;
        }
        .password-setter-popup {
            background-color: white;
            border: 1px solid #CCC;
            padding: 1em;
        }
        .password-setter-popup h1 {
            text-align: center;
            font-size: 1.2em;
        }
        .password-setter-popup table {
            margin: 0;
        }
        .password-setter-popup .ui-button {
            float: right;
            margin: 5px;
        }
        .password-setter-popup input[type='password'] {
            width: 40px;
        }
        .save-button-holder {
            margin-bottom: 1em;
            clear: right;
        }
        .tab-pane {
            min-height: 600px;
        }
    </style>
{% endblock %}
{% block form-view %}
    <h3 class="app-manager-title variable-app_name">{{ app.name|html_name }}</h3>
    <ul class="nav nav-tabs">
        <li class="active">
            <a href="#app-settings" data-toggle="tab">
                {% if app.get_doc_type == "Application" %}
                    {% trans "Application Settings" %}
                {% else %}
                    {% trans "Remote Setup" %}
                {% endif %}
            </a>
        </li>

        <li><a href="#languages-and-translations" data-toggle="tab">{% trans "Languages" %}</a></li>

        {% if app.get_doc_type == 'Application' %}
        <li><a href="#multimedia" data-toggle="tab">{% trans "Multimedia" %}</a></li>
        <li><a href="{% url app_summary domain app.id %}">{% trans "Application Summary" %}</a></li>
        {% endif %}
    </ul>
    <div class="tab-content">
        <div class="tab-pane active" id="app-settings">
            {% include "app_manager/partials/app-settings.html" %}
            <h2>CommCare Properties</h2>
            <div class="tab-pane" id="commcare-settings">
                <div class="save-button-holder clearfix"></div>
                <form class="form-horizontal">
                    <fieldset id="log-properties">
                        <legend>{% trans "Logging" %}</legend>
                    </fieldset>

                    <fieldset id="commcare-sense-properties">
                        <legend>{% trans "CommCare UI Settings" %}</legend>
                    </fieldset>

                    <fieldset id="other-commcare-settings">
                        <legend>{% trans "CommCare Properties" %}</legend>
                    </fieldset>
                </form>
            </div>

            <div>
                <form method="get" action='{% url import_app domain %}' style="font-size: .8em; text-align: right;">
                    <input type="hidden" name="app" value="{{ app.id }}"/>
                    Copy this app to project: <input type="text" name="domain" />
                    <input type="submit" value="Copy" />
                </form>
            </div>
        </div>
        <div id="languages-and-translations" class="tab-pane">
            <div id="supported-languages">
                <h2>Supported Languages</h2>
                {% include "app_manager/partials/supported-languages.html" %}
            </div>
            {% if app.get_doc_type == "Application" %}
            <div id="translations_ui">
                <h2>CommCare Translations</h2>
                <p>
                    For J2ME (Nokia) refer to
                    <a target="_blank" href="https://bitbucket.org/commcare/javarosa/src/default/j2me/shared-resources/resources/messages_default.txt">JavaRosa translations</a>
                    and <a target="_blank" href="https://bitbucket.org/commcare/commcare/src/default/application/resources/messages_cc_default.txt">CommCare translations</a>.
                </p>
                <p>
                    For CommCareODK (Android) refer to
                    <a target="_blank" href="https://bitbucket.org/commcare/commcare-odk/src/default/app/assets/locales/messages_ccodk_default.txt">CommCareODK translations</a>
                    and <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/CommCare+ODK+Form+Entry+Interface+Strings">ODK Collect translations</a>.
                </p>
                <br/>
            </div>
            {% endif %}
        </div>

        {% if app.get_doc_type == "Application" %}

            <div class="tab-pane multimedia" id="multimedia">
                {% if multimedia %}
                    {% if edit %}
                        <h3 style="text-align: left;">{% trans 'Manage Multimedia' %}</h3>
                        <p>{% blocktrans %}View, upload, and download your application's multimedia{% endblocktrans %}</p>
                        <p><a target="_blank" class="btn btn-primary" style="color: #ffffff; text-decoration: none;" href="{% url hqmedia_references domain app.get_id %}"><i class="icon icon-check"></i>
                            {% blocktrans %}Multimedia Reference Checker</a> (opens in a new window){% endblocktrans %}</p>
                    {% endif %}
                    <h3 style="margin-top: 1em; text-align: left;">{% trans 'Download Multimedia Zip' %}</h3>
                    {% include "hqmedia/partials/multimedia_zip_notice.html" %}
                {% else %}
                    {% blocktrans %}No Multimedia{% endblocktrans %}
                {% endif %}
            </div>

        {% endif %}
    </div>
{% endblock %}
