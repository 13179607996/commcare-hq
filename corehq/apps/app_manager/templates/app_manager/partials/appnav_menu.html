{% load i18n %}
{% load xforms_extras %}
{% load hq_shared_tags %}

<ul class="nav nav-hq-sidebar sortable appmanager-main-menu">
    <li class="sort-action">
        <form method="post"
              action="{% url "corehq.apps.app_manager.views.rearrange" domain app.id 'modules' %}">
              {% csrf_token %}
        </form>
    </li>
    {% with module as selected_module %}
        {% for module in app.get_modules %}
            <li class="edit-module-li {% ifequal module.id selected_module.id %}{% if not form %}
                active{% endif %}{% endifequal %}"
                data-index="{{ module.id }}">

                <a href="{% url "view_module" domain app.id module.id %}">
                    <i class="drag_handle"></i>
                    {% if module.module_type == 'advanced' %}<i class="fa fa-flask appmanager-icon-type"></i>
                    {% elif module.module_type == 'report' %}<i class="fa fa-bar-chart appmanager-icon-type"></i>
                    {% elif module.module_type == 'shadow' %}<i class="fa fa-folder-open-o appmanager-icon-type"></i>
                    {% else %}<i class="fa fa-folder-open"></i>{% endif %}
                    <span {% if module.id == selected_module.id %}class="variable-module_name"{% endif %}>
                        {{ module.name|html_trans:langs }}
                    </span>
                </a>

                <ul class="nav nav-hq-sidebar {% ifequal module.id selected_module.id %}selected{% endifequal %} sortable-forms sortable">
                    <li class="sort-action">
                        <form method="post"
                              action="{% url "corehq.apps.app_manager.views.rearrange" domain app.id 'forms' %}">
                              {% csrf_token %}
                        </form>
                    </li>
                    {% with nav_form as selected_form %}
                        {% for form in module.get_forms %}
                            <li class="edit-form-li{% ifequal form selected_form %} active{% endifequal %}" data-moduleid="{{ module.id }}" data-index="{{ form.id }}">
                                <!--[F]-->

                                <a id="view_form_{{ module.id }}_{{ form.id }}_sidebar"
                                        href="{% url "view_form" domain app.id module.id form.id %}"
                                >
                                    {% if form.get_action_type != 'open' %}
                                      <i class="drag_handle"></i>
                                    {% endif %}
                                    {% if request|toggle_enabled:"SUPPORT" %}
                                    <i
                                    {% if form.get_action_type == 'open' %}
                                        class="fcc fcc-app-createform appmanager-icon-type"
                                    {% elif form.get_action_type == 'close' %}
                                        class="fcc fcc-app-completeform appmanager-icon-type"
                                    {% elif form.get_action_type == 'update' %}
                                        class="fcc fcc-app-updateform appmanager-icon-type"
                                    {% else %}
                                        class="fa fa-file-o"
                                    {% endif %}
                                        title="{{ form.get_icon_help_text }}"
                                        data-toggle="tooltip"
                                        data-placement="top"
                                        >
                                    </i>
                                    {% endif %}
                                    <span {% if form == selected_form %}class="variable-form_name"{% endif %}>
                                    {{ form.name|html_trans:langs }}
                                    </span>
                                </a>
                                {% if not form.no_vellum %}
                                    <div class="edit-form-pencil">
                                        <a id="edit_pen_{{ module.id }}_{{ form.id }}" href="{% url "form_source" domain app.id module.id form.id %}">
                                            <i class="fa fa-pencil"></i>
                                        </a>
                                    </div>
                                {% endif %}
                            </li>
                        {% endfor %}
                    {% endwith %}
                    <li class="sort-disabled">
                        <form action="{% url "corehq.apps.app_manager.views.new_form" domain app.id module.id %}"
                              method="post" class="hide">{% csrf_token %}
                        </form>
                        {% if module.doc_type != 'CareplanModule' and module.doc_type != 'ReportModule' and module.doc_type != 'ShadowModule' %}

                            <a class="submit_on_click" href="#">
                            <i class="fa fa-plus icon-blue"></i>
                            <span class="text-muted">
                                {% trans "Form" %}
                            </span>
                        </a>
                        {% endif %}
                    </li>
                </ul>
            </li>
        {% endfor %}
    {% endwith %}
    {% if app.get_doc_type == "Application" %}
        <form id="new-module-form" action="{% url "corehq.apps.app_manager.views.new_module" domain app.id %}"
                  method="post" class="hide">{% csrf_token %}
            <input id="new-module-type" type="hidden" name="module_type" />
        </form>
        {% if show_care_plan or show_advanced or show_report_modules or show_shadow_modules %}
            <li class="sort-disabled dropdown">
                <a href="#" data-toggle="dropdown">
                    <i class="new-module-icon fa fa-plus icon-blue"></i>
                    <span class="text-muted">
                        {% trans "Module" %}
                    </span><span class="caret"></span>
                </a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="#" class="new-module" data-type="case">{% trans "New Case Module" %}</a></li>
                    {% if show_care_plan %}
                    <li><a data-toggle="modal" href="#careplan-module-modal">{% trans "New Care Plan Module" %}</a></li>
                    {% endif %}
                    {% if show_advanced %}
                    <li>
                        <a href="#" class="new-module" data-type="advanced">
                            {% trans "New Advanced Module" %}
                        </a>
                    </li>
                    {% endif %}
                    {% if show_report_modules %}
                    <li>
                        <a href="#" class="new-module" data-type="report">
                            {% trans "New Report Module" %}
                        </a>
                    </li>
                    {% endif %}
                    {% if show_shadow_modules %}
                    <li>
                        <a href="#" class="new-module" data-type="shadow">
                            {% trans "New Shadow Module" %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </li>
            {% include "app_manager/partials/new_careplan_module.html" %}
        {% else %}
        <li class="sort-disabled">
            <a href="#" class="new-module" data-type="case">
                <i class="new-module-icon fa fa-plus icon-blue"></i>
                <span class="text-muted">{% trans "Module" %}</span>
            </a>
        </li>
        {% endif %}
    {% endif %}
</ul>
