{% load i18n %}
{% load hq_shared_tags %}

<div>
    <table class="table table-condensed detail-screen-table">
        <thead>
            <tr tabindex="999" data-bind="paste: function (data) { pasteCallback(data, 0); }">
                <th class="detail-screen-icon"></th>
                <th class="detail-screen-field" data-bind="
                    text: {% block field_column_header %}DetailScreenConfig.message.FIELD{% endblock %}
                "></th>
                <th class="detail-screen-header" data-bind="
                    text: {% block display_text_column_header %}DetailScreenConfig.message.HEADER{% endblock %}
                "></th>
                <th class="detail-screen-format" data-bind="
                    text: {% block format_column_header %}DetailScreenConfig.message.FORMAT{% endblock %}
                "></th>
                <th class="detail-screen-icon"></th>
            </tr>
        </thead>
        <tbody class="detail-screen-columns" data-bind="sortable: {
            data: columns,
            afterAdd: function (elem) { $(elem).hide().fadeIn() },
            beforeRemove: function (elem) { $(elem).fadeOut() }
        }">
            <tr data-bind="
                css: {info: $data.isTab},
                attr: {'data-order': _sortableOrder, 'tabindex': 1000 + $index()},
                copy: function () { return copyCallback(); },
                paste: function (data) { $parent.pasteCallback(data, $index() + 1); }
            ">
                <td class="detail-screen-icon" data-bind="visible: $root.edit">
                    <span class="sort-disabled" data-bind="ifnot: grip"></span>
                    <i class="grip sortable-handle" data-bind="
                        if: grip,
                        css: COMMCAREHQ.icons.GRIP,
                        style: {cursor: 'move'},
                        event: {mousedown: function(){ $(':focus').blur(); }}
                    "></i>
                </td>

                {% block field_cell %}
                <!--ko if: !$data.isTab -->
                    <td class="detail-screen-field control-group"
                        data-bind="css: {error: showWarning}">
                        <div data-bind="html: CC_DETAIL_SCREEN.getFieldHtml(field.val()), visible: !field.edit"></div>
                        <div data-bind="jqueryElement: field.ui, visible: field.edit"></div>
                        <div data-bind="visible: showWarning">
                            <span class="help-inline" data-bind="
                                text: DetailScreenConfig.field_format_warning_message
                            ">
                            <span/>
                        </div>
                    </td>
                <!--/ko-->
                {% endblock %}

                {% block display_text_cell %}
                <!--ko if: !$data.isTab -->
                    <td class="detail-screen-header" data-bind="jqueryElement: header.ui"></td>
                <!--/ko-->
                <!--ko if: $data.isTab -->
                    <td colspan="3" data-bind="jqueryElement: header.ui"></td>
                <!--/ko-->
                {% endblock %}

                {% block format_cell %}
                <!--ko if: !$data.isTab -->
                    <td class="detail-screen-format" data-bind="jqueryElement: $format"></td>
                <!--/ko-->
                {% endblock %}

                {% block delete_icon_cell %}
                <td class="detail-screen-icon">
                    <i style="cursor: pointer;"
                       data-bind="
                        visible: $root.edit && ($parent.columns().length > 1),
                        click: function(){screen.columns.remove($data);},
                        css: COMMCAREHQ.icons.DELETE,
                        attr: {title: DetailScreenConfig.message.DELETE_COLUMN}
                    "></i>
                </td>
                {% endblock %}
            </tr>
        </tbody>
        <tbody>
            <tr>
                <td></td>
                <td colspan="4">
                    {% block add_property_button %}
                    <div class="btn-group">
                        <button class="btn add-property-item" data-bind="click: addProperty">Add Property</button>
                        {% if request|feature_preview_enabled:'CALC_XPATHS' or request|toggle_enabled:'GRAPH_CREATION' %}
                        <button class="btn dropdown-toggle" data-toggle="dropdown">
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li data-bind="click: addProperty"><a>Property</a></li>
                            {% if request|feature_preview_enabled:'CALC_XPATHS' %}
                            <li data-bind="click: addCalculation"><a>Calculation</a></li>
                            {% endif %}
                            {% if request|toggle_enabled:'GRAPH_CREATION' %}
                            <!-- ko if: COMMCAREHQ.app_manager.checkCommcareVersion("2.17") -->
                            <li data-bind="click: addGraph"><a>Graph</a></li>
                            <!-- /ko -->
                            <!-- ko ifnot: COMMCAREHQ.app_manager.checkCommcareVersion("2.17") -->
                            <li class="disabled"><a>Graph <small>(upgrade to 2.17 or greater)</small></a></li>
                            <!-- /ko -->
                            {% endif %}
                        </ul>
                        {% endif %}
                    </div>
                    {% endblock %}
                </td>
            </tr>
        </tbody>
    </table>
</div>
