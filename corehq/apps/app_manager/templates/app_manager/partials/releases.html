{% load i18n %}
<table class="table">
    <tr>
        <th colspan="2">Version</th>
        <th colspan="2">Build Date &amp; Time</th>
        <th>CommCare Binary</th>
        <th></th>
        <th data-bind="visible: edit"></th>
        <th>Comment</th>
        <th>Released</th>

    </tr>
    <tbody data-bind="foreach: savedApps, css: {hidden: false}" class="hidden">
        <tr class="build" data-bind="css: {
            'build-released': is_released(),
            'build-unreleased': !is_released(),
            'build-latest-release': id() === $root.latestReleaseId()
        }">
            <td data-bind="if: edit">
                <a href="#" data-bind="
                    openModal: 'delete-build-modal-template',
                    visible: !_deleteState()
                ">
                    <span class="icon icon-remove"></span>
                </a>
                <div class="pending" data-bind="
                    visible: _deleteState() == 'pending'
                "></div>

                <div class="icon icon-exclamation-sign" data-bind="
                    visible: _deleteState() == 'error'
                "></div>
            </td>
            <td class="nowrap" data-bind="text: version"></td>
            <td class="nowrap" data-bind="text: built_on_date"></td>
            <td class="nowrap" data-bind="text: built_on_time"></td>
            <td class="nowrap">
                <span data-bind="if: build_label(), text: build_label()"></span>
                <p data-bind="text: jar_path"></p>
                <h6 data-bind="if: built_with.signed">{% trans "Unsigned Jar" %}</h6>
            </td>
            <td class="nowrap">
                <div class="btn-group">
                    <a class="btn btn-primary" data-bind="openModal: 'deploy-build-modal-template'">Deploy</a>
                </div>
            </td>
            <td data-bind="if: edit">
{#                {% if saved_app.version != app.version %}#}
{#                    <button class="btn dialog_opener">Revert</button>#}
{#                    <form class="dialog" action="{% url corehq.apps.app_manager.views.revert_to_copy domain app.id %}" method="post"#}
{#                          title="Revert to Build">#}
{#                        <p>Are you sure you want to revert to build {{ saved_app.version }}?</p>#}
{#                        <input type="hidden" name="saved_app" value="{{ saved_app.id }}" />#}
{#                        <button class="btn btn-primary" data-dismiss="modal" type="submit">Revert</button>#}
{#                    </form>#}
{#                {% endif %}#}
            </td>
            <td>
                <b data-bind="visible: comment_user_name, text: comment_user_name"></b>
                <span data-bind="text: build_comment"></span>
                <h6 data-bind="visible: !build_comment()">{% trans "(No Comment)" %}</h6>
            </td>
            <td class="build-is-released">
                <div data-bind="starred: is_released, click: $root.toggleRelease"></div>
            </td>
        </tr>
    </tbody>
</table>
<div data-bind="visible: !doneFetching(), css: {hidden: false}" class="hidden">
    <a href="#" class="btn" data-bind="click: getMoreSavedApps">{% trans "View More" %}</a>
</div>
<script type="text/html" id="delete-build-modal-template">
    <div class="modal-header">
        <a href="#" class="close" data-dismiss="modal">×</a>
        <h3>Delete Build?</h3>
    </div>
    <div class="modal-body">
        <p>Are you sure you want to delete this build (version <span data-bind="text: version"></span>)?</p>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Cancel</a>
        <a class="btn btn-danger" href="#" data-bind="click: $root.deleteSavedApp" data-dismiss="modal">Delete Build</a>
    </div>
</script>
<script type="text/html" id="deploy-build-modal-template">
    <div class="modal-header">
        <a href="#" class="close" data-dismiss="modal">×</a>
        <h3>Deploying version <span data-bind="text: version"></span></h3>
    </div>
    <div class="modal-body">
        <div data-bind="visible: case_sharing && $root.users_cannot_share.length">
            <p>
                <span class="label label-important">Warning!</span>
                The following users cannot use this case sharing app because they have either more or less than one group.
                To fix this, please <a href="{% url commcare_users domain %}?cannot_share=true">edit their group settings</a>
                so that they all belong to exactly one group.
            </p>
            <ul data-bind="foreach: $root.users_cannot_share">
                <li data-bind="text: raw_username"></li>
            </ul>
            <p>
                <a href="{% url commcare_users domain %}?cannot_share=true" class="btn">Edit mobile users</a>
                <a href="#{{ saved_app.id }}_accordion" class="btn showAccordionButton">Deploy anyway</a>
            </p>
        </div>
        <div class="accordion{% if saved_app.case_sharing and users_cannot_share|length > 0 %} hide {% endif %}" id="{{ saved_app.id }}_accordion">
            <div class="accordion-group">
                <div class="accordion-heading">
                    {% if saved_app.cloudcare_enabled %}
                        <a class="accordion-toggle" data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_preview">
                            {% trans 'Preview' %}
                        </a>
                    {% else %}
                        <a class="accordion-toggle" data-bind="attr: {href: $root.url('emulator', id)}">
                            {% trans 'Preview in emulator' %}
                        </a>
                    {% endif %}
                </div>
                <div id="{{ saved_app.id }}_preview" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <p>
                            Preview in <a data-bind="attr: {href: $root.url('emulator', id)}">the emulator</a>
                            or in
                            <a data-bind="attr: {href: $root.url('cloudcare', id)}">CloudCare</a>
                        </p>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_j2me">
                        Download to J2ME
                    </a>
                </div>
                <div id="{{ saved_app.id }}_j2me" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <ol>
                            <li>
                                Download <strong>both</strong> of the following files:
                                <p><a data-bind="attr: {href: $root.url('jad', id)}">Download CommCare.jad</a></p>
                                <p><a data-bind="attr: {href: $root.url('jar', id)}">Download CommCare.jar</a></p>
                            </li>
                            <li>
                                For help on how to install, see our <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Set+Up+Mobile+Phone">Set Up Mobile Phone</a>.
                            </li>
                            <li>
                                If you have any issues with the installation, please refer to
                                <a target="_blank" href="https://confluence.dimagi.com/display/commcarepublic/Troubleshooting+Phone+Problems">Troubleshooting Phone Problems</a>.
                            </li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-bind="openJqm: $root.url('odk', id)">
                        Download to CommCare ODK (Android)
                    </a>
                </div>
            </div>

            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#{{ saved_app.id }}_accordion" href="#{{ saved_app.id }}_sms">
                        Send to phone via SMS
                    </a>
                </div>

                <div id="{{ saved_app.id }}_sms" class="accordion-body collapse">
                    <div class="accordion-inner">
                        <div class="tab-pane" id="pills-basic">
                            <div class="tabbable">
                                <ul class="nav nav-pills">
                                    <li class="active">
                                        <a href="#{{ saved_app.id }}_sms_j2me" data-toggle="tab">Send J2ME app</a>
                                    </li>
                                    <li>
                                        <a href="#{{ saved_app.id }}_sms_odk" data-toggle="tab">Send CommCare ODK app (Android)</a>
                                    </li>
                                </ul>
                                <div class="tab-content">
                                    <div id="{{ saved_app.id }}_sms_j2me" class="tab-pane active" data-bind="
                                        attr: {id: id() + '_sms_j2me'}
                                    ">
                                        <div data-bind="visible: short_url">
                                            <form method="post" action="{% url corehq.apps.sms.views.send_to_recipients domain %}">
                                                <label>Send to: </label>
                                                <input type="text" name="recipients" class="sms-autocomplete" value=""/>
                                                <br />
                                                <textarea name="message">Update to CommCare: <!--ko
                                                    text: short_url--><!--/ko
                                                    --> ("{{ app.short_name }}" v.{{ saved_app.version }})</textarea>
                                                <br />
                                                <input type="submit" class="btn" value="Send"/>
                                            </form>
                                        </div><div data-bind="visible: !short_url()">
                                            <span class="label label-important">
                                              No URL was found for this app, try rebuilding.
                                            </span>
                                        </div>
                                    </div>

                                    <div id="{{ saved_app.id }}_sms_odk" class="tab-pane">
                                        {% if saved_app.short_odk_url %}
                                            <form method="post" action="{% url corehq.apps.sms.views.send_to_recipients domain %}">
                                                <label>Send to: </label>
                                                <input type="text" name="recipients" class="sms-autocomplete" value="{{ app.recipients }}"/>
                                                <br />
                                                <textarea name="message">Update to CommCare: {{ saved_app.short_odk_url }} ("{{ app.short_name }}" v.{{ saved_app.version }})</textarea>
                                                <br />
                                                <input type="submit" class="btn" value="Send"/>
                                            </form>
                                        {% else %}
                                            <span class="label label-important">
                                              No URL was found for this app, try rebuilding.
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% ifchanged %}
                {% if multimedia %}
                    <div class="accordion-group">
                        <div class="accordion-heading">
                            <a class="accordion-toggle" href="{% if multimedia.notice %}#{{ saved_app.id }}_multimedia{% else %}{% url download_multimedia_zip domain app.id %}{% endif %}" {% if multimedia.notice %}data-toggle="collapse" data-target="#{{ saved_app.id }}_multimedia"{% endif %}>Download Multimedia Zip</a>
                        </div>
                        <div class="accordion-body collapse" id="{{ saved_app.id }}_multimedia">
                            <div class="accordion-inner">
                                {% if multimedia.missing_image_refs > 0 or multimedia.missing_audio_refs > 0 %}
                                    <p>
                                        Your multimedia zip is missing {{ multimedia.missing_image_refs }} image reference{{ multimedia.missing_image_refs|pluralize }} and
                                        {{ multimedia.missing_audio_refs }} audio reference{{ multimedia.missing_audio_refs|pluralize }}. Your app will likely crash unless this
                                        is resolved.
                                    </p>
                                {% endif %}
                                {% if multimedia.errors %}
                                    <p>
                                        Your application contains errors, therefore, your multimedia could not properly be assembled. Please fix your errors and any missing
                                        multimedia references that are found afterward before using this file.
                                    </p>
                                {% endif %}
                                <a class="btn btn-warning" href="{% url download_multimedia_zip domain app.id %}">Download Anyway</a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            {% endifchanged %}

            {% if request.user.is_superuser %}
                <div class="accordion-group">
                    <div class="accordion-heading">
                        <a class="accordion-toggle" data-bind="attr: {href: $root.url('source', id)}">View Source Files</a>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
    <div class="modal-footer">
        <a href="#" class="btn" data-dismiss="modal">Close</a>
    </div>
</script>