{% extends 'app_manager/v2/managed_app.html'%}
{% load xforms_extras %}
{% load hq_shared_tags %}
{% load i18n %}

{% block head %}{{ block.super }}
    {% if include_fullstory %}
        {% include 'analytics/fullstory.html' %}
    {% endif %}
    {% if not vellum_debug %}
        <link href="{% static "app_manager/js/vellum/style.css" %}" type="text/css" rel="stylesheet"/>
    {% elif vellum_debug == "dev-min" %}
        <link href="{% static 'formdesigner/_build/style.css' %}" type="text/css" rel="stylesheet"/>
    {% endif %}
{% endblock %}

{% block stylesheets %}{{ block.super }}
  <style type="text/css">
    .hq-container {
      padding-bottom: 0;
      margin-bottom: 0;
    }
  </style>
{% endblock %}

{% block js %}{{ block.super }}
    <script src="{% static 'moment/moment.js' %}"></script>
    <script src="{% static 'requirejs/require.js' %}"></script>
    <script src="{% static 'app_manager/js/app-notifications.js' %}"></script>
    <script src="{% static 'js/ws4redis.js' %}"></script>
    <script src="{% static 'app_manager/js/edit_form_details.js' %}"></script>
    <script src="{% static 'app_manager/js/form_designer.js' %}"></script>
{% endblock %}

{% block js-inline %}{{ block.super }}
    {% if request.guided_tour %}{% include request.guided_tour.template %}{% endif %}
    <script>
        var initial_page_data = hqImport("hqwebapp/js/initial_page_data.js").get;
        var VELLUM_OPTIONS = _.extend(initial_page_data("vellum_options"), {
            core: {
                defaultHelpTextTemplateId:
                  {% if form.get_action_type == 'open' %}
                      '#fd-hq-helptext-registration'
                  {% elif form.get_action_type == 'close' %}
                      '#fd-hq-helptext-close'
                  {% elif form.get_action_type == 'update' %}
                      '#fd-hq-helptext-followup'
                  {% else %}
                      '#fd-hq-helptext-survey'
                  {% endif %},
                dataSourcesEndpoint: '{% url "get_form_data_schema" domain=domain form_unique_id=form.get_unique_id %}',
                dataSources: [
                    {% comment %} DEPRECATED. Use dataSourcesEndpoint {% endcomment %}
                    {
                        key: 'fixture',
                        name: 'Fixtures',
                        endpoint: '{% url 'fixture_metadata' domain=domain %}'
                    }
                ],
                form: {{ form.source|JSON }},
                formId: '{{ form.get_unique_id }}',
                formIconClass:
                  {% if form.get_action_type == 'open' %}
                      "fcc fcc-app-createform"
                  {% elif form.get_action_type == 'close' %}
                      "fcc fcc-app-completeform"
                  {% elif form.get_action_type == 'update' %}
                      "fcc fcc-app-updateform"
                  {% else %}
                      "fa fa-file-o"
                  {% endif %},
                formName: "{{ form.name|trans:app.langs|escapejs }}",
                saveType: 'patch',
                saveUrl: '{% url "edit_form_attr" domain app.id form.get_unique_id "xform" %}',
                patchUrl: '{% url "patch_xform" domain app.id form.get_unique_id %}',
                allowedDataNodeReferences: [
                    "meta/deviceID",
                    "meta/instanceID",
                    "meta/username",
                    "meta/userID",
                    "meta/timeStart",
                    "meta/timeEnd",
                    "meta/location"
                ].concat({{ scheduler_data_nodes|JSON }}),
                activityUrl: '{% url "ping" %}',
                sessionid: {{ sessionid|JSON }},
                externalLinks: {
                    changeSubscription: '{% url "domain_subscription_view" domain=domain %}'
                },
                invalidCaseProperties: ['name'],
            },
            itemset: {
                dataSourcesFilter: function (sources) {
                    return _.filter(sources, function (source) {
                        return !source.uri || /^jr:\/\/fixture\//.test(source.uri);
                    });
                }
            },
            windowManager: {
                leftOffset: function () {
                    return $('#hq-sidebar').outerWidth() + 2;
                },
                topOffset: function () {
                    return $('#hq-navigation').outerHeight();
                },
                toggleFullScreenCallback: function (isFullscreen) {
                  var $preview = $('#js-appmanager-preview');
                  if (isFullscreen) {
                    $preview.addClass('fullscreen');
                  } else {
                    $preview.removeClass('fullscreen');
                  }
                }
            },
            csrftoken: $.cookie('csrftoken')
        });

        // core has already been provided by the server
        VELLUM_OPTIONS.core = _.extend(VELLUM_OPTIONS.core, {
            formLoadingCallback: function() {
                $('#formdesigner').addClass('loading');
            },
            formLoadedCallback: function() {
                $('#formdesigner').removeClass('loading');
                $('#formdesigner .fd-content-left .fd-head-text').after(
                    $('#fd-hq-edit-formname-button').html()
                );
            },
            onFormSave: function(data) {
                var app_manager = hqImport('app_manager/js/app_manager.js')
                app_manager.updateDOM(data.update);
                $('.js-preview-toggle').removeAttr('disabled');
                if (initial_page_data("days_since_created")) {
                    analytics.workflow('Saved the Form Builder within first 24 hours');
                }
            },
            onReady: function() {
                if (initial_page_data('vellum_debug') === 'dev') {
                    var less_error_id = "#less-error-message\\:static-style-less-hqstyle-core",
                        less_error = $(less_error_id);
                    if (less_error.length) {
                        console.log("hiding less error:", less_error_id);
                        console.log(less_error.text());
                        less_error.hide();
                    }
                }
                if (initial_page_data('guided_tour')) {
                    form_tour_start();
                }
                if (initial_page_data('days_since_created') === 0) {
                    $("#formdesigner").vellum("get").data.core.form.on("question-create", function() {
                        analytics.workflow('Added question in Form Builder within first 24 hours');
                    });
                }
            },
        });

        var CKEDITOR_BASEPATH = initial_page_data('CKEDITOR_BASEPATH');

        define("jquery", [], function () { return window.jQuery; });
        define("jquery.bootstrap", ["jquery"], function () {});
        define("underscore", [], function () { return window._; });
        define("moment", [], function () { return window.moment; });

        require.config({
            /* to use non-built files in HQ:
                * clone Vellum into submodules/formdesigner
                * Run make in that directory (requires node.js)
                * set settings.VELLUM_DEBUG to "dev" or "dev-min"
            */
            baseUrl: initial_page_data('requirejs_url'),
            // handle very bad connections
            waitSeconds: 60,
            urlArgs: initial_page_data('requirejs_args'),
            paths: {
                'jquery.vellum': 'main'
            },
        });

        require(["jquery", "jquery.vellum", "moment"], function ($) {
            $(function () {
                $("#edit").hide();
                $('#formdesigner').vellum(VELLUM_OPTIONS);

                var notification_options = initial_page_data("notification_options");
                if (notification_options) {
                    var notifications = hqImport('app_manager/js/app-notifications.js');
                    // initialize redis
                    var ws4redis = WS4Redis({
                        uri: notification_options.WEBSOCKET_URI + notification_options.notify_facility + '?subscribe-broadcast',
                        receive_message: notifications.NotifyFunction(notification_options.user_id, $('#notify-bar')),
                        heartbeat_msg: notification_options.WS4REDIS_HEARTBEAT,
                    });
                }
            });
        });
        analytics.workflow('Entered the Form Builder');
        $(function () {
            var previewApp = hqImport('app_manager/js/preview_app.js');

            if (initial_page_data('form_uses_cases')) {
                // todo make this a more broadly used util, perhaps? actually add buttons to formplayer?
                var _prependTemplateToSelector = function (selector, layout, attempts, callback) {
                    attempts = attempts || 0;
                    if ($(selector).length) {
                        var $toggleParent = $(selector);
                        $toggleParent.prepend(layout);
                        callback();
                    } else if (attempts <= 30) {
                        // give up appending element after waiting 30 seconds to load
                        setTimeout(function () {
                            _prependTemplateToSelector(selector, layout, attempts++, callback);
                        }, 1000);
                    }
                };
                _prependTemplateToSelector(
                    '.fd-form-actions',
                    $('#js-fd-manage-case').html(),
                    0,
                    function () {
                        previewApp.appendToggleTo('.fd-form-actions', $('#js-fd-app-preview-btn-template').html());
                    }
                );
            } else {
                previewApp.appendToggleTo('.fd-form-actions', $('#js-fd-app-preview-btn-template').html());
            }

        });
        $(function () {
            var reverse = hqImport("hqwebapp/js/urllib.js").reverse,
                editDetails = hqImport('app_manager/js/edit_form_details.js');
            editDetails.initName(
                initial_page_data("form_name"),
                reverse("edit_form_attr", "name")
            );
            editDetails.initComment(
                initial_page_data("form_comment"),
                reverse("edit_form_attr", "comment")
            );
            editDetails.setUpdateCallbackFn(function (name, comment) {
                $('#formdesigner .fd-content-left .fd-head-text').text(name);
                $('#edit-form-name-modal').modal('hide');
            });
            $('#edit-form-name-modal').koApplyBindings(editDetails);
        });

    </script>
{% endblock %}

{% block title %}{{ form.name|clean_trans:langs }}{% endblock %}

{% block form-view %}
    {% initial_page_data 'CKEDITOR_BASEPATH' CKEDITOR_BASEPATH|static %}
    {% initial_page_data 'days_since_created' request.couch_user.days_since_created %}
    {% initial_page_data 'guided_tour' request.guided_tour %}
    {% initial_page_data 'form_name' form.name|trans:app.langs %}
    {% initial_page_data 'form_comment' form.comment %}
    {% initial_page_data 'form_uses_cases' form.uses_cases %}
    {% initial_page_data 'notification_options' notification_options %}
    {% initial_page_data 'requirejs_args' requirejs_args %}
    {% initial_page_data 'requirejs_url' requirejs_url|static %}
    {% initial_page_data 'vellum_debug' vellum_debug %}
    {% initial_page_data 'vellum_options' vellum_options %}
    {% registerurl 'edit_form_attr' app.domain app.id form.unique_id '---' %}
    <div id="formdesigner" class="clearfix app-manager-v2 loading"></div>

    {% if can_preview_form %}
    <script type="text/html" id="js-fd-app-preview-btn-template">
        {% include 'app_manager/v2/partials/app_preview_toggle.html' %}
    </script>
    {% endif %}

    <script type="text/html" id="js-fd-manage-case">
      <div class="btn-group pull-right">
        <a class="btn btn-manage" href="{% url "view_form" domain app.id module.id form.id %}">
          <i class="fa fa-cog"></i> {% trans 'Manage Case' %}
        </a>
      </div>
    </script>

    <script type="text/html" id="fd-hq-helptext-registration">
        <h4>{% blocktrans %}This is a <i class="fcc fcc-app-createform"></i> Registration Form.{% endblocktrans %}</h4>
        <p>
          {% blocktrans %}
            Users will fill it out when they need to <strong>add</strong> a new item to the application.
          {% endblocktrans %}
        </p>
    </script>

    <script type="text/html" id="fd-hq-helptext-close">
        close form
    </script>

    <script type="text/html" id="fd-hq-helptext-followup">
        <h4>{% blocktrans %}This is a <i class="fcc fcc-app-updateform"></i> Followup Form.{% endblocktrans %}</h4>
        <p>
          {% blocktrans %}
            Users will fill it out when they need to <strong>update</strong> an item that has already been added to the application.
          {% endblocktrans %}
        </p>
    </script>

    <script type="text/html" id="fd-hq-helptext-survey">
        <h4>{% blocktrans %}This is a <i class="fa fa-file-o"></i> Survey.{% endblocktrans %}</h4>
        <p>
          {% blocktrans %}
          It's useful for asking questions once, for information that you won't need to follow up on later.
          {% endblocktrans %}
        </p>
    </script>

    <script type="text/html" id="fd-hq-edit-formname-button">
      <a href="#edit-form-name-modal" class="link-edit-form" data-toggle="modal">
        <i class="fa fa-pencil"></i>
      </a>
    </script>
{% endblock %}

{% block column_style %}hq-flush-content{% endblock %}

{% block modals %}
  <div class="modal fade" id="edit-form-name-modal">
      <div class="modal-dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal">
                      <span aria-hidden="true">&times;</span>
                  </button>
                  <h4 class="modal-title">{% trans "Edit Form Details" %}</h4>
              </div>
              <form name="update-form-data" class="form-horizontal" data-bind="submit:update">
                  <div class="modal-body">
                      <div class="form-group">
                          <div class="col-sm-3">
                              <label for="update-form-name" class="control-label">
                                  {% trans "Form Name" %}
                              </label>
                          </div>
                          <div class="col-sm-9">
                              <input type="text" data-bind="value: name" class="form-control" />
                          </div>
                      </div>
                      <div class="form-group">
                          <div class="col-sm-3">
                              <label for="update-form-name" class="control-label">
                                  {% trans "Comment" %}
                              </label>
                          </div>
                          <div class="col-sm-9">
                              <textarea rows="5"
                                        data-bind="value: comment"
                                        class="form-control"></textarea>
                          </div>
                      </div>
                  </div>
                  <div class="modal-footer">
                      <a href="#" data-dismiss="modal" class="btn btn-default">{% trans "Cancel" %}</a>
                      <button type="submit" class="btn btn-primary">{% trans "Save" %}</button>
                  </div>
              </form>
          </div>
      </div>
</div>
{% endblock %}

{% block footer %}{% endblock %}
