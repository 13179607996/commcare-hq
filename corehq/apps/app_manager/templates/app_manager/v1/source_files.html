{% extends "style/full_screen.html" %}

{% load hq_shared_tags %}
{% load compress %}

{% block page_content %}
    {% registerurl 'diff' app.domain app.id '---' %}
    {% initial_page_data 'built_versions' built_versions %}
    {% initial_page_data 'current_version' app.built_with.build_number %}

    <p class="form-inline" id="compare-form">
      See
      <a href="{% url "view_app" app.domain app.copy_of|default_if_none:app.get_id %}">
        current app
      </a> for the latest work in progress.

    {% if not other_app %}
        Or compare with another version:
        <input type="text" class="form-control input-sm" placeholder="version" />
        <button class="btn btn-default btn-sm">Compare</button>
    {% endif %}
    </p>

    {% block downloads %}{% endblock %}

    <h2>Resource Files</h2>

    <table class="table table-condensed">
        {% for file in files %}
            <tr>
                <td class="col-sm-3">
                    {% if file.source %}
                        <a class="toggle-next" href="#">{{ file.name }}</a>
                    {% else %}
                        {{ file.name }}
                    {% endif %}
                </td>
                <td class="col-sm-9">
                    {% block file_description %}{% endblock %}
                </td>
            </tr>

            {% if file.source %}
                <tr class="hide">
                    <td colspan="2">
                    {% block file_source %}{% endblock %}
                    </td>
                </tr>
            {% endif %}
        {% empty %}
            <tr><th>No Files</th></tr>
        {% endfor %}
    </table>
    {% block post_files %}{% endblock %}
{% endblock page_content %}

{% block js %}{{ block.super }}
    {% compress js %}
        <script src="{% static 'hqwebapp/js/urllib.js' %}"></script>
        <script src="{% static 'hqwebapp/js/initial_page_data.js' %}"></script>
        <script src="{% static 'Caret.js/dist/jquery.caret.js' %}"></script>
        <script src="{% static 'At.js/dist/js/jquery.atwho.min.js' %}"></script>
    {% endcompress %}
{% endblock %}

{% block stylesheets %}{{ block.super }}
    <link rel="stylesheet" href="{% static 'At.js/dist/css/jquery.atwho.min.css' %}" />
    <style type="text/css">
        /* Limit atwho dropdown width */
        .atwho-view {
            max-width: 300px;
        }
    </style>
{% endblock %}

{% block js-inline %}
<script>
    $(function(){
        $('.toggle-next').click(function(e){
            e.preventDefault();
            $(this).parents('tr').next('tr').toggleClass("hide");
        });

        var current_version = hqImport('hqwebapp/js/initial_page_data.js').get('current_version'),
            built_versions = hqImport('hqwebapp/js/initial_page_data.js').get('built_versions'),
            $form = $("#compare-form"),
            $input = $form.find("input");

        built_versions = _.sortBy(_.filter(built_versions, function(v) {
            return v.version != current_version;
        }), function(v) { return parseInt(v.version); }).reverse();
        version_map = _.indexBy(built_versions, 'version');

        $input.atwho({
            at: "",
            data: _.map(built_versions, function(v) {
                return {
                    id: v.version,
                    name: v.version + (v.comment ? " (" + v.comment + ")" : ""),
                };
            }),
            limit: Infinity,
            maxLen: Infinity,
            suffix: "",
            tabSelectsMatch: false,
            callbacks: {
                beforeInsert: function(value, $li) {
                    value = value.split(/\s+/);
                    return value[0];
                },
                filter: function(query, data, searchKey) {
                    return _.filter(data, function(item) {
                        return item.name.indexOf(query) !== -1;
                    });
                },
                matcher: function(flag, subtext, should_startWithSpace) {
                    return $input.val();
                },
            }
        });

        $form.find("button").click(function() {
            var version = $input.val();
            if (!version) {
                alert("Please enter a version to compare");
                return;
            } else if (!version_map[version]) {
                alert(version + " is not a valid version");
                return;
            }
            window.location = hqImport('hqwebapp/js/urllib.js').reverse('diff', version_map[version].build_id);
        });
    });
</script>
{% endblock js-inline %}
