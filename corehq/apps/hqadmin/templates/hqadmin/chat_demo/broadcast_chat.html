{% extends "hqadmin/chat_demo/chat_base.html" %}

{% block script_panel %}
<script type="text/javascript">
jQuery(document).ready(function($) {
	var ws4redis = WS4Redis({
		uri: '{{ WEBSOCKET_URI }}chat?subscribe-broadcast&publish-broadcast&echo',
		receive_message: receiveMessage,
		heartbeat_msg: {{ WS4REDIS_HEARTBEAT }}
	});
	var billboard = $('#billboard');
    var username = '{{ request.user.username }}' || '[anonymous]';
    // send message though the Websocket to the server

    var sendMessage = function(text) {
        // var formatted = username + ': ' + text;
        var formatted = {
            'username': username,
            'message': text
        };
        ws4redis.send_message(JSON.stringify(formatted));
    };
	$("#text_message").keydown(function(event) {
		if (event.keyCode === 13) {
			event.preventDefault();
            sendMessage($('#text_message').val());
		}
	});

	$('#send_message').click(function() {
        sendMessage($('#text_message').val());
	});

	// receive a message though the Websocket from the server
	function receiveMessage(msg) {
        var msgObj = JSON.parse(msg);
        var renderedMsg = '<strong>' + msgObj.username + '</strong>: ' + msgObj.message;
        billboard.append('<br/>' + renderedMsg);
		billboard.scrollTop(billboard.scrollTop() + 25);
	}
});
</script>
{% endblock %}
