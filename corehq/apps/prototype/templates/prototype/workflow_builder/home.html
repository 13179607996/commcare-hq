{% extends 'prototype/workflow_builder/base.html' %}
{% load compress %}
{% load hq_shared_tags %}

{% block stylesheets %}
  {% if less_debug %}
    <link type="text/less"
          rel="stylesheet"
          media="all"
          href="{% static 'prototype/less/workflow_builder/workflow_builder.debug.less' %}" />
  {% else %}
    {% compress css %}
      <link type="text/less"
            rel="stylesheet"
            media="all"
            href="{% static 'prototype/less/workflow_builder/workflow_builder.main.less' %}" />
    {% endcompress %}
  {% endif %}
{% endblock %}

{% block js %}
  <script src="{% static 'jquery-ui/ui/effect.js' %}"></script>
  <script src="{% static 'jquery-ui/ui/effect-slide.js' %}"></script>
  <script src="{% static 'jquery-ui/ui/effect-fade.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/workflowBindings.ko.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/utils.ko.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/workflows.ko.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/forms.ko.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/preview.ko.js' %}"></script>
  <script src="{% static 'prototype/workflow_builder/js/workflowBuilder.ko.js' %}"></script>
{% endblock %}

{% block js-inline %}
  <script>
    $(function () {
      var workflows = hqImport('prototype.workflow_builder.workflowBuilder');
      var workflowModel = new workflows.AppViewModel();
      workflowModel.init();
      $('#workflow-builder').koApplyBindings(workflowModel);
    });

    $(function () {
      // Resizes Workspace
      var resizeWorkspace = function () {
        var navHeight = $('#navigation').outerHeight();
        var curHeight = $(window).height() - navHeight;
        $('#workspace').height(curHeight);
      };
      resizeWorkspace();
      $(window).resize(resizeWorkspace);
    });

  $(function () {
    $('#add-workflow-a').popover({
      title: "Surveys",
      container: 'body',
      content: function () {
        return $('#help-template-workflow-a').text();
      },
      html: true,
      trigger: 'hover',
      placement: 'bottom'
    });
    $('#add-workflow-b').popover({
      title: "Follow-Up",
      container: 'body',
      content: function () {
        return $('#help-template-workflow-b').text();
      },
      html: true,
      trigger: 'hover',
      placement: 'bottom'
    });
    $('#add-workflow-c').popover({
      title: "Follow-Up and Complete",
      container: 'body',
      content: function () {
        return $('#help-template-workflow-c').text();
      },
      html: true,
      trigger: 'hover',
      placement: 'bottom'
    });

  });
  $(function(){
    var curDown = false,
        curYPos = 0,
        curXPos = 0;
    var $phoneScroll = $('.phone-page-scrollable');
    $phoneScroll.mousemove(function(m){
      if(curDown === true){
       $phoneScroll.scrollTop($phoneScroll.scrollTop() + (curYPos - m.pageY));
       $phoneScroll.scrollLeft($phoneScroll.scrollLeft() + (curXPos - m.pageX));
      }
    });

    $phoneScroll.mousedown(function(m){
      curDown = true;
      curYPos = m.pageY;
      curXPos = m.pageX;
    });

    $phoneScroll.mouseup(function(){
      curDown = false;
    });
  });
  </script>
{% endblock %}

{% block navigation %}
  <div id="navigation">
    <div class="navbar navbar-default navbar-static-top nabvbar-brand">
      <div class="container-fluid">
        <div class="navbar-header">
          <p class="navbar-text">
            AppBuilder
          </p>
        </div>
      </div>
    </div>
    <div class="navbar navbar-default navbar-static-top navbar-app-settings">
      <div class="container-fluid">
        <div class="navbar-header">
          <ul class="nav navbar-nav">
            <li>
              <a href="#modal-app-settings"
                 data-toggle="modal">
                <i class="fa fa-cogs"></i>
              </a>
            </li>
            <li data-bind="click: printForms">
              <p class="navbar-text" data-bind="text:name"></p>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <nav class="navbar navbar-default navbar-static-top navbar-app-toolbar">
      <div class="container-fluid">
        <div class="navbar-header">
          <ul class="nav navbar-nav">
            <li><a href="#" data-bind="click: addWorkflowA" id="add-workflow-a"><i class="wf wf-workflow-a"></i></a></li>
            <li><a href="#" data-bind="click: addWorkflowB" id="add-workflow-b"><i class="wf wf-workflow-b"></i></a></li>
            <li><a href="#" data-bind="click: addWorkflowC" id="add-workflow-c"><i class="wf wf-workflow-c"></i></a></li>
          </ul>
        </div>
      </div>
    </nav>
  </div>
{% endblock %}

{% block modals %}
  {% include 'prototype/workflow_builder/partials/modals.html' %}
{% endblock %}

{% block content %}
  <div id="workspace">
      <div class="workspace-canvas"></div>
      <div data-bind="visible: hasNoWorkflows" class="initial-help">
        <i class="fa fa-hand-o-up"></i> Add a <strong>Workflow</strong> above!
      </div>
      <!-- ko template: { name: 'ko-template-workflow',
                          foreach: workflows } -->
      <!-- /ko -->
      <!-- ko template: { name: 'ko-template-workflow-form',
                          foreach: forms } -->
      <!-- /ko -->

  </div>
  <!-- ko with: appPreview -->
  <div id="preview"
       class="live-preview live-preview-open"
       data-bind="css: {'live-preview-closed': !isShown(), 'live-preview-open': isShown}">
    <div class="live-preview-container">
      <h2>App Preview</h2>
      <div class="phone">
        <div class="phone-screen">
          <div class="phone-appbar">
            <ul class="phone-appbar-nav">
              <li><a href="#" class="phone-app-back" data-bind="css: {'disabled': !isBackVisible()}, click: goBack"><i class="fa fa-chevron-left"></i></a></li>
              <li><h3 class="phone-app-title" data-bind="text: $root.name">My New App</h3></li>
            </ul>
          </div>
          <!-- ko template: { name: screenTemplate,
                              foreach: screens } -->
          <!-- /ko -->
        </div>
      </div>
    </div>


    <a href="#"
       class="live-preview-toggle"
       data-bind="click: toggleShown">
      <i class="fa"
         data-bind="css: {'fa-angle-double-left': !isShown(), 'fa-angle-double-right': isShown}"></i>
    </a>
  </div>
  <!-- /ko -->

  {% include 'prototype/workflow_builder/partials/ko_workflow_templates.html' %}
  {% include 'prototype/workflow_builder/partials/ko_preview_templates.html' %}
  {% include 'prototype/workflow_builder/partials/help_text_templates.html' %}
{% endblock %}
