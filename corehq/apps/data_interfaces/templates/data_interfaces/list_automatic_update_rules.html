{% extends 'hqwebapp/base_paginated_crud.html' %}
{% load i18n %}
{% load hq_shared_tags %}

{% requirejs_main 'data_interfaces/js/list_automatic_update_rules' %}

{% block pagination_header %}
    <div class="row">
        <div class="col-sm-8">
            <p class="lead">
                {% blocktrans %}
                Automatically update and close cases from CommCareHQ
                {% endblocktrans %}
            </p>
            <p>
                {% blocktrans %}
                Create rules for closing cases from CommCareHQ.
                All rules run every day at midnight GMT.
                For more information, see the <a href="{{ help_site_url }}">Help Site</a>.
                {% endblocktrans %}
            </p>
        </div>
    </div>
    <div class="btn-toolbar">
        <a href="{% url "add_case_rule" domain %}">
            <button type="button" class="btn btn-success" id="add-new">
                <i class="fa fa-plus"></i> {% trans "Add Automatic Case Close Rule" %}
            </button>
        </a>
    </div>
{% endblock pagination_header %}

{% block pagination_templates %}
<script type="text/html" id="base-rule-template">
    <td>
        <a data-bind="attr: {href: edit_url}">
            <strong data-bind="text: name"></strong>
        </a>
    </td>
    <td data-bind="text: case_type"></td>
    <td>
        <span class="label label-success" data-bind="visible: active">{% trans "Active" %}</span>
        <span class="label label-danger" data-bind="visible: !active">{% trans "Inactive" %}</span>
    </td>
    <td data-bind="text: last_run"></td>
    <td data-bind="css: {'has-error': action_error}">
        <button type="button" class="btn btn-default" data-action="activate" data-bind="visible: !active">
            {% trans "Activate" %}
        </button>
        <button type="button" class="btn btn-default" data-action="deactivate" data-bind="visible: active">
            {% trans "Deactivate" %}
        </button>
        <p class="help-block" data-bind="visible: action_error">
            <i class="fa fa-exclamation-triangle"></i>
            <span data-bind="text: action_error"></span>
        </p>
    </td>
</script>
{% endblock pagination_templates %}

{% comment %}
{% block page_content %}
{% initial_page_data 'djng_current_rmi' djng_current_rmi %}
<div ng-app="autoUpdateRuleApp" ng-controller="PaginatedListController as paginationController">
    <div class="panel panel-default"
         ng-cloak>
        <div class="panel-heading">
            <h3 class="panel-title">{% trans 'Automatic Case Close Rules' %}</h3>
        </div>
        <div class="panel-body">
            <div class="alert alert-info" ng-hide="paginatedItems.length > 0 || notLoaded || hasError">
                {% blocktrans %}
                    <strong>There are currently no automatic update rules in this project.</strong>
                {% endblocktrans %}
            </div>
            <table class="table table-striped table-responsive"
                   style="margin-bottom: 0;"
                   ng-show="paginatedItems.length > 0">
                <tbody>
                    <tr ng-repeat="rule in paginatedItems">
                        {% angularjs %}
                        <td>
                            <button type="button"
                                    class="btn btn-danger"
                                    data-toggle="modal"
                                    data-target="#delete_{{ rule.id }}">
                                    {% trans "Delete" %}
                            </button>
                            <div id="delete_{{ rule.id }}" class="modal fade">
                                <div class="modal-dialog">
                                    <form class="modal-content"
                                          method="post"
                                          ng-submit="deleteRule(rule, djangoRMI, paginationController);">
                                        {% csrf_token %}
                                        <div class="modal-header">
                                            <button type="button"
                                                    class="close"
                                                    data-dismiss="modal">
                                                <span aria-hidden="true">&times;</span>
                                                <span class="sr-only">{% trans "Close" %}</span>
                                            </button>
                                            <h4 class="modal-title">{% trans "Delete Rule" %}</h4>
                                        </div>
                                        <div class="modal-body">
                                            <p class="lead">
                                                {% blocktrans %}
                                                    Are you sure you want to <strong>delete</strong> this rule?
                                                {% endblocktrans %}
                                            </p>
                                            <p class="lead">
                                                <strong>{{ rule.name }}</strong>
                                            </p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button"
                                                    class="btn btn-default"
                                                    data-dismiss="modal">
                                                {% trans "Cancel" %}
                                            </button>
                                            <button type="submit"
                                                    class="btn btn-default btn-danger">
                                                {% trans "Delete" %}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </td>
                        {% endangularjs %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
{% endcomment %}
