{% extends "reports/async/tabular.html" %}
{% load i18n %}
{% load hq_shared_tags %}

{% block js %}
    {{ block.super }}
    <style>
        @page {
            size: A4 landscape;
        }
        tr {
                page-break-inside: avoid;
            }
        @media print {
            .table th, .table td {
                border-right: 1px solid #dddddd;
            }
        }
    </style>
    <script>
        {% if rendered_as == 'print' and not sf %}
            $(function() {
                var SEPARATOR_DIV = '<div style="page-break-after: always; margin:0; padding:0; border: none;"></div>';

                function breakTable(table, header, rows, splitIndices) {
                    table = table.replaceWith('<div id="_split_table_wrapper"></div>');
                    table.empty();

                    for(var i=0; i<splitIndices.length-1; i++) {
                        var newTable = table.clone();
                        header.clone().appendTo(newTable);
                        $('<tbody />').appendTo(newTable);
                        rows.slice(splitIndices[i], splitIndices[i+1]).appendTo(newTable.children('tbody'));
                        newTable.appendTo("#_split_table_wrapper");
                        if (splitIndices[i+1] !== undefined) {
                            $(SEPARATOR_DIV).appendTo("#_split_table_wrapper");
                        }
                    }
                }
                function splitTable(table, maxHeight) {
                    var header = table.children("thead");
                    if (!header.length)
                        return;

                    var headerHeight = header.outerHeight();
                    var header = header.detach();

                    var splitIndices = [0];
                    var rows = table.children("tbody").children();

                    maxHeight -= headerHeight;
                    var currHeight = 0;
                    rows.each(function(i, row) {
                        currHeight += $(rows[i]).outerHeight();
                        if (currHeight > maxHeight) {
                            splitIndices.push(i);
                            currHeight = $(rows[i]).outerHeight();
                        }
                    });
                    splitIndices.push(undefined);
                    breakTable(table, header, rows, splitIndices);
                }
                splitTable($(".table"), 200);
                $('.hq-loading').hide();
            })
        {% endif %}
    </script>
{% endblock js %}

{% block pretable %}

    <h4 class="media-heading">{{ report.report_title }}
        {% for subtitle in report.report_subtitles %}
        <br/><small>{{ subtitle }}</small>
        {% endfor %}
    </h4>
    {% if sf == "sf2" %}
    <div class="row hq-flush-content">
        <div class="span6">
            <table class="table table-striped">
                <tr>
                    <td><strong>Total number of ASHAs under the Facilitator</strong></td>
                    <td>{{ total_under_facilitator }}</td>
                </tr>
                <tr>
                    <td><strong>Total number of ASHAs for whom the functionality checklist was filled</strong></td>
                    <td>{{ total_with_checklist }}</td>
                </tr>
            </table>
        </div>
    </div>
    {% endif %}
{% endblock pretable %}

{% block js-inline %}
    <script>
        function hideFilters(sf) {
            if (sf === "" || sf === 'sf2') {
                $('#fieldset_datespan').css('display', 'block');
                $('#fieldset_year').css('display', 'none');
                $('#fieldset_month').css('display', 'none');
                $('#report_filter_hierarchy_af').parent().parent().css('display', 'block');
                $('#report_filter_hierarchy_block').parent().parent().css('display', 'block');
            } else if (sf === "sf3") {
                $('#fieldset_datespan').css('display', 'none');
                $('#fieldset_year').css('display', 'block');
                $('#fieldset_month').css('display', 'block');
                $('#report_filter_hierarchy_af').parent().parent().css('display', 'block');
                $('#report_filter_hierarchy_block').parent().parent().css('display', 'block');
            } else if (sf === "sf4") {
                $('#fieldset_datespan').css('display', 'none');
                $('#fieldset_year').css('display', 'block');
                $('#fieldset_month').css('display', 'block');
                $('#report_filter_hierarchy_af').parent().parent().css('display', 'none');
                $('#report_filter_hierarchy_block').parent().parent().css('display', 'block');
            } else if (sf === "sf5") {
                $('#fieldset_datespan').css('display', 'none');
                $('#fieldset_year').css('display', 'block');
                $('#fieldset_month').css('display', 'block');
                $('#report_filter_hierarchy_af').parent().parent().css('display', 'none');
                $('#report_filter_hierarchy_block').parent().parent().css('display', 'none');
            }
        }
        $('#report_filter_sf').on('change', function() {
            sf = $(this).select2('data').id;
            hideFilters(sf);
        });
        $('#hq-report-filters').on('change', function() {
            hideFilters(sf);
        });
        sf = $('#report_filter_sf').select2('data').id;
        hideFilters(sf);
    </script>
{% endblock %}