{% load hq_shared_tags %}
<label for="group_select" class="control-label">{{ group_label }}</label>
<div class="controls">
    <select id="group_select" name="{{ slugs.group }}" data-bind="options: groups, optionsValue: 'item_id', optionsText: 'name', optionsCaption: '{{ group_caption }}', value: selected_group, event: {change: updateGroup}"></select>
</div>
</div>
<div class="control-group" data-bind="visible: enable_user">
    <label for="user_select" class="control-label">{{ user_label }}</label>
    <div class="controls">
        <select id="user_select" name="{{ slugs.user }}" data-bind="options: users, optionsValue: 'item_id', optionsText: 'name', optionsCaption: '{{ user_caption }}', value: selected_user, enable: enable_user"></select>
    </div>
</div>

<script type="text/javascript" src="{% static 'hsph/ko/hsph.field.sites.js' %}"></script>
<script type="text/javascript">
    $(function () {
        var groupMap = {{ groups|JSON }},
            currentSelection = {{ selected|JSON }};

        var GroupUserPicker = function (refs, currentSelection) {
            var self = this;
            self.groupMap = refs;
            var groups = [];
            for (var grp in self.groupMap)
                groups.push(new Item(grp, self.groupMap[grp].name));

            self.groups = ko.observableArray(groups);
            self.selected_group = ko.observable(currentSelection.group || "");

            self.users= ko.observableArray();
            self.selected_user = ko.observable(currentSelection.user || "");
            self.enable_user = ko.observable(false);

            self.updateGroup = function () {
                var users = [];
                self.enable_user(!!self.selected_group());
                if (self.enable_user()) {
                    var availableUsers = self.groupMap[self.selected_group()].users;
                    for (var user in availableUsers) {
                        users.push(new Item(user, availableUsers[user].name));
                    }
                }
                self.users(users);
            };

            self.updateGroup();
        };

        var Item = function (id, name) {
            this.item_id = id;
            this.name = name;
        };

        ko.applyBindings(new GroupUserPicker(groupMap, currentSelection), $("#fieldset_{{ slug }}")[0] );
    });
</script>
